<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Evaluador de juntas · LR Ships</title>
<link rel="stylesheet" href="assets/css/app.css">
<style>
  :root {
    --ink: #eef2f8;
    --mut: rgba(203, 213, 225, 0.78);
    --card: linear-gradient(160deg, rgba(27, 40, 66, 0.95), rgba(12, 19, 34, 0.88));
    --border: rgba(148, 163, 184, 0.34);
    --ok: #34d399;
    --warn: #fbbf24;
    --bad: #f87171;
    --group: rgba(22, 34, 54, 0.72);
  }
  body {
    margin: 0;
    min-height: 100vh;
    background: radial-gradient(circle at top, #1b2d4f 0%, #0f1c33 55%, #040915 100%);
    color: var(--ink);
    font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
  }
  body.modal-open {
    overflow: hidden;
  }
  .wrap {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 32px 60px;
    background: linear-gradient(160deg, rgba(19, 31, 52, 0.94), rgba(8, 15, 30, 0.88));
    border-radius: 34px;
    border: 1px solid rgba(148, 163, 184, 0.32);
    box-shadow: 0 40px 110px rgba(3, 9, 22, 0.6);
    backdrop-filter: blur(24px);
  }
  .page-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    margin: 12px 0 24px;
  }
  .back-link {
    color: var(--mut);
    text-decoration: none;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .back-link:hover {
    color: #bae6fd;
  }
  .page-header .logo-wrapper {
    margin-left: auto;
    display: flex;
    align-items: center;
    justify-content: flex-end;
  }
  .page-header .brand-logo {
    width: 120px;
    height: auto;
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(2, 6, 23, 0.55);
  }
  .h1 {
    font-size: clamp(24px, 3vw, 34px);
    font-weight: 700;
    margin: 0 0 24px;
  }
  .card {
    background: var(--card);
    color: var(--ink);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 24px 26px;
    box-shadow: 0 28px 70px rgba(4, 11, 28, 0.55);
    backdrop-filter: blur(18px);
  }
  .mb-2 { margin-bottom: 8px; }
  .mb-3 { margin-bottom: 12px; }
  .mb-4 { margin-bottom: 16px; }
  .mt-1 { margin-top: 4px; }
  .mt-2 { margin-top: 8px; }
  .mt-3 { margin-top: 12px; }
  .mt-4 { margin-top: 16px; }
  .controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 14px;
  }
  .context-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 14px;
    margin-top: 18px;
  }
  .context-field {
    display: grid;
    gap: 10px;
    padding: 16px 18px;
    border-radius: 18px;
    border: 1px solid rgba(148, 163, 184, 0.28);
    background: rgba(23, 35, 57, 0.55);
    box-shadow: inset 0 0 0 1px rgba(10, 16, 28, 0.36);
  }
  #classInfoCard {
    margin-top: 18px;
  }
  .info-card {
    border-radius: 18px;
    border: 1px solid rgba(148, 163, 184, 0.25);
    background: rgba(15, 23, 42, 0.55);
    box-shadow: 0 18px 34px rgba(2, 6, 23, 0.35);
    padding: 16px 18px;
    display: grid;
    gap: 8px;
  }
  .info-card-title {
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(226, 232, 240, 0.72);
  }
  .info-card-body {
    margin: 0;
    font-size: 14px;
    line-height: 1.6;
    font-family: inherit;
    white-space: pre-wrap;
    color: rgba(226, 232, 240, 0.9);
  }
  .info-card-hint {
    font-size: 12px;
    color: rgba(148, 163, 184, 0.75);
  }
  .context-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--ink);
    line-height: 1.5;
  }
  .actions {
    margin-top: 18px;
    display: flex;
    justify-content: flex-end;
  }
  .lbl {
    display: block;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--mut);
    margin: 0 0 6px;
  }
  select,
  input[type="number"] {
    width: 100%;
    border: 1px solid rgba(148, 163, 184, 0.45);
    border-radius: 16px;
    padding: 12px 14px;
    background: rgba(23, 35, 57, 0.78);
    color: var(--ink);
    font-size: 14px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
  }
  select:focus,
  input[type="number"]:focus {
    border-color: rgba(125, 211, 252, 0.85);
    box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.28);
    background: rgba(31, 48, 78, 0.9);
    outline: none;
  }
  .btn {
    background: #0ea5e9;
    color: #041628;
    border: 0;
    border-radius: 12px;
    padding: 11px 18px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    box-shadow: 0 12px 30px rgba(14, 165, 233, 0.32);
  }
  .btn:hover {
    background: #38bdf8;
    transform: translateY(-1px);
    box-shadow: 0 16px 34px rgba(14, 165, 233, 0.34);
  }
  #notesChips,
  .rule-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .note-chip,
  .rule-chip {
    font-size: 11px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.35);
    background: rgba(30, 41, 59, 0.85);
    color: var(--ink);
    padding: 4px 10px;
    cursor: pointer;
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 14px;
    align-items: stretch;
  }
  .group {
    background: var(--group);
    border: 1px solid rgba(148, 163, 184, 0.24);
    border-radius: 20px;
    padding: 18px;
    box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.22);
  }
  .g-title {
    font-weight: 700;
    font-size: 14px;
    color: var(--ink);
  }
  .g-sub {
    font-size: 12px;
    color: var(--mut);
    margin-top: 4px;
  }
  .card.result-card {
    display: flex;
    flex-direction: column;
    gap: 12px;
    height: 100%;
  }
  .badge {
    font-size: 12px;
    border-radius: 999px;
    border: 1px solid;
    padding: 3px 10px;
    font-weight: 700;
  }
  .b-ok {
    color: #4ade80;
    border-color: rgba(74, 222, 128, 0.5);
    background: rgba(21, 128, 61, 0.35);
  }
  .b-warn {
    color: #facc15;
    border-color: rgba(250, 204, 21, 0.55);
    background: rgba(120, 53, 15, 0.35);
  }
  .b-bad {
    color: #f87171;
    border-color: rgba(248, 113, 113, 0.55);
    background: rgba(127, 29, 29, 0.35);
  }
  .small { font-size: 12px; }
  .mut { color: var(--mut); }
  .reasons {
    margin: 6px 0 0 18px;
    font-size: 12px;
    color: var(--mut);
  }
  .view-action {
    margin-top: auto;
    padding-top: 16px;
    display: flex;
    justify-content: flex-end;
  }
  .view-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.04em;
    padding: 10px 24px;
    border-radius: 999px;
    border: 0;
    background: #0ea5e9;
    color: #041628;
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 14px 28px rgba(14, 165, 233, 0.3);
  }
  .view-btn:hover {
    background: #38bdf8;
    transform: translateY(-1px);
    box-shadow: 0 18px 34px rgba(14, 165, 233, 0.34);
  }
  .view-btn:active {
    transform: translateY(0);
  }
  .site-footer {
    margin: 60px 0 38px;
    text-align: center;
    font-size: 13px;
    color: rgba(203, 213, 225, 0.74);
  }
  .site-footer .footer-wrap {
    display: inline-grid;
    gap: 6px;
  }
  .site-footer a {
    color: inherit;
    text-decoration: underline;
  }
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    z-index: 20;
  }
  .modal.open {
    display: flex;
  }
  .modal .box {
    background: rgba(15, 23, 42, 0.92);
    border: 1px solid rgba(51, 65, 85, 0.8);
    border-radius: 14px;
    padding: 18px;
    max-width: 95vw;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 14px;
    position: relative;
    box-shadow: 0 24px 40px rgba(2, 6, 23, 0.6);
  }
  .modal img {
    max-width: 90vw;
    max-height: 70vh;
    display: block;
    border-radius: 12px;
  }
  .modal .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: 0;
    color: rgba(148, 163, 184, 0.9);
    font-size: 24px;
    cursor: pointer;
    padding: 4px;
  }
  .modal .close-btn:hover {
    color: #e2e8f0;
  }
  .modal-caption {
    font-size: 14px;
    color: rgba(203, 213, 225, 0.85);
    text-align: center;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header class="page-header">
      <a href="index.html" class="back-link">← Volver al inicio</a>
      <div class="logo-wrapper">
        <img src="assets/joints/cotec.jpg" alt="COTECMAR" class="brand-logo">
      </div>
    </header>
    <div class="h1">Evaluador de juntas – LR Ships</div>

    <!-- Controles -->
    <div class="card mb-3">
      <div class="controls">
        <div>
          <label class="lbl">Grupo de sistema</label>
          <select id="groupSel"></select>
        </div>
        <div>
          <label class="lbl">Sistema</label>
          <select id="systemSel"></select>
        </div>
        <div>
          <label class="lbl">Clase de tubería</label>
          <select id="classSel">
            <option value="I">Clase I</option>
            <option value="II">Clase II</option>
            <option value="III">Clase III</option>
          </select>
        </div>
        <div>
          <label class="lbl">Diámetro exterior (OD) [mm]</label>
          <input id="odInp" type="number" value="25"/>
        </div>
        <div>
          <label class="lbl">Espacio</label>
          <select id="spaceSel"></select>
        </div>
      </div>
      <div class="context-grid">
        <div id="chkVisibleWrap" class="context-field" style="display:none">
          <div class="context-label">Posición visible y accesible</div>
          <select id="visibleSel">
            <option value="no" selected>No</option>
            <option value="yes">Sí</option>
          </select>
        </div>
        <div id="chkSameWrap" class="context-field" style="display:none">
          <div class="context-label">(Si está en tanque) Medio del tubo coincide con el del tanque</div>
          <select id="sameMediumSel">
            <option value="no" selected>No</option>
            <option value="yes">Sí</option>
          </select>
        </div>
        <div class="context-field">
          <div class="context-label">(Slip type) Requiere compensación axial</div>
          <select id="axialSel">
            <option value="no" selected>No</option>
            <option value="yes">Sí</option>
          </select>
        </div>
        <div id="chkAboveWrap" class="context-field" style="display:none">
          <div class="context-label">(Nota 5) Por encima de cubierta (pax: mamparo / carga: francobordo)</div>
          <select id="aboveDecksSel">
            <option value="no" selected>No</option>
            <option value="yes">Sí</option>
          </select>
        </div>
      </div>
      <div id="classInfoCard"></div>
      <div class="actions">
        <button class="btn" id="btnEval">Evaluar</button>
      </div>
    </div>

    <!-- Notas -->
    <div class="card mb-3">
      <div class="small">
        <div class="mb-2"><strong>Notas aplicables</strong></div>
        <div id="notesChips"></div>
        <div class="small mut mt-2">Ensayo fuego (fila): <span id="fireRow">—</span> – (ver Nota 7 para equivalencias y especificación).</div>
        <div class="rule-row mt-3">
          <span class="rule-chip">Regla 2.12.8</span>
          <span class="rule-chip">Regla 2.12.9</span>
          <span class="rule-chip">Regla 2.12.10</span>
        </div>
      </div>
    </div>

    <!-- Resultados -->
    <div id="results"></div>
  </div>

  <!-- Modal -->
  <div id="imgModal" class="modal">
    <div class="box">
      <button type="button" class="close-btn" id="imgModalClose" aria-label="Cerrar">×</button>
      <img id="imgModalSrc" alt="Figura" />
      <div class="modal-caption" id="imgModalCaption"></div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="footer-wrap">
      <div>Por <strong>Jhon Eric Gomez</strong> – DVMPR-GEDIN</div>
      <div>Para consultas contactar a: <a href="mailto:jegomez@cotecmar.com">jegomez@cotecmar.com</a></div>
    </div>
  </footer>

<script>
/* ========= IMÁGENES por tipo ========= */
const JOINT_IMAGES = {
  pipe_union_welded_brazed: ['welded_brazed.jpg','welded_brazed.png'],
  comp_swage: ['compression_swage.jpg','compression_swage.png'],
  comp_bite: ['compression_bite.jpg','compression_bite.png'],
  comp_typical: ['compression_typical.jpg','compression_typical.png'],
  comp_flared: ['compression_flared.jpg','compression_flared.png'],
  comp_press: ['compression_press.jpg','compression_press.png'],
  slip_mgrooved: ['slip_machine_grooved.jpg','slip_machine_grooved.png'],
  slip_grip: ['slip_grip.jpg','slip_grip.png'],
  slip_type: ['slip_slip.jpg','slip_slip.png'],
};
const jointImgPath = k => 'assets/joints/' + (JOINT_IMAGES[k]?.[0] || 'not-found.jpg');

/* ========= DATASET LR SHIPS ========= */
function buildShips(){
  const JOINT_TYPES = [
    { key:'pipe_union_welded_brazed', group:'Pipe unions', label:'Unión roscada soldada/soldadura fuerte' },
    { key:'comp_swage', group:'Compression couplings', label:'Compresión tipo swage' },
    { key:'comp_bite', group:'Compression couplings', label:'Compresión tipo bite' },
    { key:'comp_typical', group:'Compression couplings', label:'Compresión típica' },
    { key:'comp_flared', group:'Compression couplings', label:'Compresión tipo flare' },
    { key:'comp_press', group:'Compression couplings', label:'Compresión tipo press' },
    { key:'slip_mgrooved', group:'Slip-on joints', label:'Slip-on ranurado a máquina' },
    { key:'slip_grip', group:'Slip-on joints', label:'Slip-on tipo grip' },
    { key:'slip_type', group:'Slip-on joints', label:'Slip-on tipo slip' },
  ];
  const SPACES = [
    { key:'mach_cat_a', label:'Espacio de máquinas Cat. A' },
    { key:'pump_room', label:'Sala de bombas' },
    { key:'accommodation', label:'Acomodaciones' },
    { key:'other_mach_service', label:'Otros esp. de máquinas/servicio' },
    { key:'open_deck', label:'Cubierta abierta' },
    { key:'cargo_hold', label:'Bodega de carga' },
    { key:'inside_tank', label:'Dentro de tanque' },
  ];
  const NOTES = {
    n1:{id:'1', es:'Ensayo/tipo resistente al fuego en salas de bombas y en cubiertas abiertas.', en:'Apply fire-resistant/test in pump-rooms and on open decks.'},
    n2:{id:'2', es:'Slip-on no aceptado en Cat. A y acomodaciones; en otros de máquinas sólo si visible/accesible.', en:'Slip-on not accepted in Cat. A and accommodation; in other machinery/service only if visible and accessible.'},
    n3:{id:'3', es:'Tipo resistente al fuego, excepto en cubierta abierta y no para fuel oil.', en:'Fire-resistant type, except on open deck and not for fuel oil lines.'},
    n4:{id:'4', es:'En Cat. A, aplicar ensayo/tipo resistente al fuego.', en:'In Cat. A apply fire test/type.'},
    n5:{id:'5', es:'Deck drains internos: sólo por encima de cubierta de referencia.', en:'Deck drains (internal): only above reference deck.'},
    n6:{id:'6', es:'Slip type en cubierta sólo si Pd ≤ 10 bar (según clase/medio).', en:'Slip type on deck only if design pressure ≤10 bar (by class/medium).'},
    n7:{id:'7', es:'Equivalencias: 30 dry ≈ (8+22) ≈ 30 wet.', en:'Equivalences: 30 dry ≈ (8+22) ≈ 30 wet.'},
    n8:{id:'8', es:'Vapor: slip-on restringida para movimiento axial.', en:'Steam: restrained slip-on for axial movement.'},
  };
  const GENERAL = {
    g_slip_on_inaccessible:{id:'2.12.8', es:'Slip-on no en bodegas/tanques no accesibles; en tanques sólo si el medio coincide.', en:'Slip-on not in cargo holds/tanks not easily accessible; inside tanks only if same medium.'},
    g_slip_type_main:{id:'2.12.9', es:'Slip type como medio principal sólo si compensa dilatación axial.', en:'Slip type as main means only where compensating axial deformation.'},
    g_steam_restrained:{id:'2.12.10', es:'En vapor: slip-on restringida para movimiento axial.', en:'Steam: restrained slip-on for axial movement.'},
  };
  const CLASS_RULES = {
    pipe_union_welded_brazed: { I:{allowed:true, odLE:60.3}, II:{allowed:true, odLE:60.3}, III:{allowed:true} },
    comp_swage: { I:{allowed:true}, II:{allowed:true}, III:{allowed:true} },
    comp_bite:  { I:{allowed:true, odLE:60.3}, II:{allowed:true, odLE:60.3}, III:{allowed:true} },
    comp_typical:{ I:{allowed:true, odLE:60.3}, II:{allowed:true, odLE:60.3}, III:{allowed:true} },
    comp_flared: { I:{allowed:true, odLE:60.3}, II:{allowed:true, odLE:60.3}, III:{allowed:true} },
    comp_press:  { I:{allowed:false}, II:{allowed:false}, III:{allowed:true} },
    slip_mgrooved:{ I:{allowed:true}, II:{allowed:true}, III:{allowed:true} },
    slip_grip:   { I:{allowed:false}, II:{allowed:true}, III:{allowed:true} },
    slip_type:   { I:{allowed:false}, II:{allowed:true}, III:{allowed:true} },
  };
  const allowAll = ()=>({pipe_union_welded_brazed:true,comp_swage:true,comp_bite:true,comp_typical:true,comp_flared:true,comp_press:true,slip_mgrooved:true,slip_grip:true,slip_type:true});
  const SYSTEM_GROUPS = [
    { key:'flamm_lt60', label:'Fluidos inflamables (fp < 60°C)', systems:[
      { key:'cargo_oil', label:'Líneas de crudo y derivados (fp < 60°C)', allow:allowAll(), notes:['n1'], fire:'30 min dry' },
      { key:'cow_lines', label:'Líneas de lavado de crudo (COW)', allow:allowAll(), notes:['n1'], fire:'30 min dry' },
      { key:'vent_lt60', label:'Líneas de venteo', allow:allowAll(), notes:['n3'], fire:'30 min dry' },
    ]},
    { key:'inert_gas', label:'Gas inerte', systems:[
      { key:'water_seal_effluent', label:'Efluentes del sello hidráulico', allow:allowAll(), notes:[], fire:'30 min wet' },
      { key:'scrubber_effluent', label:'Efluentes del depurador', allow:allowAll(), notes:[], fire:'30 min wet' },
      { key:'main_lines', label:'Líneas principales', allow:allowAll(), notes:['n1','n2'], fire:'30 min dry' },
      { key:'distribution', label:'Líneas de distribución', allow:allowAll(), notes:['n1'], fire:'30 min dry' },
    ]},
    { key:'flamm_gt60', label:'Fluidos inflamables (fp > 60°C)', systems:[
      { key:'cargo_oil_gt60', label:'Líneas de crudo y derivados (fp > 60°C)', allow:allowAll(), notes:['n1'], fire:'30 min dry' },
      { key:'fuel_oil', label:'Líneas de fuel oil', allow:allowAll(), notes:['n2','n3'], fire:'30 min wet' },
      { key:'lube_oil', label:'Líneas de aceite lubricante', allow:allowAll(), notes:['n2','n3'], fire:'30 min wet' },
      { key:'hydraulic_oil', label:'Aceite hidráulico', allow:allowAll(), notes:['n2','n3'], fire:'30 min wet' },
      { key:'thermal_oil', label:'Aceite térmico', allow:allowAll(), notes:['n2','n3'], fire:'30 min wet' },
    ]},
    { key:'seawater', label:'Agua de mar', systems:[
      { key:'bilge', label:'Líneas de achique (bilge)', allow:allowAll(), notes:['n4'], fire:'8 dry + 22 wet' },
      { key:'fire_perm', label:'Contra-incendios / rociadores (llenado permanente)', allow:allowAll(), notes:['n3'], fire:'30 min wet' },
      { key:'fire_nonperm', label:'Extinción (no permanente) / drencher / espuma', allow:allowAll(), notes:['n3'], fire:'8 dry + 22 wet' },
      { key:'ballast', label:'Sistema de lastre', allow:allowAll(), notes:['n4'], fire:'30 min wet' },
      { key:'cooling_sw', label:'Refrigeración – agua de mar', allow:allowAll(), notes:['n4'], fire:'30 min wet' },
    ]},
    { key:'freshwater', label:'Agua dulce', systems:[
      { key:'cooling_fw', label:'Refrigeración – agua dulce', allow:allowAll(), notes:['n4'], fire:'30 min wet' },
      { key:'cond_return', label:'Retorno de condensado', allow:allowAll(), notes:['n4'], fire:'30 min wet' },
      { key:'non_essential_fw', label:'Sistema no esencial', allow:allowAll(), notes:[], fire:'(no test)' },
    ]},
    { key:'sanitary', label:'Sanitarios / drenajes / escuppers', systems:[
      { key:'deck_drains_internal', label:'Drenajes de cubierta (internos)', allow:allowAll(), notes:['n5'], fire:'(no test)' },
      { key:'sanitary_drains', label:'Drenajes sanitarios', allow:allowAll(), notes:[], fire:'(dry)' },
      { key:'scuppers_overboard', label:'Escuppers y descarga sobre costado', allow:{...allowAll(), slip_mgrooved:false, slip_grip:false, slip_type:false}, notes:[], fire:'(dry)' },
    ]},
    { key:'sounding_vent', label:'Sondajes / venteos', systems:[
      { key:'water_tanks_dry_spaces', label:'Tanques de agua / espacios secos', allow:allowAll(), notes:[], fire:'(no test)' },
      { key:'oil_tanks_fp_gt60', label:'Tanques de aceite (fp > 60°C)', allow:allowAll(), notes:['n2','n3'], fire:'(dry)' },
    ]},
    { key:'misc', label:'Misceláneos / gases / vapor', systems:[
      { key:'start_control_air', label:'Aire de arranque / control', allow:{...allowAll(), slip_mgrooved:false, slip_grip:false, slip_type:false}, notes:['n4'], fire:'30 min dry' },
      { key:'service_air', label:'Aire de servicio (no esencial)', allow:allowAll(), notes:[], fire:'(no test)' },
      { key:'brine', label:'Salmuera', allow:allowAll(), notes:[], fire:'(wet)' },
      { key:'co2_outside', label:'CO₂ (fuera del espacio protegido)', allow:{...allowAll(), slip_mgrooved:false, slip_grip:false, slip_type:false}, notes:[], fire:'30 min dry' },
      { key:'co2_inside', label:'CO₂ (dentro del espacio protegido)', allow:{...allowAll(), slip_mgrooved:false, slip_grip:false, slip_type:false}, notes:[], fire:'(dry)' },
      { key:'steam', label:'Vapor', allow:{ pipe_union_welded_brazed:true, comp_swage:true, comp_bite:true, comp_typical:true, comp_flared:true, comp_press:true, slip_mgrooved:false, slip_grip:false, slip_type:false }, notes:['n8'], fire:'(no test)' },
    ]},
  ];

  // Para Nota 6 (Tabla 1.2.1): límites por clase/medio
  const CLASS_PRESS_LIMITS = {
    steam:{ II:16, III:7 },
    thermal:{ II:16, III:7 },
    flammable:{ II:16, III:7 },
    other:{ II:40, III:16 },
  };
  const SYSTEM_CATEGORY = {
    cargo_oil:'flammable', cow_lines:'flammable', vent_lt60:'flammable',
    cargo_oil_gt60:'flammable', fuel_oil:'flammable', lube_oil:'flammable', hydraulic_oil:'flammable', thermal_oil:'thermal',
    water_seal_effluent:'other', scrubber_effluent:'other', main_lines:'other', distribution:'other',
    bilge:'other', fire_perm:'other', fire_nonperm:'other', ballast:'other', cooling_sw:'other',
    cooling_fw:'other', cond_return:'other', non_essential_fw:'other',
    deck_drains_internal:'other', sanitary_drains:'other', scuppers_overboard:'other',
    water_tanks_dry_spaces:'other', oil_tanks_fp_gt60:'flammable',
    start_control_air:'other', service_air:'other', brine:'other', co2_outside:'other', co2_inside:'other',
    steam:'steam'
  };

  return { id:'ships', title:'LR Ships',
    JOINT_TYPES, SPACES, NOTES, GENERAL, CLASS_RULES, SYSTEM_GROUPS,
    EXTRA:{ CLASS_PRESS_LIMITS, SYSTEM_CATEGORY }
  };
}

/* ========= MOTOR ========= */
const $ = s => document.querySelector(s);
const std = buildShips(); // solo Ships en esta página

const groupSel=$('#groupSel'), systemSel=$('#systemSel'), classSel=$('#classSel'), odInp=$('#odInp'), spaceSel=$('#spaceSel');
const visibleSel=$('#visibleSel'), sameSel=$('#sameMediumSel'), axialSel=$('#axialSel'), aboveSel=$('#aboveDecksSel');
const chkVisibleWrap=$('#chkVisibleWrap'), chkSameWrap=$('#chkSameWrap'), chkAboveWrap=$('#chkAboveWrap');
const notesChips=$('#notesChips'), fireRow=$('#fireRow'), results=$('#results');
const classInfoCard=document.getElementById('classInfoCard');
const bodyEl=document.body;
const imgModal=$('#imgModal'), imgModalSrc=$('#imgModalSrc'), imgModalCaption=$('#imgModalCaption'), imgModalClose=$('#imgModalClose');
const FIGURE_CODE='12.2.4/12.2.5';
const escapeAttr = s => (s ?? '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;');

const CLASS_CARD_LIMITS = {
  Steam:             { P2_bar:16, T2_C:300, P1_bar:7,  T1_C:170 },
  'Thermal oil':     { P2_bar:16, T2_C:300, P1_bar:7,  T1_C:150 },
  'Flammable liquids': { P2_bar:16, T2_C:150, P1_bar:7,  T1_C:60  },
  'Other media':     { P2_bar:40, T2_C:300, P1_bar:16, T1_C:200 },
  'Cargo oil':       { P2_bar:40, T2_C:300, P1_bar:16, T1_C:200, shipsOnly:true },
};

const toMPa = bar => +(bar / 10).toFixed(2);
const escapeHtml = s => (s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function detectMediumLabel(groupLabel, systemLabel){
  const raw = `${groupLabel || ''} ${systemLabel || ''}`.trim();
  if(!raw) return null;
  const normalized = raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
  if(normalized.includes('vapor') || normalized.includes('steam')) return 'Steam';
  if(normalized.includes('termico') || normalized.includes('thermal')) return 'Thermal oil';
  if(
    normalized.includes('cargo') ||
    normalized.includes('crudo') ||
    normalized.includes('derivado') ||
    normalized.includes('lavado') ||
    normalized.includes('washing')
  ){
    return 'Cargo oil';
  }
  if(
    normalized.includes('inflamable') ||
    normalized.includes('combustible') ||
    normalized.includes('fuel') ||
    normalized.includes('aceite') ||
    normalized.includes('oil')
  ){
    return 'Flammable liquids';
  }
  return 'Other media';
}

function infoCardHtml({ title, body, hint }){
  return `<div class="info-card">
    <div class="info-card-title">${escapeHtml(title)}</div>
    <pre class="info-card-body">${escapeHtml(body)}</pre>
    ${hint ? `<div class="info-card-hint">${escapeHtml(hint)}</div>` : ''}
  </div>`;
}

function renderClassInfoCard(){
  if(!classInfoCard) return;
  const group = std.SYSTEM_GROUPS.find(x=>x.key===groupSel.value);
  const system = group?.systems.find(x=>x.key===systemSel.value);
  const pipeClass = classSel?.value;
  if(!group || !system || !pipeClass){
    classInfoCard.innerHTML='';
    classInfoCard.style.display='none';
    return;
  }

  const medio = detectMediumLabel(group.label, system.label);
  if(!medio){
    classInfoCard.innerHTML='';
    classInfoCard.style.display='none';
    return;
  }

  const lim = CLASS_CARD_LIMITS[medio];
  if(!lim){
    classInfoCard.innerHTML='';
    classInfoCard.style.display='none';
    return;
  }

  const norma = 'LR Ships';
  if(norma==='LR Naval' && lim.shipsOnly){
    classInfoCard.innerHTML = infoCardHtml({
      title:'Límites por clase',
      body:'El servicio seleccionado no aplica en LR Naval (no hay límites tabulados para este medio).\n\nSelecciona otro grupo de sistema.',
    });
    classInfoCard.style.display='';
    return;
  }

  const p2 = toMPa(lim.P2_bar);
  const p1 = toMPa(lim.P1_bar);
  let html='';
  if(pipeClass==='I'){
    html = infoCardHtml({
      title:'Límites por clase – Clase I',
      body:
        'Clase I no tiene límite tabulado de P/T. Se selecciona cuando P > P₂ o T > T₂ del medio seleccionado.\n\n' +
        'Umbrales (Clase II) para este medio:\n' +
        `• P₂ = ${lim.P2_bar} bar (${p2} MPa)\n` +
        `• T₂ = ${lim.T2_C} °C`,
      hint:`Norma: ${norma}`,
    });
  } else if(pipeClass==='II'){
    html = infoCardHtml({
      title:'Límites por clase – Clase II',
      body:
        'Máximos permitidos para el medio seleccionado:\n' +
        `• P₂ = ${lim.P2_bar} bar (${p2} MPa)\n` +
        `• T₂ = ${lim.T2_C} °C`,
      hint:`Norma: ${norma}`,
    });
  } else {
    html = infoCardHtml({
      title:'Límites por clase – Clase III',
      body:
        'Máximos permitidos para el medio seleccionado:\n' +
        `• P₁ = ${lim.P1_bar} bar (${p1} MPa)\n` +
        `• T₁ = ${lim.T1_C} °C`,
      hint:`Norma: ${norma}`,
    });
  }

  classInfoCard.innerHTML = html;
  classInfoCard.style.display = html ? '' : 'none';
}

function load(){
  groupSel.innerHTML = std.SYSTEM_GROUPS.map(g=>`<option value="${g.key}">${g.label}</option>`).join('');
  updateSystems();
  spaceSel.innerHTML = std.SPACES.map(s=>`<option value="${s.key}">${s.label}</option>`).join('');
  renderNotes();
}
function updateSystems(){
  const g = std.SYSTEM_GROUPS.find(x=>x.key===groupSel.value)||std.SYSTEM_GROUPS[0];
  groupSel.value = g.key;
  systemSel.innerHTML = g.systems.map(s=>`<option value="${s.key}">${s.label}</option>`).join('');
  renderNotes();
  showContextualChecks();
}
function renderNotes(){
  const g = std.SYSTEM_GROUPS.find(x=>x.key===groupSel.value);
  const s = g?.systems.find(x=>x.key===systemSel.value);
  notesChips.innerHTML = (s?.notes||[]).map(nc=>{
    const n = std.NOTES[nc];
    return n ? `<button class="note-chip" title="${n.en.replace(/"/g,'&quot;')}">Nota ${n.id}</button>` : '';
  }).join(' ');
  fireRow.textContent = s?.fire || '—';
  renderClassInfoCard();
}
function showContextualChecks(){
  const g = std.SYSTEM_GROUPS.find(x=>x.key===groupSel.value);
  const s = g?.systems.find(x=>x.key===systemSel.value);
  // Visible solo si Nota 2 y espacio = otros de máquinas/servicio
  const showVisible = (s?.notes?.includes('n2') && spaceSel.value==='other_mach_service');
  chkVisibleWrap.style.display = showVisible ? '' : 'none';
  if(!showVisible) visibleSel.value = 'no';
  // Tanque: medio coincide
  const showSame = spaceSel.value==='inside_tank';
  chkSameWrap.style.display = showSame ? '' : 'none';
  if(!showSame) sameSel.value = 'no';
  // Nota 5: solo deck drains (internos)
  const showAbove = s?.key==='deck_drains_internal';
  chkAboveWrap.style.display = showAbove ? '' : 'none';
  if(!showAbove) aboveSel.value = 'no';
}

function evaluate(){
  const g = std.SYSTEM_GROUPS.find(x=>x.key===groupSel.value);
  const s = g?.systems.find(x=>x.key===systemSel.value);
  if(!s) return;

  const a = {
    systemKey:s.key, pipeClass:classSel.value, space:spaceSel.value,
    od:Number(odInp.value||0),
    visible:visibleSel.value==='yes',
    sameMedium:sameSel.value==='yes',
    axial:axialSel.value==='yes',
    aboveDecks:aboveSel.value==='yes'
  };
  const items = [];

  for(const jt of std.JOINT_TYPES){
    let status = s.allow[jt.key] ? 'ok' : 'no';
    const reasons = [];
    if(status==='no'){ items.push({jt,status,reasons:['No permitido por Tabla 12.2.8 para este sistema.']}); continue; }

    const cr = std.CLASS_RULES[jt.key]?.[a.pipeClass];
    if(cr){
      if(!cr.allowed){ status='no'; reasons.push(`No permitido para Clase ${a.pipeClass} (Tabla 12.2.9).`); }
      else if(cr.odLE && a.od > cr.odLE){ status='no'; reasons.push(`OD > ${cr.odLE} mm no permitido para Clase ${a.pipeClass}.`); }
    }

    if(status!=='no' && s.notes?.length){
      for(const nc of s.notes){
        if(nc==='n1'){
          if(a.space==='pump_room' || a.space==='open_deck'){
            status = status==='ok' ? 'warn' : status;
            reasons.push('Requiere ensayo/tipo resistente al fuego (Nota 1).');
          }
        }
        if(nc==='n2' && jt.key.startsWith('slip_')){
          if(['mach_cat_a','accommodation'].includes(a.space)){
            status='no'; reasons.push('Slip-on prohibido en Cat. A o acomodaciones (Nota 2).');
          } else if(a.space==='other_mach_service'){
            if(!a.visible){ status='no'; reasons.push('Requiere posición visible y accesible (Nota 2).'); }
          }
        }
        if(nc==='n3'){
          const isFuelOil = s.key==='fuel_oil' || s.key==='oil_tanks_fp_gt60';
          if(a.space!=='open_deck' || isFuelOil){
            status = status==='ok' ? 'warn' : status;
            reasons.push('Tipo resistente al fuego requerido (Nota 3).');
          }
        }
        if(nc==='n4'){
          if(a.space==='mach_cat_a'){
            status = status==='ok' ? 'warn' : status;
            reasons.push('Ensayo/tipo resistente al fuego en Cat. A (Nota 4).');
          }
        }
        if(nc==='n5' && s.key==='deck_drains_internal'){
          status = status==='ok' ? 'warn' : status;
          if(!a.aboveDecks) reasons.push('Sólo por encima de cubierta de referencia (Nota 5).');
        }
        if(nc==='n6' && jt.key==='slip_type'){
          if(a.space==='open_deck'){
            const cat = std.EXTRA.SYSTEM_CATEGORY[s.key] || 'other';
            const lim = std.EXTRA.CLASS_PRESS_LIMITS[cat]?.[a.pipeClass] ?? Infinity;
            if(lim <= 10){ status = status==='ok' ? 'warn' : status; reasons.push('Slip type en cubierta permitido si Pd ≤ 10 bar (por clase/medio, Nota 6).'); }
            else { status='no'; reasons.push('Slip type en cubierta: no permitido con esta clase/medio (Nota 6).'); }
          }
        }
      }
    }

    // Reglas generales 2.12.8–2.12.10
    if(status!=='no' && jt.key.startsWith('slip_')){
      if(a.space==='cargo_hold'){ status='no'; reasons.push('Slip-on no en bodegas/carga (2.12.8).'); }
      if(a.space==='inside_tank'){ status = status==='ok' ? 'warn' : status; if(!a.sameMedium) reasons.push('En tanques: sólo si el medio coincide (2.12.8).'); }
    }
    if(status!=='no' && jt.key==='slip_type'){
      status = status==='ok' ? 'warn' : status;
      if(!a.axial) reasons.push('Slip type sólo si compensa dilatación axial (2.12.9).');
    }
    if(status!=='no' && s.key==='steam' && jt.key==='slip_type' && a.axial){
      status = status==='ok' ? 'warn' : status;
      reasons.push('Vapor: slip-on restringida para movimiento axial (2.12.10 / Nota 8).');
    }

    items.push({jt,status,reasons});
  }

  render(items);
}

function openJointModal(key, label){
  if(!imgModal || !key) return;
  const src = jointImgPath(key);
  if(imgModalSrc){
    imgModalSrc.src = src;
    imgModalSrc.alt = label ? `Figura de ${label}` : 'Figura de junta';
  }
  if(imgModalCaption){
    const parts = [`Figura ${FIGURE_CODE}`];
    if(label) parts.push(label);
    imgModalCaption.textContent = parts.join(' · ');
    imgModalCaption.style.display = parts.length ? '' : 'none';
  }
  imgModal.classList.add('open');
  bodyEl?.classList.add('modal-open');
}

function closeJointModal(){
  if(imgModal){
    imgModal.classList.remove('open');
  }
  if(imgModalSrc){
    imgModalSrc.removeAttribute('src');
    imgModalSrc.alt = 'Figura de junta';
  }
  if(imgModalCaption){
    imgModalCaption.textContent = '';
    imgModalCaption.style.display = 'none';
  }
  bodyEl?.classList.remove('modal-open');
}

function render(items){
  const order = Array.from(new Set(std.JOINT_TYPES.map(j=>j.group)));
  const labels = {'Pipe unions':'Uniones de tubería','Compression couplings':'Acoplamientos de compresión','Slip-on joints':'Juntas slip-on'};
  const byGroup = {};
  for(const it of items){ const jt = it.jt; (byGroup[jt.group] ||= []).push(it); }
  results.innerHTML = order.map(gr=>{
    const arr = byGroup[gr]||[]; if(!arr.length) return '';
    return `<section class="group" style="margin-bottom:12px">
      <div class="g-title">${labels[gr]||gr}</div><div class="g-sub">${gr}</div>
      <div class="grid" style="margin-top:8px">
        ${arr.map(({jt,status,reasons})=>{
          const badge = status==='ok' ? '<span class="badge b-ok">Permitido</span>' : status==='warn' ? '<span class="badge b-warn">Permitido con condiciones</span>' : '<span class="badge b-bad">Prohibido</span>';
          const rs = reasons?.length ? `<ul class="reasons">${reasons.map(r=>`<li>${r}</li>`).join('')}</ul>` : `<div class="small mut">Sin observaciones.</div>`;
          const labelEsc = escapeAttr(jt.label);
          return `<div class="card result-card">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px"><div style="font-weight:600">${labelEsc}</div>${badge}</div>
            ${rs}
            <div class="view-action"><button type="button" class="view-btn js-view" data-key="${jt.key}" data-label="${labelEsc}" data-figure="${FIGURE_CODE}">VER</button></div>
          </div>`;
        }).join('')}
      </div>
    </section>`;
  }).join('');
  // enlazar modales
  document.querySelectorAll('.js-view').forEach(b=>{
    b.addEventListener('click', ()=>{
      const { key, label } = b.dataset;
      openJointModal(key, label);
    });
  });
}

/* ========= Eventos ========= */
groupSel.addEventListener('change', ()=>{updateSystems(); showContextualChecks();});
systemSel.addEventListener('change', ()=>{renderNotes(); showContextualChecks();});
classSel.addEventListener('change', renderClassInfoCard);
spaceSel.addEventListener('change', showContextualChecks);
document.querySelector('#btnEval').addEventListener('click', evaluate);

if(imgModal){
  imgModal.addEventListener('click', e=>{
    if(e.target === imgModal) closeJointModal();
  });
}
if(imgModalClose){
  imgModalClose.addEventListener('click', closeJointModal);
}
document.addEventListener('keydown', e=>{
  if(e.key === 'Escape'){
    closeJointModal();
  }
});

/* init */
load();
evaluate();
</script>
</body>
</html>
