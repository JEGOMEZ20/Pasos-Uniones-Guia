<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asesor Grip-Type (Slip-on Joints) · LR Naval Ships</title>

  <script>
    tailwind = {
      config: {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "Segoe UI", "system-ui", "-apple-system", "sans-serif"],
            },
          },
        },
      },
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ===== Mejoras de presentación (no tocan la lógica) ===== */
    .page-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 24px;
      flex-wrap: wrap;
    }

    .page-header .header-copy {
      flex: 1 1 360px;
      min-width: 260px;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .page-header .header-brand {
      flex: 0 0 auto;
      width: 200px;
      max-width: 100%;
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
      padding: 12px;
      border-radius: 22px;
      background: rgba(15, 23, 42, 0.5);
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 40px rgba(8, 47, 73, 0.35);
    }

    .page-header .header-brand img {
      width: 100%;
      height: auto;
      border-radius: 14px;
      display: block;
    }

    .sublead {
      font-size: 1rem;
      line-height: 1.5;
      opacity: 0.9;
      margin: 0;
      max-width: 720px;
    }

    .block-subtitle {
      display: block;
      margin-top: 0.5rem;
    }

    .logic-hint {
      font-size: 0.85rem;
      opacity: 0.85;
      margin-top: 6px;
    }

    .result-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 18px;
      align-items: stretch;
    }

    .result-card {
      display: flex;
      flex-direction: column;
      min-height: 560px;
      padding: 18px 18px 20px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .result-card--allowed {
      border-color: rgba(34, 197, 94, 0.65);
      box-shadow: 0 12px 28px rgba(34, 197, 94, 0.22), 0 0 0 1px rgba(34, 197, 94, 0.45);
      background: linear-gradient(145deg, rgba(34, 197, 94, 0.16), rgba(14, 116, 144, 0.05));
    }

    .card-allowed {
      background: rgba(34, 197, 94, 0.12);
      border-color: rgba(34, 197, 94, 0.55);
    }

    .result-card--allowed .block-subtitle {
      color: #4ade80;
    }

    .result-card--allowed .option-item {
      border-color: rgba(34, 197, 94, 0.42);
      background: rgba(34, 197, 94, 0.14);
    }

    .result-card--allowed .option-actions .chip {
      border-color: rgba(34, 197, 94, 0.5);
      background: rgba(34, 197, 94, 0.22);
      color: #bbf7d0;
    }

    .result-card--allowed .option-actions .chip:hover {
      background: rgba(34, 197, 94, 0.28);
      border-color: rgba(34, 197, 94, 0.6);
    }

    .result-card--blocked {
      border-color: rgba(239, 68, 68, 0.7);
      box-shadow: 0 12px 28px rgba(239, 68, 68, 0.24), 0 0 0 1px rgba(239, 68, 68, 0.5);
      background: linear-gradient(145deg, rgba(127, 29, 29, 0.3), rgba(67, 20, 20, 0.12));
    }

    .card-denied {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.6);
    }

    .card-allowed .status-dot {
      background: #22c55e;
    }

    .card-denied .status-dot {
      background: #ef4444;
    }

    .result-card--blocked .block-subtitle {
      color: #fca5a5;
    }

    .result-card--blocked .option-item {
      border-color: rgba(239, 68, 68, 0.48);
      background: rgba(239, 68, 68, 0.14);
    }

    .result-card--blocked .option-actions .chip {
      border-color: rgba(239, 68, 68, 0.5);
      background: rgba(239, 68, 68, 0.22);
      color: #fecdd3;
    }

    .result-card--blocked .option-actions .chip:hover {
      background: rgba(239, 68, 68, 0.28);
      border-color: rgba(239, 68, 68, 0.62);
    }

    .result-header {
      text-align: center;
      margin-bottom: 10px;
      line-height: 1.2;
    }

    .result-title-es {
      display: block;
      font-size: 1.25rem;
      font-weight: 700;
    }

    .result-title-en {
      display: block;
      font-size: 0.95rem;
      opacity: 0.75;
      margin-top: 2px;
    }

    .block-subtitle {
      margin: 8px 0 16px;
      opacity: 0.95;
    }

    .result-body {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
    }

    .option-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .option-item {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      padding: 14px 16px;
      min-height: 86px;
      border: 1px dashed rgba(255, 255, 255, 0.14);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
    }

    .option-text {
      line-height: 1.22;
    }

    .option-es {
      display: block;
      font-weight: 600;
    }

    .option-en {
      display: block;
      opacity: 0.85;
      font-size: 0.95rem;
    }

    .option-actions .chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.28);
      background: rgba(255, 255, 255, 0.08);
      color: inherit;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease;
      white-space: nowrap;
    }

    .option-actions .chip:hover {
      background: rgba(255, 255, 255, 0.14);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .notes {
      margin-top: 12px;
    }

    .notes-title {
      font-size: 1rem;
      font-weight: 700;
      padding: 6px 0;
    }

    .notes-list {
      list-style: disc;
      padding-left: 1.25rem;
      margin: 0;
    }

    .notes-list li {
      font-size: 0.95rem;
      line-height: 1.45;
      margin: 4px 0;
      opacity: 0.95;
    }

    details {
      border-left: 3px solid rgba(148, 163, 184, 0.35);
      padding-left: 10px;
    }

    details + details {
      margin-top: 8px;
    }

    .option-actions .chip:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      background: rgba(148, 163, 184, 0.1);
      border-color: rgba(148, 163, 184, 0.25);
    }

    .option-item.disabled {
      opacity: 0.55;
      filter: grayscale(15%);
      text-decoration: line-through;
    }

    @media (max-width: 900px) {
      .result-row {
        grid-template-columns: 1fr;
      }

      .result-card {
        min-height: 0;
      }
    }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
  <div class="p-4">
    <a href="./index.html" class="inline-flex items-center gap-2 text-sm text-sky-300 hover:text-sky-100">
      <span aria-hidden="true">←</span>
      Volver al inicio
    </a>
  </div>
  <div id="root"></div>

  <script type="module">
    import htm from 'https://unpkg.com/htm?module';
    import { createElement as h, useEffect, useMemo, useRef, useState } from 'https://esm.sh/react@18';
    import ReactDOM from 'https://esm.sh/react-dom@18/client';

    const html = htm.bind(h);

    const DEFAULT_JOINT_IMAGE = "./assets/joints/not-found.jpg";

    const JOINT_IMAGES = {
      pipe_welded_brazed: "./assets/joints/pipe_welded_brazed.jpg",
      compression_swage: "./assets/joints/compression_swage.jpg",
      compression_press: "./assets/joints/compression_press.jpg",
      compression_typical: "./assets/joints/compression_typical.jpg",
      compression_bite: "./assets/joints/compression_bite.jpg",
      compression_flared: "./assets/joints/compression_flared.jpg",
      slip_machine_grooved: "./assets/joints/slip_machine_grooved.jpg",
      slip_grip: "./assets/joints/slip_grip.jpg",
      slip_slip: "./assets/joints/slip_slip.jpg",
    };

    const JOINT_LABELS = {
      pipe_welded_brazed: "Welded and Brazed Types (uniones soldadas y por braseado)",
      compression_swage: "Swage Type (swage)",
      compression_press: "Press Type (prensado)",
      compression_typical: "Typical Compression Type (compresión “típica” con férula)",
      compression_bite: "Bite Type (anillo mordedor)",
      compression_flared: "Flared Type (abocardado/abocinado)",
      slip_machine_grooved: "Machine Grooved Type — Roll Groove / Cut Groove (ranura laminada / ranura mecanizada)",
      slip_grip: "Grip Type (tipo “grip”/agarre)",
      slip_slip: "Slip Type (tipo “slip”/deslizante)",
    };

    const JOINT_CATEGORY_TITLES = {
      pipe_welded_brazed: "Pipe unions",
      compression_swage: "Compression couplings",
      compression_press: "Compression couplings",
      compression_typical: "Compression couplings",
      compression_bite: "Compression couplings",
      compression_flared: "Compression couplings",
      slip_machine_grooved: "Slip-on Joints",
      slip_grip: "Slip-on Joints",
      slip_slip: "Slip-on Joints",
    };

    const ES_JOIN_TITLES = {
      "Pipe unions": "Uniones para tubería",
      "Compression couplings": "Acoples de compresión",
      "Slip-on Joints": "Juntas Slip-on",
    };

    function biTitle(en) {
      const es = ES_JOIN_TITLES[en] ?? en;
      return { es, en };
    }

    const ES_GROUP = {
      "Flammable fluids (flash point ≤ 60°C)": "Fluidos inflamables (punto de inflamación ≤ 60 °C)",
      "Flammable fluids (flash point > 60°C)": "Fluidos inflamables (punto de inflamación > 60 °C)",
      "Sea water": "Agua de mar",
      "Fresh water": "Agua dulce",
      "Sanitary / drains / scuppers": "Sanitario / drenajes / imbornales",
      "Sounding / vent": "Aforo / venteo",
      "Miscellaneous": "Varios",
    };

    const ES_SYSTEM = {
      ff_le60_aircraft_vehicle_fuel: "Líneas de combustible de aeronaves y vehículos",
      ff_le60_vent_lines: "Líneas de venteo",

      ff_gt60_aircraft_vehicle_fuel: "Líneas de combustible de aeronaves y vehículos",
      ff_gt60_ship_machinery_fuel: "Líneas de combustible de maquinaria del buque",
      ff_gt60_lubricating_oil: "Líneas de aceite lubricante",
      ff_gt60_hydraulic_oil: "Aceite hidráulico",

      sw_bilge: "Líneas de achique",
      sw_hp_spray: "Agua de mar a alta presión y rociadores (no permanentemente llenos)",
      sw_perm_fireext: "Sistemas contra incendios permanentemente llenos (línea principal, rociadores)",
      sw_nonperm_fireext: "Sistemas contra incendios no permanentemente llenos (espuma, diluvio, línea principal)",
      sw_ballast: "Sistema de lastre",
      sw_cooling: "Sistema de agua de enfriamiento",
      sw_tank_cleaning: "Servicios de limpieza de tanques",
      sw_non_essential: "Sistemas no esenciales",

      fw_cooling: "Sistema de agua de enfriamiento",
      fw_chilled: "Sistema de agua helada",
      fw_condensate: "Retorno de condensado",
      fw_made_demin: "Sistema de agua fabricada y desmineralizada",
      fw_ancillary: "Sistema auxiliar",

      san_deck_drains: "Drenajes de cubierta (internos)",
      san_sanitary_drains: "Drenajes sanitarios",
      san_scuppers_overboard: "Imbornales y descargas (al mar)",

      sv_water_tanks_dry: "Tanques de agua / espacios secos",
      sv_oil_tanks: "Tanques de aceite (p.f. > 60 °C)",
      sv_intakes_uptakes: "Tomas y escapes",
      sv_hvac: "Conductos HVAC",

      misc_air_hp: "Aire de alta presión (HP)",
      misc_air_mp: "Aire de media presión (MP)",
      misc_air_lp: "Aire de baja presión (LP)",
      misc_service_air_nonessential: "Aire de servicio (no esencial)",
      misc_brine: "Salmuera",
      misc_co2: "Sistema de CO₂",
      misc_n2: "Sistema de nitrógeno",
      misc_steam: "Vapor",
      pipe_welded_brazed: "Uniones soldadas y por braseado",
      compression_swage: "Tipo swage",
      compression_press: "Tipo prensado",
      compression_typical: "Tipo compresión típica (férula)",
      compression_bite: "Tipo mordedor",
      compression_flared: "Tipo abocardado/abocinado",
      slip_machine_grooved: "Tipo ranurado (laminado/mecanizado)",
      slip_grip: "Tipo grip / agarre",
      slip_slip: "Tipo slip / deslizante",
    };

    function biLabel(item) {
      const es = ES_SYSTEM[item.id] ?? item.system ?? item.id;
      const en = item.system ?? item.id;
      return { es, en };
    }

    const ES_SPACES = {
      category_a: "Espacio de máquinas de categoría A",
      other_machinery: "Otros espacios de maquinaria/servicio (accesibles y visibles)",
      accommodation: "Acomodaciones (habitabilidad)",
      munition_store: "Depósitos de municiones",
      cargo_hold: "Bodega de carga",
      tank: "Interior de tanque",
      open_deck: "Cubierta expuesta / intemperie",
    };

    function tGroup(groupKey) {
      return ES_GROUP[groupKey] ?? groupKey;
    }

    function tSystem(item) {
      return ES_SYSTEM[item.id] ?? item.system ?? item.id;
    }

    function tSpace(spaceKey) {
      return ES_SPACES[spaceKey] ?? spaceKey;
    }

    const SPACES_KEYS = [
      "category_a",
      "other_machinery",
      "accommodation",
      "munition_store",
      "cargo_hold",
      "tank",
      "open_deck",
    ];

    const SCHEDULES = [
      { nps: "1/8", dn: 6, od: 10.3, label: "DN6 (1/8) – OD 10,3", t: { "5S": null, "5": null, "10S": 1.24, "10": 1.24, "40S": 1.73, "40": 1.73, "80S": 2.41, "80": 2.41, "160": null } },
      { nps: "1/4", dn: 8, od: 13.7, label: "DN8 (1/4) – OD 13,7", t: { "5S": null, "5": null, "10S": 1.65, "10": 1.65, "40S": 2.24, "40": 2.24, "80S": 3.02, "80": 3.02, "160": null } },
      { nps: "3/8", dn: 10, od: 17.2, label: "DN10 (3/8) – OD 17,2", t: { "5S": null, "5": null, "10S": 1.65, "10": 1.65, "40S": 2.31, "40": 2.31, "80S": 3.2, "80": 3.2, "160": null } },
      { nps: "1/2", dn: 15, od: 21.3, label: "DN15 (1/2) – OD 21,3", t: { "5S": 1.65, "5": 1.65, "10S": 2.11, "10": 2.11, "40S": 2.77, "40": 2.77, "80S": 3.73, "80": 3.73, "160": 4.78 } },
      { nps: "3/4", dn: 20, od: 26.7, label: "DN20 (3/4) – OD 26,7", t: { "5S": 1.65, "5": 1.65, "10S": 2.11, "10": 2.11, "40S": 2.87, "40": 2.87, "80S": 3.91, "80": 3.91, "160": 5.56 } },
      { nps: "1", dn: 25, od: 33.4, label: "DN25 (1) – OD 33,4", t: { "5S": 1.65, "5": 1.65, "10S": 2.77, "10": 2.77, "40S": 3.38, "40": 3.38, "80S": 4.55, "80": 4.55, "160": 6.35 } },
      { nps: "1 1/4", dn: 32, od: 42.2, label: "DN32 (1¼) – OD 42,2", t: { "5S": 1.65, "5": 1.65, "10S": 2.77, "10": 2.77, "40S": 3.56, "40": 3.56, "80S": 4.85, "80": 4.85, "160": 6.35 } },
      { nps: "1 1/2", dn: 40, od: 48.3, label: "DN40 (1½) – OD 48,3", t: { "5S": 1.65, "5": 1.65, "10S": 2.77, "10": 2.77, "40S": 3.68, "40": 3.68, "80S": 5.08, "80": 5.08, "160": 7.14 } },
      { nps: "2", dn: 50, od: 60.3, label: "DN50 (2) – OD 60,3", t: { "5S": 1.65, "5": 1.65, "10S": 2.77, "10": 2.77, "40S": 3.91, "40": 3.91, "80S": 5.54, "80": 5.54, "160": 8.74 } },
      { nps: "2 1/2", dn: 65, od: 73.0, label: "DN65 (2½) – OD 73,0", t: { "5S": 2.11, "5": 2.11, "10S": 3.05, "10": 3.05, "40S": 5.16, "40": 5.16, "80S": 7.01, "80": 7.01, "160": 9.53 } },
      { nps: "3", dn: 80, od: 88.9, label: "DN80 (3) – OD 88,9", t: { "5S": 2.11, "5": 2.11, "10S": 3.05, "10": 3.05, "40S": 5.49, "40": 5.49, "80S": 7.62, "80": 7.62, "160": 11.13 } },
      { nps: "3 1/2", dn: 90, od: 101.6, label: "DN90 (3½) – OD 101,6", t: { "5S": 2.11, "5": 2.11, "10S": 3.05, "10": 3.05, "40S": 5.74, "40": 5.74, "80S": 8.08, "80": 8.08, "160": null } },
      { nps: "4", dn: 100, od: 114.3, label: "DN100 (4) – OD 114,3", t: { "5S": 2.11, "5": 2.11, "10S": 3.05, "10": 3.05, "40S": 6.02, "40": 6.02, "80S": 8.56, "80": 11.13, "160": 13.49 } },
      { nps: "5", dn: 125, od: 141.3, label: "DN125 (5) – OD 141,3", t: { "5S": 2.77, "5": 2.77, "10S": 3.4, "10": 3.4, "40S": 6.55, "40": 6.55, "80S": 9.53, "80": 9.53, "160": 15.88 } },
      { nps: "6", dn: 150, od: 168.3, label: "DN150 (6) – OD 168,3", t: { "5S": 2.77, "5": 2.77, "10S": 3.4, "10": 3.4, "40S": 7.11, "40": 7.11, "80S": 10.97, "80": 10.97, "160": 18.26 } },
      { nps: "8", dn: 200, od: 219.1, label: "DN200 (8) – OD 219,1", t: { "5S": 2.77, "5": 2.77, "10S": 3.76, "10": 3.76, "40S": 8.18, "40": 8.18, "80S": 12.7, "80": 12.7, "160": 23.01 } },
      { nps: "10", dn: 250, od: 273.1, label: "DN250 (10) – OD 273,1", t: { "5S": 3.4, "5": 3.4, "10S": 4.19, "10": 4.19, "40S": 9.27, "40": 9.27, "80S": 12.7, "80": 15.09, "160": 28.58 } },
      { nps: "12", dn: 300, od: 323.9, label: "DN300 (12) – OD 323,9", t: { "5S": 3.96, "5": 3.96, "10S": 4.57, "10": 4.57, "40S": 9.53, "40": 10.31, "80S": 12.7, "80": 17.48, "160": 33.32 } },
    ];

    const SCHEDULES_DN16_200 = SCHEDULES.filter((s) => s.dn >= 16 && s.dn <= 200);

    function parseViewerHash(hash) {
      if (!hash) return null;
      const match = hash.match(/^#view:([\w-]+)$/i);
      return match ? match[1] : null;
    }

    function buildViewerTitle(kind) {
      const label = JOINT_LABELS[kind] || kind;
      const category = JOINT_CATEGORY_TITLES[kind];
      return category ? `${category} · ${label}` : label;
    }

    const SearchIcon = ({ className = "w-4 h-4", ...props }) =>
      h(
        "svg",
        {
          className,
          viewBox: "0 0 24 24",
          fill: "none",
          stroke: "currentColor",
          strokeWidth: 2,
          strokeLinecap: "round",
          strokeLinejoin: "round",
          ...props,
        },
        h("circle", { cx: 11, cy: 11, r: 7 }),
        h("line", { x1: 21, y1: 21, x2: 16.65, y2: 16.65 })
      );

    const ShieldIcon = ({ className = "w-6 h-6", ...props }) =>
      h(
        "svg",
        {
          className,
          viewBox: "0 0 24 24",
          fill: "none",
          stroke: "currentColor",
          strokeWidth: 2,
          strokeLinecap: "round",
          strokeLinejoin: "round",
          ...props,
        },
        h("path", { d: "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" })
      );

    // ---------------------------------------------------------------------------
    // REGLAMENTOS (rulesets)
    // ---------------------------------------------------------------------------
    const RULESETS = {
      naval: {
        id: "naval",
        title: "LR Naval Ships",
        subtitle:
          "Basado en LR Vol. 2 – Machinery & Engineering Systems, Pt 7: Piping Systems, Ch 1: Piping Design Requirements, Sec 5: Pipe joints. La interfaz usa abreviaciones en español.",
        CLASS_LIMITS: {
          steam: { classII: { P: 16, T: 300 }, classIII: { P: 7, T: 170 } },
          thermal_oil: { classII: { P: 16, T: 300 }, classIII: { P: 7, T: 150 } },
          flammable_liquids: { classII: { P: 16, T: 150 }, classIII: { P: 7, T: 60 } },
          other_media: { classII: { P: 40, T: 300 }, classIII: { P: 16, T: 200 } },
        },
        TABLE_NOTES_ES: {
          "1": "Las juntas mecánicas que incluyan componentes que se deterioran fácilmente en caso de incendio deben ser de tipo resistente al fuego aprobado cuando se instalen en espacios de maquinaria de Categoría A. Los acoplamientos del ‘bilge main’ en espacios de Categoría A deben ser de acero, CuNi o material equivalente.",
          "2": "Los slip‑on joints no se aceptan dentro de espacios de maquinaria de Categoría A, depósitos de munición ni espacios de alojamiento. Se aceptan en otros espacios de maquinaria y servicio siempre que queden en posiciones fácilmente visibles y accesibles.",
          "3": "Las juntas mecánicas deben ser de tipo resistente al fuego aprobado, salvo cuando estén en cubiertas abiertas con poco o ningún riesgo de incendio según SOLAS II‑2/9.2.3.3.2.2(10).",
          "4": "Las juntas mecánicas deben ser de tipo resistente al fuego aprobado.",
          "5": "Ver Vol 2, Pt 7, Ch 1, 5.10 – Other mechanical couplings (remisión normativa).",
          "6": "Las juntas mecánicas solo se permiten por encima del límite de integridad estanca (WTI).",
          "7": "Requisitos para HVAC trunking y para entradas/salidas de turbina de gas se tratan en las secciones correspondientes de las Reglas.",
        },
        LR_REQUIREMENTS_ES: [
          { id: "5.10.5", text: "Las juntas mecánicas para tuberías a presión deben resistir una presión de rotura ≥ 4 × la presión de diseño." },
          { id: "5.10.6", text: "Se prohíben juntas mecánicas en líneas conectadas directamente al costado por debajo del límite de integridad estanca o en tanques con fluidos inflamables cuando el daño pueda causar incendio o inundación." },
          { id: "5.10.9", text: "No instalar slip-on joints en bodegas, tanques u otros espacios no accesibles; dentro de tanques solo si el medio es el mismo." },
          { id: "5.10.10", text: "Los slip type joints no deben emplearse como medio principal de unión, salvo cuando se requieran para absorber deformaciones axiales." },
          { id: "5.10.11", text: "En buques tanque (oil/chemical), se permiten restrained slip-on joints en líneas de vapor con P ≤ 10 bar en cubierta expuesta para absorber movimiento axial." },
          { id: "5.10.12", text: "Las juntas mecánicas deben someterse a los ensayos de tipo del LR Type Approval Test Spec. No. 2 según la aplicación prevista." },
        ],
        GENERAL_COMMENTS: {
          slipOnInaccessible: "5.10.9: Slip‑on joints no en bodegas/tanques o espacios no accesibles; dentro de tanques solo si el medio es el mismo.",
          slipOnNotMain: "5.10.10: El tipo Slip no debe usarse como medio principal de conexión (salvo compensación axial).",
          burstPressure: "5.10.5: Las juntas mecánicas deben resistir presión de rotura ≥ 4 × presión de diseño.",
          typeApproval: "5.10.12: Ensayos de tipo conforme a LR Type Approval Test Spec No. 2, según servicio.",
          hullSide: "5.10.6: Si el tramo está conectado directamente al costado por debajo del límite de integridad estanca, las juntas mecánicas están prohibidas.",
          steamDeck: "5.10.11: En buques tanque (oil/chemical), permitido 'restrained slip‑on' para vapor ≤ 10 bar en cubierta expuesta para absorber movimiento axial.",
        },
        SYSTEMS: [
          { id: "ff_le60_aircraft_vehicle_fuel", group: "Flammable fluids (flash point ≤ 60°C)", system: "Aircraft and vehicle fuel oil lines", mediumGroup: "flammable_liquids", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "30 min dry (*)", notes: ["Notes 2 & 4"] },
          { id: "ff_le60_vent_lines", group: "Flammable fluids (flash point ≤ 60°C)", system: "Vent lines", mediumGroup: "flammable_liquids", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "30 min dry (*)", notes: ["Notes 2 & 3"] },
          { id: "ff_gt60_aircraft_vehicle_fuel", group: "Flammable fluids (flash point > 60°C)", system: "Aircraft and vehicle fuel oil lines", mediumGroup: "flammable_liquids", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "30 min dry (*)", notes: ["Notes 2 & 4"] },
          { id: "ff_gt60_ship_machinery_fuel", group: "Flammable fluids (flash point > 60°C)", system: "Ship’s machinery fuel oil lines", mediumGroup: "flammable_liquids", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "30 min wet (*)", notes: ["Notes 2 & 3"] },
          { id: "ff_gt60_lubricating_oil", group: "Flammable fluids (flash point > 60°C)", system: "Lubricating oil lines", mediumGroup: "flammable_liquids", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "30 min wet (*)", notes: ["Notes 2 & 3"] },
          { id: "ff_gt60_hydraulic_oil", group: "Flammable fluids (flash point > 60°C)", system: "Hydraulic oil", mediumGroup: "flammable_liquids", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "30 min wet (*)", notes: ["Notes 2 & 3"] },
          { id: "sw_bilge", group: "Sea water", system: "Bilge lines", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry/wet", fireTest: "8 min dry + 22 min wet (*)", notes: ["Note 1"] },
          { id: "sw_hp_spray", group: "Sea water", system: "HP sea water and water spray (not permanently filled)", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry/wet", fireTest: "8 min dry + 22 min wet (*)" },
          { id: "sw_perm_fireext", group: "Sea water", system: "Permanent water filled fire‑extinguishing systems (fire main, sprinklers)", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "30 min wet (*)", notes: ["Note 3"] },
          { id: "sw_nonperm_fireext", group: "Sea water", system: "Non‑permanent water filled fire‑extinguishing systems (foam, drencher, fire main)", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry/wet", fireTest: "8 min dry + 22 min wet (*) – Foam: comply FSS Code", notes: ["Note 3"] },
          { id: "sw_ballast", group: "Sea water", system: "Ballast system", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "8 min dry + 22 min wet (*)", notes: ["Note 1"] },
          { id: "sw_cooling", group: "Sea water", system: "Cooling water system", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "8 min dry + 22 min wet (*)", notes: ["Note 1"] },
          { id: "sw_tank_cleaning", group: "Sea water", system: "Tank cleaning services", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "Fire endurance test not required" },
          { id: "sw_non_essential", group: "Sea water", system: "Non‑essential systems", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "Fire endurance test not required" },
          { id: "fw_cooling", group: "Fresh water", system: "Cooling water system", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "Fire endurance test not required", notes: ["Note 1"] },
          { id: "fw_chilled", group: "Fresh water", system: "Chilled water system", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "Except chilled water: 30 min wet (*)", notes: ["Note 1"] },
          { id: "fw_condensate", group: "Fresh water", system: "Condensate return", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "Fire endurance test not required", notes: ["Note 1"] },
          { id: "fw_made_demin", group: "Fresh water", system: "Made & demineralised water system", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "Fire endurance test not required" },
          { id: "fw_ancillary", group: "Fresh water", system: "Ancillary system", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "Fire endurance test not required" },
          { id: "san_deck_drains", group: "Sanitary / drains / scuppers", system: "Deck drains (internal)", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "Fire endurance test not required", notes: ["Note 6"] },
          { id: "san_sanitary_drains", group: "Sanitary / drains / scuppers", system: "Sanitary drains", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "Fire endurance test not required" },
          { id: "san_scuppers_overboard", group: "Sanitary / drains / scuppers", system: "Scuppers & discharge (overboard)", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: false }, pipeSystemClass: "dry", fireTest: "Fire endurance test not required" },
          { id: "sv_water_tanks_dry", group: "Sounding / vent", system: "Water tanks / dry spaces", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry/wet", fireTest: "Fire endurance test not required" },
          { id: "sv_oil_tanks", group: "Sounding / vent", system: "Oil tanks (f.p. > 60°C)", mediumGroup: "flammable_liquids", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "Fire endurance test not required", notes: ["Notes 2 & 3"] },
          { id: "sv_intakes_uptakes", group: "Sounding / vent", system: "Intakes and uptakes", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "Fire endurance test not required", notes: ["Note 7"] },
          { id: "sv_hvac", group: "Sounding / vent", system: "HVAC trunking", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "Fire endurance test not required", notes: ["Note 7"] },
          { id: "misc_air_hp", group: "Miscellaneous", system: "High pressure (HP) air system", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "30 min dry (*)", notes: ["Note 1"] },
          { id: "misc_air_mp", group: "Miscellaneous", system: "Medium pressure (MP) air system", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "30 min dry (*)", notes: ["Note 1"] },
          { id: "misc_air_lp", group: "Miscellaneous", system: "Low pressure (LP) air system", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "Fire endurance test not required", notes: ["Note 1"] },
          { id: "misc_service_air_nonessential", group: "Miscellaneous", system: "Service air (non‑essential)", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "Fire endurance test not required" },
          { id: "misc_brine", group: "Miscellaneous", system: "Brine", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "Fire endurance test not required" },
          { id: "misc_co2", group: "Miscellaneous", system: "CO₂ system", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: false }, pipeSystemClass: "dry", fireTest: "30 min dry (*)", notes: ["Note 1"] },
          { id: "misc_n2", group: "Miscellaneous", system: "Nitrogen system", mediumGroup: "other_media", allowed: { pipeUnions: true, compression: true, slipOn: false }, pipeSystemClass: "dry", fireTest: "30 min dry (*)" },
          { id: "misc_steam", group: "Miscellaneous", system: "Steam", mediumGroup: "steam", allowed: { pipeUnions: true, compression: true, slipOn: false }, pipeSystemClass: "-", fireTest: "Fire endurance test not required", notes: ["See Note 5 / special consideration"] },
        ],
      },

      ships: {
        id: "ships",
        title: "LR Ships",
        subtitle:
          "Basado en LR Pt 5, Ch 12, 2.12 Other mechanical couplings. Tablas 12.2.8 y 12.2.9.",
        // 12.2.9 es igual a Naval: reutilizamos exactamente los mismos límites/clase/OD
        CLASS_LIMITS: null,

        // --- Notas de la Tabla 12.2.8 (en español, mismas etiquetas que Naval) ---
        TABLE_NOTES_ES: {
          "1": "Aplicar ensayo de resistencia al fuego cuando las juntas mecánicas se instalan en salas de bombas y cubiertas abiertas.",
          "2": "Las juntas slip-on no se aceptan dentro de espacios de máquinas de categoría A ni alojamientos. Pueden aceptarse en otros espacios de máquinas si están en posiciones visibles y accesibles (MSC/Circ.734).",
          "3": "Las juntas mecánicas deben ser de tipos resistentes al fuego aprobados, salvo cuando se instalan en cubiertas abiertas según SOLAS II-2/9.2.3.3.2.2(10), y no sean usadas para líneas de fuel oil.",
          "4": "Aplicar ensayo de resistencia al fuego cuando las juntas mecánicas se instalan dentro de espacios de máquinas de categoría A.",
          "5": "Solo por encima de la cubierta de mamparo de buques de pasaje.",
          "6": "Las juntas slip type (slip-on) como en Fig. 12.2.4/12.2.5 pueden usarse en tuberías en cubierta con presión de diseño ≤ 10 bar.",
          "7": "Equivalencia de ensayos: si pasa '30 min dry' sirve también para '8 min dry + 22 min wet' y/o '30 min wet'. Si pasa '8+22', sirve para '30 min wet'.",
          "8": "Ver Pt 5, Ch 12, 2.12.10. Para CO₂ en espacio protegido: materiales con punto de fusión > 925 °C (FSS Code, Cap. 5).",
        },

        // --- Recomendaciones y requisitos LR (texto 2.12.1 a 2.12.11) ---
        LR_REQUIREMENTS_ES: [
          { id: "2.12.1", text: "Uniones roscadas, acoples de compresión y slip-on pueden usarse si están Type Approved para el servicio y aplicación; la aprobación se basa en ensayos del propio modelo. Uso aceptable por servicio: Tabla 12.2.8. Límites de dimensiones por clase: Tabla 12.2.9." },
          { id: "2.12.2", text: "Si la aplicación reduce el espesor (p. ej., anillos bite), considerar esa reducción para cumplir la presión de diseño." },
          { id: "2.12.3", text: "Los materiales de las juntas deben ser compatibles con la tubería y con los medios interno/externo." },
          { id: "2.12.4", text: "Juntas para tuberías a presión: ensayo de reventón a 4 × la presión de diseño (≥20 MPa: a considerar especialmente)." },
          { id: "2.12.5", text: "No usar juntas mecánicas en tramos conectados al costado del buque bajo cubierta de mamparo o en tanques con fluidos inflamables cuando el daño pueda causar incendio o inundación." },
          { id: "2.12.6", text: "Las juntas deben soportar presión interna/externa y operar bajo vacío en líneas de succión cuando aplique." },
          { id: "2.12.7", text: "Minimizar el número de juntas mecánicas en sistemas de fluidos inflamables. En general, bridas según norma reconocida." },
          { id: "2.12.8", text: "En general, no usar slip-on en bodegas, tanques u otros espacios de difícil acceso; dentro de tanques solo si el medio es el mismo del tanque." },
          { id: "2.12.9", text: "No se permite usar slip type slip-on como medio principal de unión, salvo para compensar deformación axial de tuberías." },
          { id: "2.12.10", text: "Slip-on restringidas permitidas en vapor, P ≤ 1 MPa, en cubiertas a la intemperie de petroleros/quimiqueros para acomodar dilatación (ver Pt 5, Ch 13, 2.7)." },
          { id: "2.12.11", text: "Juntas mecánicas a ensayar conforme al LR Type Approval Test Spec. No. 2 para las condiciones de servicio previstas." },
        ],

        GENERAL_COMMENTS: {
          slipOnInaccessible: "2.12.8: No usar slip-on en bodegas, tanques u otros espacios de difícil acceso; dentro de tanques solo si el medio coincide.",
          slipOnNotMain: "2.12.9: No se permite usar slip type slip-on como medio principal de unión, salvo para compensar deformación axial.",
          burstPressure: "2.12.4: Las juntas mecánicas deben ensayarse a 4 × la presión de diseño.",
          typeApproval: "2.12.11: Ensayos conforme al LR Type Approval Test Spec. No. 2 para las condiciones de servicio previstas.",
          hullSide: "2.12.5: Evitar juntas mecánicas en conexiones al costado bajo cubierta de mamparo o en tanques con fluidos inflamables cuando el daño pueda causar incendio/inundación.",
          steamDeck: "2.12.10: Slip-on restringidas para vapor (P ≤ 1 MPa) en cubierta a la intemperie de petroleros/quimiqueros para acomodar dilatación.",
        },

        // --- Sistemas de la Tabla 12.2.8 (cada fila es un sistema) ---
        SYSTEMS: [
          // Flammable fluids (flash point ≤ 60°C)
          { id: "ff_le60_cargo_oil", group: "Fluidos inflamables (p.i. ≤ 60°C)", system: "Cargo oil lines", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "30 min dry (*)", notes: ["Nota 1"] },
          { id: "ff_le60_crude_oil_wash", group: "Fluidos inflamables (p.i. ≤ 60°C)", system: "Crude oil washing lines", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "30 min dry (*)", notes: ["Nota 1"] },
          { id: "ff_le60_vent", group: "Fluidos inflamables (p.i. ≤ 60°C)", system: "Vent lines", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "30 min dry (*)", notes: ["Nota 3"] },

          // Inert gas
          { id: "inert_effluent_water_seal", group: "Gas inerte", system: "Water seal effluent lines", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "30 min wet (*)" },
          { id: "inert_effluent_scrubber", group: "Gas inerte", system: "Scrubber effluent lines", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "30 min wet (*)" },
          { id: "inert_main", group: "Gas inerte", system: "Main lines", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "30 min dry (*)", notes: ["Notas 1 & 2"] },
          { id: "inert_distribution", group: "Gas inerte", system: "Distribution lines", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "30 min dry (*)", notes: ["Nota 1"] },

          // Flammable fluids (flash point > 60°C)
          { id: "ff_gt60_cargo_oil", group: "Fluidos inflamables (p.i. > 60°C)", system: "Cargo oil lines", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: "30 min dry (*)" },
          { id: "ff_gt60_fuel_oil", group: "Fluidos inflamables (p.i. > 60°C)", system: "Fuel oil lines", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "30 min wet (*)", notes: ["Notas 2 & 3"] },
          { id: "ff_gt60_lube_oil", group: "Fluidos inflamables (p.i. > 60°C)", system: "Lubricating oil lines", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "30 min wet (*)", notes: ["Notas 2 & 3"] },
          { id: "ff_gt60_hydraulic_oil", group: "Fluidos inflamables (p.i. > 60°C)", system: "Hydraulic oil lines", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "30 min wet (*)", notes: ["Notas 2 & 3"] },
          { id: "ff_gt60_thermal_oil", group: "Fluidos inflamables (p.i. > 60°C)", system: "Thermal oil", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "30 min wet (*)", notes: ["Notas 2 & 3"] },

          // Sea water
          { id: "sw_bilge", group: "Agua de mar", system: "Bilge lines", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry/wet", fireTest: "8 min dry + 22 min wet (*)", notes: ["Nota 4"] },
          { id: "sw_fire_perm", group: "Agua de mar", system: "Permanent water filled fire-extinguishing systems (fire main, sprinklers)", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "30 min wet (*)", notes: ["Nota 3"] },
          { id: "sw_fire_nonperm", group: "Agua de mar", system: "Non-permanent water filled fire-extinguishing systems (foam, drencher, fire main)", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry/wet", fireTest: "8 min dry + 22 min wet (*)", notes: ["Nota 3"], remarks: "Para sistemas de espuma aplicar FSS Code." },
          { id: "sw_ballast", group: "Agua de mar", system: "Ballast system", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "30 min wet (*)", notes: ["Nota 4"] },
          { id: "sw_cooling", group: "Agua de mar", system: "Cooling water system", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "30 min wet (*)", notes: ["Nota 4"] },
          { id: "sw_tank_cleaning", group: "Agua de mar", system: "Tank cleaning services", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: null, remarks: "No requiere ensayo de resistencia al fuego." },
          { id: "sw_non_essential", group: "Agua de mar", system: "Non-essential systems", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry / dry-wet / wet", fireTest: null, remarks: "No requiere ensayo de resistencia al fuego." },

          // Fresh water
          { id: "fw_cooling", group: "Agua dulce", system: "Cooling water system", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "30 min wet (*)", notes: ["Nota 4"] },
          { id: "fw_condensate_return", group: "Agua dulce", system: "Condensate return", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "30 min wet (*)", notes: ["Nota 4"] },
          { id: "fw_non_essential", group: "Agua dulce", system: "Non-essential system", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry / wet-dry / wet", fireTest: null, remarks: "No requiere ensayo de resistencia al fuego." },

          // Sanitary / drains / scuppers
          { id: "san_deck_drains_internal", group: "Saneamiento / desagües / imbornales", system: "Deck drains (internal)", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: null, notes: ["Nota 5"], remarks: "No requiere ensayo." },
          { id: "san_sanitary_drains", group: "Saneamiento / desagües / imbornales", system: "Sanitary drains", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: null, remarks: "No requiere ensayo." },
          { id: "san_scuppers_overboard", group: "Saneamiento / desagües / imbornales", system: "Scuppers and discharge (overboard)", allowed: { pipeUnions: true, compression: true, slipOn: false }, pipeSystemClass: "dry", fireTest: null, remarks: "No requiere ensayo." },

          // Sounding / vent
          { id: "sv_water_tanks_dry_spaces", group: "Sondaje / venteo", system: "Water tanks / dry spaces", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry, wet", fireTest: null, remarks: "No requiere ensayo." },
          { id: "sv_oil_tanks_gt60", group: "Sondaje / venteo", system: "Oil tanks (fp > 60°C)", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: null, notes: ["Notas 2 & 3"], remarks: "No requiere ensayo." },

          // Miscellaneous
          { id: "misc_starting_control_air", group: "Misceláneos", system: "Starting / control air", allowed: { pipeUnions: true, compression: true, slipOn: false }, pipeSystemClass: "dry", fireTest: "30 min dry (*)", notes: ["Nota 4"] },
          { id: "misc_service_air_non_essential", group: "Misceláneos", system: "Service air (non-essential)", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "dry", fireTest: null, remarks: "No requiere ensayo." },
          { id: "misc_brine", group: "Misceláneos", system: "Brine", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: "30 min wet (*)" },
          { id: "misc_co2_outside_protected", group: "Misceláneos", system: "CO₂ system (outside protected space)", allowed: { pipeUnions: true, compression: true, slipOn: false }, pipeSystemClass: "dry", fireTest: "30 min dry (*)" },
          { id: "misc_co2_inside_protected", group: "Misceláneos", system: "CO₂ system (inside protected space)", allowed: { pipeUnions: true, compression: true, slipOn: false }, pipeSystemClass: "dry", fireTest: null, remarks: "Materiales con punto de fusión > 925 °C. FSS Code, Cap. 5." },
          { id: "misc_steam", group: "Misceláneos", system: "Steam", allowed: { pipeUnions: true, compression: true, slipOn: true }, pipeSystemClass: "wet", fireTest: null, notes: ["Ver Nota 8"] },
        ],

        // Regla fina opcional (ejemplo): validar slip-on en “steam” según 2.12.10
        COUPLING_OVERRIDES: {
          slipOn: ({ base, sys, P_design_bar, location }) => {
            if (sys?.id !== "misc_steam") return base;
            const okP = (P_design_bar ?? 0) <= 10;
            const okLoc = location === "open_deck";
            return base && okP && okLoc;
          },
        },
      },
    };

    if (!RULESETS.ships.CLASS_LIMITS) {
      RULESETS.ships.CLASS_LIMITS = RULESETS.naval.CLASS_LIMITS;
    }
    // ---------------------------------------------------------------------------

    function App() {
      const getInitialRule = () => {
        const q = new URLSearchParams(location.search);
        return q.get("rule") || localStorage.getItem("rule") || "naval";
      };

      const [ruleId, setRuleId] = useState(getInitialRule);
      const activeRules = RULESETS[ruleId] || RULESETS.naval;

      useEffect(() => {
        localStorage.setItem("rule", ruleId);
      }, [ruleId]);

      const CLASS_LIMITS = activeRules.CLASS_LIMITS;
      const TABLE_NOTES_ES = activeRules.TABLE_NOTES_ES || {};
      const SYSTEMS = activeRules.SYSTEMS || [];
      const LR_REQUIREMENTS = activeRules.LR_REQUIREMENTS_ES || [];
      const GENERAL_COMMENTS = activeRules.GENERAL_COMMENTS || {};
      const ACTIVE_OVERRIDES = activeRules.COUPLING_OVERRIDES || {};

      const COUPLING_RULES = {
        pipeUnions: (clazz, odMM) => {
          if (clazz === "III") return { allowed: true, reason: "+ (sin límite de OD en Class III)" };
          const ok = odMM <= 60.3;
          return { allowed: ok, reason: ok ? "+ (OD ≤ 60,3 mm en Class I/II)" : "En Class I/II solo se permite OD ≤ 60,3 mm." };
        },
        compressionSubtypes: (clazz, odMM) => ({
          swage: clazz === "III",
          bite: clazz === "III" ? true : odMM <= 60.3,
          typical: clazz === "III" ? true : odMM <= 60.3,
          flared: clazz === "III" ? true : odMM <= 60.3,
          press: clazz === "III",
        }),
        slipOnSubtypes: (clazz) => ({
          machine_grooved: true,
          grip: clazz !== "I",
          slip: clazz !== "I",
        }),
      };

      const defaultSchedule = SCHEDULES_DN16_200.find((item) => Math.abs(item.od - 60.3) < 1e-6) || SCHEDULES_DN16_200[0] || SCHEDULES[0];
      const defaultOd = defaultSchedule ? defaultSchedule.od : 60.3;

      const [selectedSystemId, setSelectedSystemId] = useState(() => (SYSTEMS[0]?.id ?? null));
      const [classMode, setClassMode] = useState("manual");
      const [clazz, setClazz] = useState("II");
      const [odMM, setOdMM] = useState(defaultOd);
      const [designPressureBar, setDesignPressureBar] = useState(7.5);
      const [designTemperatureC, setDesignTemperatureC] = useState(25);
      const [space, setSpace] = useState("other_machinery");
      const [evaluation, setEvaluation] = useState(null);
      const [hasPendingChanges, setHasPendingChanges] = useState(false);
      const [viewer, setViewer] = useState(null);
      const [viewerImageSrc, setViewerImageSrc] = useState("");
      const [viewerImageStatus, setViewerImageStatus] = useState("idle");
      const viewerHistoryRef = useRef(false);

      useEffect(() => {
        if (!SYSTEMS.length) {
          setSelectedSystemId(null);
          return;
        }
        if (!SYSTEMS.some((item) => item.id === selectedSystemId)) {
          setSelectedSystemId(SYSTEMS[0]?.id ?? null);
        }
      }, [SYSTEMS, selectedSystemId]);

      const groupedSystems = useMemo(() => {
        const order = [];
        const byGroup = new Map();
        for (const item of SYSTEMS) {
          if (!byGroup.has(item.group)) {
            byGroup.set(item.group, []);
            order.push(item.group);
          }
          byGroup.get(item.group).push(item);
        }
        return { order, byGroup };
      }, [SYSTEMS]);

      const odSelectOptions = useMemo(() => SCHEDULES_DN16_200, []);

      function markPendingChanges() {
        setEvaluation(null);
        setHasPendingChanges(true);
      }

      function getSystemMediumGroup(sys) {
        if (!sys) return undefined;
        if (sys.mediumGroup) return sys.mediumGroup;
        const systemName = (sys.system || "").toLowerCase();
        const groupName = (sys.group || "").toLowerCase();
        if (systemName.includes("thermal oil")) return "thermal_oil";
        if (systemName.includes("steam") || groupName.includes("steam")) return "steam";
        if (groupName.includes("inflamable") || groupName.includes("flammable") || systemName.includes("oil")) {
          return "flammable_liquids";
        }
        return "other_media";
      }

      function suggestClass(mediumGroup, P, T) {
        const lim = mediumGroup ? CLASS_LIMITS[mediumGroup] : null;
        if (!lim) return "II";
        if (P > lim.classII.P || T > lim.classII.T) return "I";
        if (P > lim.classIII.P || T > lim.classIII.T) return "II";
        return "III";
      }

      function computeUsedClass(sys) {
        if (classMode === "manual") return clazz;
        return suggestClass(getSystemMediumGroup(sys), designPressureBar, designTemperatureC);
      }

      function expandSystemNotes(notes) {
        if (!notes) return [];
        const out = [];
        for (const n of notes) {
          const nums = n.match(/[0-9]+/g) || [];
          for (const code of nums) {
            if (TABLE_NOTES_ES[code]) out.push(`Nota ${code}: ${TABLE_NOTES_ES[code]}`);
          }
        }
        return out;
      }

      function buildComplianceNotes(sys, usedClass, catNotes) {
        const notes = [];
        if (sys.fireTest && !/not required/i.test(sys.fireTest)) {
          notes.push(`Requiere ensayo de resistencia al fuego: ${sys.fireTest}.`);
          notes.push("La junta seleccionada debe ser de tipo **resistente al fuego aprobado**.");
        } else {
          notes.push(`Ensayo de resistencia al fuego: **no requerido** (según la fila del sistema).`);
        }

        notes.push(...expandSystemNotes(sys.notes));

        if (sys.remarks) {
          notes.push(sys.remarks);
        }

        if (space === "other_machinery") {
          const note2 = TABLE_NOTES_ES["2"];
          if (note2) {
            const noteText = `Nota 2: ${note2}`;
            if (!catNotes.includes(noteText)) notes.push(noteText);
          }
        }

        if (["cargo_hold", "tank"].includes(space) && GENERAL_COMMENTS.slipOnInaccessible) {
          if (!catNotes.includes(GENERAL_COMMENTS.slipOnInaccessible)) {
            notes.push(GENERAL_COMMENTS.slipOnInaccessible);
          }
        }

        if (GENERAL_COMMENTS.slipOnNotMain) notes.push(GENERAL_COMMENTS.slipOnNotMain);
        if (GENERAL_COMMENTS.burstPressure) notes.push(GENERAL_COMMENTS.burstPressure);
        if (GENERAL_COMMENTS.typeApproval) notes.push(GENERAL_COMMENTS.typeApproval);
        if (GENERAL_COMMENTS.hullSide) notes.push(GENERAL_COMMENTS.hullSide);

        const mediumGroup = getSystemMediumGroup(sys);
        const isSteam = (sys.system || "").toLowerCase() === "steam" || mediumGroup === "steam";
        if (GENERAL_COMMENTS.steamDeck && isSteam) {
          if (designPressureBar <= 10 && space === "open_deck") {
            notes.push(GENERAL_COMMENTS.steamDeck);
          } else {
            notes.push(`${GENERAL_COMMENTS.steamDeck} (verifica P ≤ 10 bar y ubicación en cubierta expuesta).`);
          }
        }

        notes.push(...catNotes);
        return notes;
      }

      function syncViewerFromHash() {
        const kind = parseViewerHash(window.location.hash);
        if (kind) {
          setViewer({ open: true, kind, title: buildViewerTitle(kind) });
        } else {
          setViewer(null);
          viewerHistoryRef.current = false;
        }
      }

      function handleOpenViewer(kind) {
        if (!kind) return;
        const targetHash = `#view:${kind}`;
        const basePath = `${window.location.pathname}${window.location.search}`;
        const newUrl = `${basePath}${targetHash}`;
        if (viewer?.open) {
          history.replaceState(null, "", newUrl);
        } else {
          history.pushState(null, "", newUrl);
          viewerHistoryRef.current = true;
        }
        syncViewerFromHash();
      }

      function handleCloseViewer() {
        if (!viewer?.open) return;
        const expectedHash = viewer?.kind ? `#view:${viewer.kind}` : null;
        if (expectedHash && viewerHistoryRef.current && window.location.hash === expectedHash && window.history.length > 1) {
          history.back();
        } else {
          const baseUrl = `${window.location.pathname}${window.location.search}`;
          history.replaceState(null, "", baseUrl);
          syncViewerFromHash();
        }
      }

      useEffect(() => {
        const handleLocationChange = () => syncViewerFromHash();
        handleLocationChange();
        window.addEventListener("hashchange", handleLocationChange);
        window.addEventListener("popstate", handleLocationChange);
        return () => {
          window.removeEventListener("hashchange", handleLocationChange);
          window.removeEventListener("popstate", handleLocationChange);
        };
      }, []);

      useEffect(() => {
        if (!(viewer?.open && viewer.kind)) {
          setViewerImageStatus("idle");
          setViewerImageSrc("");
          return;
        }

        let cancelled = false;
        const desiredSrc = JOINT_IMAGES[viewer.kind] || DEFAULT_JOINT_IMAGE;
        setViewerImageStatus("loading");

        const loader = new Image();
        loader.src = desiredSrc;
        loader.onload = () => {
          if (!cancelled) {
            setViewerImageSrc(desiredSrc);
            setViewerImageStatus("loaded");
          }
        };
        loader.onerror = () => {
          if (cancelled) return;
          if (desiredSrc === DEFAULT_JOINT_IMAGE) {
            setViewerImageSrc(DEFAULT_JOINT_IMAGE);
            setViewerImageStatus("error");
            return;
          }

          const fallbackSrc = DEFAULT_JOINT_IMAGE;
          const fallbackImg = new Image();
          fallbackImg.src = fallbackSrc;
          fallbackImg.onload = () => {
            if (!cancelled) {
              setViewerImageSrc(fallbackSrc);
              setViewerImageStatus("loaded");
            }
          };
          fallbackImg.onerror = () => {
            if (!cancelled) {
              setViewerImageSrc(fallbackSrc);
              setViewerImageStatus("error");
            }
          };
        };

        return () => {
          cancelled = true;
        };
      }, [viewer]);

      useEffect(() => {
        if (!viewer?.open) return;
        const handleKeyDown = (event) => {
          if (event.key === "Escape") {
            handleCloseViewer();
          }
        };
        window.addEventListener("keydown", handleKeyDown);
        return () => window.removeEventListener("keydown", handleKeyDown);
      }, [viewer?.open, viewer?.kind]);

      function evaluate() {
        const sys = SYSTEMS.find((s) => s.id === selectedSystemId) || SYSTEMS[0];
        const usedClass = computeUsedClass(sys);
        const mediumGroup = getSystemMediumGroup(sys);

        const base = { ...sys.allowed };

        const allowAfterLocation = { ...base };
        const catNotes = [];
        const odDisplay = Number.isFinite(odMM)
          ? odMM.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 1 })
          : odMM;

        if (["category_a", "accommodation", "munition_store"].includes(space)) {
          allowAfterLocation.slipOn = false;
          const note2 = TABLE_NOTES_ES["2"];
          catNotes.push(note2 ? `Nota 2: ${note2}` : "Slip-on bloqueado por la ubicación seleccionada.");
        }
        if (["cargo_hold", "tank"].includes(space)) {
          allowAfterLocation.slipOn = false;
          if (GENERAL_COMMENTS.slipOnInaccessible) {
            catNotes.push(GENERAL_COMMENTS.slipOnInaccessible);
          }
        }

        const applyOverride = (key, current) => {
          const handler = typeof ACTIVE_OVERRIDES[key] === "function" ? ACTIVE_OVERRIDES[key] : null;
          if (!handler) return current;
          return handler({
            base: current,
            sys,
            usedClass,
            P_design_bar: designPressureBar,
            T_design_C: designTemperatureC,
            location: space,
          });
        };

        allowAfterLocation.pipeUnions = applyOverride("pipeUnions", allowAfterLocation.pipeUnions);
        allowAfterLocation.compression = applyOverride("compression", allowAfterLocation.compression);
        allowAfterLocation.slipOn = applyOverride("slipOn", allowAfterLocation.slipOn);

        let pipeUnionsAllowed = allowAfterLocation.pipeUnions;
        let pipeUnionsRule = { allowed: false, reason: "" };
        if (pipeUnionsAllowed) {
          pipeUnionsRule = COUPLING_RULES.pipeUnions(usedClass, odMM);
          pipeUnionsAllowed = pipeUnionsAllowed && pipeUnionsRule.allowed;
          if (!pipeUnionsRule.allowed) catNotes.push(pipeUnionsRule.reason);
        }

        let compressionAllowed = allowAfterLocation.compression;
        let compressionSubs = { swage: false, bite: false, typical: false, flared: false, press: false };
        if (compressionAllowed) {
          compressionSubs = COUPLING_RULES.compressionSubtypes(usedClass, odMM);
          const anySub = Object.values(compressionSubs).some(Boolean);
          compressionAllowed = compressionAllowed && anySub;
          if (!anySub) catNotes.push(`En Class ${usedClass}${usedClass !== "III" ? ` y OD ${odDisplay} mm` : ""} no queda ningún subtipo de compresión permitido.`);
          if (usedClass !== "III" && odMM > 60.3) catNotes.push("En Class I/II, Bite/Typical/Flared solo hasta OD 60,3 mm.");
          if (usedClass !== "III") catNotes.push("Swage/Press solo en Class III.");
        }

        let slipOnAllowed = allowAfterLocation.slipOn;
        let slipOnSubs = { machine_grooved: false, grip: false, slip: false };
        if (slipOnAllowed) {
          slipOnSubs = COUPLING_RULES.slipOnSubtypes(usedClass);
          const anySub = Object.values(slipOnSubs).some(Boolean);
          slipOnAllowed = slipOnAllowed && anySub;
          if (!slipOnSubs.grip || !slipOnSubs.slip) catNotes.push("Grip/Slip no se permiten en Class I.");
        }

        const categories = { pipeUnions: pipeUnionsAllowed, compression: compressionAllowed, slipOn: slipOnAllowed };

        const details = {
          pipeUnionsRule,
          compressionSubs,
          slipOnSubs,
          odMM,
          design: { P: designPressureBar, T: designTemperatureC },
          classMode,
          suggestedClass: suggestClass(mediumGroup, designPressureBar, designTemperatureC),
          mediumGroup,
        };

        const reasons = [];
        if (!categories.slipOn && base.slipOn)
          reasons.push("Slip-on permitido por la tabla base, pero bloqueado por ubicación, clase u otras condiciones del reglamento.");

        setEvaluation({ sys, usedClass, categories, reasons, details, notes: buildComplianceNotes(sys, usedClass, catNotes) });
        setHasPendingChanges(false);
      }

      const sys = SYSTEMS.find((s) => s.id === selectedSystemId) || SYSTEMS[0];
      const usedClass = computeUsedClass(sys);

      const allNotes = Array.isArray(evaluation?.notes) ? evaluation.notes : [];
      const notasSistema = allNotes.filter((n) => /^Nota\s*\d+/i.test(n));
      const notasLR = allNotes
        .filter((n) => !/^Nota\s*\d+/i.test(n))
        .map((n) => stripNormReferencePrefix(n));

      const currentMediumGroup = evaluation?.details?.mediumGroup ?? getSystemMediumGroup(sys);
      const currentMediumLimits = currentMediumGroup ? CLASS_LIMITS[currentMediumGroup] : null;

      return html`<div className="min-h-screen bg-gradient-to-b from-slate-900 to-slate-800 text-slate-100">

          <header className="max-w-7xl mx-auto px-4 py-6 w-full">
            <div className="page-header">
              <div className="header-copy md:max-w-3xl text-left">
                <h1 className="text-3xl md:text-4xl font-semibold tracking-tight text-slate-100">
                  Asesor de juntas mecánicas – Grip Type
                </h1>
                <p className="sublead block-subtitle text-slate-300">
                  ${activeRules.subtitle || "Selecciona un reglamento para ver la descripción."}
                </p>
                <p className="text-sm text-slate-400">
                  Reglamento activo: <strong>${activeRules.title}</strong>
                </p>
                <div className="hidden md:flex items-center gap-2 text-sm text-slate-300 logic-hint">
                  ${h(ShieldIcon, { className: "w-5 h-5" })}
                  <span>Con notas en español.</span>
                </div>
                <p className="text-xs text-slate-300 md:hidden text-left logic-hint">
                  Con notas en español.
                </p>
              </div>
              <div className="header-brand">
                <img src="assets/joints/cotec.jpg" alt="COTECMAR" id="logoCotecmar" />
              </div>
            </div>
          </header>

        <main className="max-w-7xl mx-auto p-4 space-y-6">
          <section className="bg-slate-950/40 rounded-2xl p-4 shadow space-y-4">
            <div className="grid md:grid-cols-3 gap-4">
              <${Field} label="Reglamento">
                <select
                  className="w-full bg-slate-800 border border-slate-600 rounded-xl px-3 py-2"
                  value=${ruleId}
                  onChange=${(e) => {
                    const v = e.target.value;
                    if (v === ruleId) return;
                    setRuleId(v);
                    setSelectedSystemId(null);
                    setEvaluation(null);
                    setHasPendingChanges(true);
                    const q = new URLSearchParams(location.search);
                    q.set("rule", v);
                    history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
                  }}
                >
                  <option value="naval">LR Naval Ships</option>
                  <option value="ships">LR Ships</option>
                </select>
              </${Field}>
              <${Field} label="Sistema">
                <select
                  id="select-system"
                  className="w-full bg-slate-800 border border-slate-600 rounded-xl px-3 py-2"
                  value=${selectedSystemId}
                  onChange=${(e) => {
                    const value = e.target.value;
                    if (value === selectedSystemId) return;
                    setSelectedSystemId(value);
                    markPendingChanges();
                  }}
                >
                  ${groupedSystems.order.map(
                    (groupKey) => html`<optgroup key=${groupKey} label=${tGroup(groupKey)}>
                      ${groupedSystems.byGroup
                        .get(groupKey)
                        .map((item) => html`<option key=${item.id} value=${item.id}>${tSystem(item)}</option>`)}
                    </optgroup>`
                  )}
                </select>
              </${Field}>
              <${Field} label="Espacio / Ubicación">
                <select
                  id="select-space"
                  className="w-full bg-slate-800 border border-slate-600 rounded-xl px-3 py-2"
                  value=${space}
                  onChange=${(e) => {
                    const value = e.target.value;
                    if (value === space) return;
                    setSpace(value);
                    markPendingChanges();
                  }}
                >
                  ${SPACES_KEYS.map((key) => html`<option key=${key} value=${key}>${tSpace(key)}</option>`)}
                </select>
              </${Field}>
            </div>

            <div className="grid md:grid-cols-2 gap-4">
              <${Field} label="Modo de clase">
                <div className="flex items-center gap-3">
                  <button
                    onClick=${() => {
                      if (classMode === "manual") return;
                      setClassMode("manual");
                      markPendingChanges();
                    }}
                    className=${`px-3 py-1 rounded-full border ${classMode === "manual" ? "bg-slate-700 border-slate-500" : "border-slate-600"}`}
                  >
                    Seleccionar clase
                  </button>
                  <button
                    onClick=${() => {
                      if (classMode === "auto") return;
                      setClassMode("auto");
                      markPendingChanges();
                    }}
                    className=${`px-3 py-1 rounded-full border ${classMode === "auto" ? "bg-slate-700 border-slate-500" : "border-slate-600"}`}
                  >
                    Calcular por P/T
                  </button>
                  <span className="text-xs text-slate-400">Class I es la más exigente; usa AUTO si quieres derivarla desde P/T.</span>
                </div>
              </${Field}>
              ${
                classMode === "manual"
                  ? html`<${Field} label="Clase de tubería">
                      <select
                        className="w-full bg-slate-800 border border-slate-600 rounded-xl px-3 py-2"
                        value=${clazz}
                        onChange=${(e) => {
                          const value = e.target.value;
                          if (value === clazz) return;
                          setClazz(value);
                          markPendingChanges();
                        }}
                      >
                        <option value="I">Class I</option>
                        <option value="II">Class II</option>
                        <option value="III">Class III</option>
                      </select>
                    </${Field}>`
                  : html`<div className="grid grid-cols-2 gap-3">
                      <${Field} label="P diseño [bar]">
                        <input
                          type="number"
                          step="0.1"
                          className="w-full bg-slate-800 border border-slate-600 rounded-xl px-3 py-2"
                          value=${designPressureBar}
                          onChange=${(e) => {
                            const value = Number(e.target.value);
                            if (value === designPressureBar) return;
                            setDesignPressureBar(value);
                            markPendingChanges();
                          }}
                        />
                      </${Field}>
                      <${Field} label="T diseño [°C]">
                        <input
                          type="number"
                          className="w-full bg-slate-800 border border-slate-600 rounded-xl px-3 py-2"
                          value=${designTemperatureC}
                          onChange=${(e) => {
                            const value = Number(e.target.value);
                            if (value === designTemperatureC) return;
                            setDesignTemperatureC(value);
                            markPendingChanges();
                          }}
                        />
                      </${Field}>
                    </div>`
              }
            </div>

            <div className="grid md:grid-cols-1 gap-4">
              <${Field} label="Diámetro nominal – OD [mm]">
                <div className="max-w-sm">
                  <select
                    className="w-full bg-slate-800 border border-slate-600 rounded-xl px-3 py-2"
                    value=${odMM != null ? String(odMM) : ""}
                    onChange=${(e) => {
                      const value = e.target.value;
                      if (value === "") return;
                      const numeric = Number(value);
                      if (numeric === odMM) return;
                      setOdMM(numeric);
                      markPendingChanges();
                    }}
                  >
                    <option value="" disabled>Selecciona DN / OD</option>
                    ${odSelectOptions.map((option) =>
                      html`<option key=${option.od} value=${option.od}>${option.label}</option>`
                    )}
                  </select>
                </div>
              </${Field}>
            </div>

            <div className="flex flex-wrap items-center gap-3">
              <button onClick=${evaluate} className="inline-flex items-center gap-2 bg-emerald-400 text-emerald-950 font-semibold px-3 py-2 rounded-xl hover:bg-emerald-300">
                ${h(SearchIcon, { className: "w-4 h-4" })} Evaluar
              </button>
              <div className="text-xs text-slate-300">
                Clase utilizada ahora: <b>Class ${usedClass}</b>
                ${
                  classMode === "auto"
                    ? `(calculada por P/T para ${evaluation?.details?.mediumGroup ?? getSystemMediumGroup(sys) ?? "medio no definido"})`
                    : ""
                }
              </div>
            </div>
          </section>

          <section className="bg-slate-950/40 rounded-2xl p-4 shadow space-y-4">
            ${
              !evaluation
                ? (hasPendingChanges
                    ? html`<p className="text-slate-400 text-sm mt-1">Cambiaste un parámetro. Presiona <strong>Evaluar</strong> para actualizar el resultado.</p>`
                    : html`<p className="text-slate-400 text-sm">Configura y pulsa Evaluar para ver las uniones permitidas y notas normativas (en español).</p>`)
                : html`<div className="space-y-4">
                    <div className="text-sm text-slate-300">
                      Sistema: <b>${tGroup(evaluation.sys.group)} → ${tSystem(evaluation.sys)}</b> · Condición del sistema: <b>${evaluation.sys.pipeSystemClass}</b> · Ensayo de fuego: <b>${evaluation.sys.fireTest}</b>
                    </div>

                    <div className="result-row">
                      <${CategoryCard}
                        title="Pipe unions"
                        allowed=${evaluation.categories.pipeUnions}
                        details=${evaluation.details.pipeUnionsRule?.reason}
                        items=${[
                          {
                            id: "pipe_welded_brazed",
                            system: "Welded and Brazed Types",
                            kind: "pipe_welded_brazed",
                            available: evaluation.categories.pipeUnions,
                            disabled: !evaluation.categories.pipeUnions,
                          },
                        ]}
                        onView=${handleOpenViewer}
                      />

                      <${CategoryCard}
                        title="Compression couplings"
                        allowed=${evaluation.categories.compression}
                        details=${evaluation.categories.compression ? "Subtipos según clase y OD" : "Sin subtipos válidos con la clase/OD"}
                        items=${[
                          {
                            id: "compression_swage",
                            system: "Swage Type",
                            kind: "compression_swage",
                            available: evaluation.details.compressionSubs.swage,
                            disabled: !evaluation.details.compressionSubs.swage,
                          },
                          {
                            id: "compression_press",
                            system: "Press Type",
                            kind: "compression_press",
                            available: evaluation.details.compressionSubs.press,
                            disabled: !evaluation.details.compressionSubs.press,
                          },
                          {
                            id: "compression_typical",
                            system: "Typical Compression Type",
                            kind: "compression_typical",
                            available: evaluation.details.compressionSubs.typical,
                            disabled: !evaluation.details.compressionSubs.typical,
                          },
                          {
                            id: "compression_bite",
                            system: "Bite Type",
                            kind: "compression_bite",
                            available: evaluation.details.compressionSubs.bite,
                            disabled: !evaluation.details.compressionSubs.bite,
                          },
                          {
                            id: "compression_flared",
                            system: "Flared Type",
                            kind: "compression_flared",
                            available: evaluation.details.compressionSubs.flared,
                            disabled: !evaluation.details.compressionSubs.flared,
                          },
                        ]}
                        onView=${handleOpenViewer}
                      />

                      <${CategoryCard}
                        title="Slip-on Joints"
                        allowed=${evaluation.categories.slipOn}
                        details=${evaluation.categories.slipOn ? "Machine‑grooved / Grip / Slip" : "Bloqueado por ubicación o clase"}
                        items=${[
                          {
                            id: "slip_machine_grooved",
                            system: "Machine Grooved Type",
                            kind: "slip_machine_grooved",
                            available: evaluation.details.slipOnSubs.machine_grooved,
                            disabled: !evaluation.details.slipOnSubs.machine_grooved,
                          },
                          {
                            id: "slip_grip",
                            system: "Grip Type",
                            kind: "slip_grip",
                            available: evaluation.details.slipOnSubs.grip,
                            disabled: !evaluation.details.slipOnSubs.grip,
                          },
                          {
                            id: "slip_slip",
                            system: "Slip Type",
                            kind: "slip_slip",
                            available: evaluation.details.slipOnSubs.slip,
                            disabled: !evaluation.details.slipOnSubs.slip,
                          },
                        ]}
                        onView=${handleOpenViewer}
                      />
                    </div>

                    <section className="notes">
                      <details open>
                        <summary className="notes-title">Notas específicas del sistema</summary>
                        <ul className="notes-list">
                          ${notasSistema.length
                            ? notasSistema.map((n, i) => html`<li key=${`sys-${i}`}>${n}</li>`)
                            : html`<li>No aplica.</li>`}
                        </ul>
                      </details>

                      <details>
                        <summary className="notes-title">Observaciones adicionales (evaluación)</summary>
                        <ul className="notes-list">
                          ${notasLR.length
                            ? notasLR.map((n, i) => html`<li key=${`lr-${i}`}>${n}</li>`)
                            : html`<li>Sin notas adicionales.</li>`}
                        </ul>
                      </details>
                    </section>

                    ${
                      LR_REQUIREMENTS.length > 0
                        ? html`<section className="mt-6">
                            <h3 className="text-lg font-semibold text-slate-100">
                              Recomendaciones y requisitos LR
                            </h3>
                            <ul className="mt-2 space-y-1 text-slate-300 text-sm">
                              ${LR_REQUIREMENTS.map((item) =>
                                html`<li key=${item.id}><strong>${item.id}.</strong> ${item.text}</li>`
                              )}
                            </ul>
                          </section>`
                        : ""
                    }

                    <div className="text-xs text-slate-400">
                      ${
                        currentMediumGroup && currentMediumLimits
                          ? html`Grupo de medio: <b>${currentMediumGroup}</b>. Límites Class II: P≤${currentMediumLimits.classII.P}
                              bar / T≤${currentMediumLimits.classII.T} °C; Class III: P≤${currentMediumLimits.classIII.P} bar /
                              T≤${currentMediumLimits.classIII.T} °C. Si P/T superan Class II, norma exige Class I (2.3.2).`
                          : html`Límites de clase: aplicar la Tabla 12.2.9 del reglamento activo para determinar las
                              condiciones de presión y temperatura por clase.`
                      }
                    </div>
                  </div>`
            }
          </section>

          <footer className="pb-10 text-xs text-slate-400 text-center space-y-2">
            <p>
              Por Jhon Eric Gomez - DVMPR-GEDIN<br />
              Para consultas contactar a: <a href="mailto:jegomez@cotecmar.com" className="text-sky-300 hover:text-sky-100">jegomez@cotecmar.com</a>.
            </p>
            <div>
              v0.7 • ${activeRules.title} – Motor de decisión con notas en español y visor de referencias gráficas (imágenes) por
              tipo de unión.
            </div>
          </footer>
        </main>

        ${
          viewer?.open
            ? html`<div className="fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4" onClick=${handleCloseViewer}>
                <div className="bg-slate-900 border border-slate-700 rounded-2xl p-4 max-w-2xl w-full" onClick=${(e) => e.stopPropagation()}>
                  <div className="flex items-center mb-3">
                    <h3 className="text-lg font-semibold">${viewer.title}</h3>
                    <button className="ml-auto px-3 py-1 rounded-lg bg-slate-800 border border-slate-600" onClick=${handleCloseViewer}>
                      Cerrar
                    </button>
                  </div>
                  <div className="bg-slate-800 rounded-xl p-4 flex items-center justify-center min-h-[280px]">
                    ${
                      viewerImageStatus === "loading" || viewerImageStatus === "idle"
                        ? html`<div className="text-sm text-slate-300 animate-pulse">Cargando imagen...</div>`
                        : html`<img
                            src=${viewerImageSrc || DEFAULT_JOINT_IMAGE}
                            alt=${JOINT_LABELS[viewer.kind] || viewer.title || "Joint reference"}
                            className="max-h-[70vh] w-full object-contain rounded-lg"
                          />`
                    }
                  </div>
                  ${
                    viewerImageStatus === "error"
                      ? html`<div className="text-xs text-rose-300 mt-2">No se encontró una imagen específica; se muestra la referencia genérica.</div>`
                      : html`<div className="text-xs text-slate-400 mt-2">Referencia fotográfica para el tipo de unión seleccionado.</div>`
                  }
                </div>
              </div>`
            : ""
        }
      </div>`;
    }

    function cleanLabel(text) {
      return typeof text === "string" ? text.replace(/\s*\((Tabla|Table)[^)]+\)/gi, "") : text;
    }

    function stripNormReferencePrefix(text) {
      if (typeof text !== "string") return text;
      return text.replace(/^\s*(?:\d+(?:\.\d+)*)(?:\s*[:.\-–]\s*|\s+-\s*)?/, "").trim();
    }

    function Field({ label, children }) {
      const displayLabel = cleanLabel(label);
      return html`<label className="block text-sm">
        <div className="mb-1 text-slate-300">${displayLabel}</div>
        ${children}
      </label>`;
    }

    function CategoryCard({ title, allowed, details, items, onView }) {
      const { es: titleEs, en: titleEn } = biTitle(title);
      const subtitleText = `${allowed ? "Se puede usar" : "No se puede usar"}${details ? ` • ${details}` : ""}`;
      const listItems = Array.isArray(items) ? items : [];
      const cardIds = {
        "Pipe unions": "card-PIPE",
        "Compression couplings": "card-COMPRESSION",
        "Slip-on Joints": "card-SLIP",
      };
      const cardId = cardIds[title];
      const cardStateClass = allowed ? " result-card--allowed card-allowed" : " result-card--blocked card-denied";

      return html`<div className=${`result-card${cardStateClass}`} id=${cardId || undefined}>
        <div className="result-header" aria-live="polite">
          <span className="result-title-es">${titleEs}</span>
          <span className="result-title-en">(${titleEn})</span>
        </div>
        <div className="block-subtitle">${subtitleText}</div>
        <div className="result-body">
          <ul className="option-list">
            ${listItems.map((item, idx) => {
              const { es, en } = biLabel(item);
              const optionId = item.id ?? item.kind ?? idx;
              const isDisabled = item.disabled === true || item.available === false;
              return html`<li key=${optionId} className=${`option-item${isDisabled ? " disabled" : ""}`}>
                <div className="option-text">
                  <span className="option-es">${es}</span>
                  <span className="option-en">(${en})</span>
                </div>
                <div className="option-actions">
                  <button
                    type="button"
                    className="chip"
                    data-id=${optionId}
                    disabled=${isDisabled}
                    onClick=${() => onView(item.kind)}
                  >
                    ver
                  </button>
                </div>
              </li>`;
            })}
          </ul>
        </div>
      </div>`;
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(h(App));
  </script>
</body>
</html>
