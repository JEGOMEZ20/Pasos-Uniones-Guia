<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Compatibilidad de tuberías a través de tanques · Norma cerrada</title>
<style>
  :root {
    --bg: #0f172a;
    --bg-soft: #1e293b;
    --bg-card: rgba(15, 23, 42, 0.82);
    --surface: rgba(15, 23, 42, 0.6);
    --ink: #e2e8f0;
    --ink-soft: rgba(226, 232, 240, 0.76);
    --mut: rgba(148, 163, 184, 0.7);
    --border: rgba(148, 163, 184, 0.18);
    --accent: #38bdf8;
    --accent-2: #a855f7;
    --ok: #22c55e;
    --bad: #f43f5e;
    --warn: #f59e0b;
  }
  * { box-sizing: border-box; }
  html, body {
    margin: 0;
    min-height: 100%;
    background: radial-gradient(circle at top, #1e293b 0%, #0f172a 55%, #020617 100%);
    color: var(--ink);
    font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
  }
  a { color: inherit; }
  .wrap {
    max-width: 1120px;
    margin: 0 auto;
    padding: 48px 24px 64px;
  }
  nav { margin-bottom: 28px; }
  nav a {
    color: var(--accent);
    text-decoration: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: color 0.2s ease;
  }
  nav a:hover { color: #7dd3fc; }
  h1 {
    font-size: clamp(26px, 4vw, 38px);
    margin: 0 0 12px;
    letter-spacing: -0.01em;
  }
  .small {
    font-size: 14px;
    color: var(--ink-soft);
    margin: 0 0 24px;
    max-width: 720px;
    line-height: 1.6;
  }
  .grid {
    display: grid;
    grid-template-columns: minmax(0, 1.05fr) minmax(0, 1fr);
    gap: 26px;
    align-items: start;
  }
  .card {
    background: var(--bg-card);
    border-radius: 26px;
    border: 1px solid var(--border);
    padding: 28px;
    box-shadow: 0 20px 45px rgba(2, 6, 23, 0.55);
    backdrop-filter: blur(16px);
  }
  .card.result { position: sticky; top: 32px; }
  .row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }
  .row.row--spaced { margin-top: 18px; }
  label {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: rgba(226, 232, 240, 0.78);
    margin-bottom: 8px;
    display: block;
  }
  select, input[type="number"] {
    width: 100%;
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid rgba(148, 163, 184, 0.35);
    background: var(--surface);
    color: var(--ink);
    font-size: 15px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }
  select:focus, input[type="number"]:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.3);
    outline: none;
  }
  .hint {
    font-size: 12px;
    color: var(--mut);
    margin-top: 6px;
    line-height: 1.5;
  }
  .hidden { display: none; }
  .advanced-toggle {
    margin-top: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    color: var(--ink-soft);
    font-size: 13px;
  }
  .advanced-toggle label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    font-weight: 600;
    text-transform: none;
    letter-spacing: 0;
    margin-bottom: 0;
  }
  .advanced-toggle input[type="checkbox"] {
    width: auto;
    accent-color: var(--accent);
  }
  .pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border-radius: 999px;
    padding: 6px 12px;
    font-weight: 700;
    font-size: 13px;
    letter-spacing: 0.03em;
    text-transform: uppercase;
  }
  .pill.ok { background: rgba(34, 197, 94, 0.18); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.45); }
  .pill.bad { background: rgba(244, 63, 94, 0.15); color: #fb7185; border: 1px solid rgba(244, 63, 94, 0.45); }
  .pill.warn { background: rgba(245, 158, 11, 0.16); color: #fcd34d; border: 1px solid rgba(245, 158, 11, 0.45); }
  .legend { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 14px; }
  .result-meta { margin-top: 18px; }
  .result-meta h2 { margin-top: 0; }
  .svgbox {
    position: relative;
    width: 100%;
    aspect-ratio: 4/3;
    border-radius: 22px;
    border: 1px solid var(--border);
    background: radial-gradient(circle at 15% 20%, rgba(56, 189, 248, 0.14), transparent 55%),
                linear-gradient(160deg, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.55));
    overflow: hidden;
  }
  .viz-card { position: relative; }
  .viz-card svg { display: block; }
  .viz-title {
    position: absolute;
    top: 8px;
    left: 8px;
    right: 48px;
    text-align: center;
    margin: 0 auto;
    white-space: normal;
    word-break: break-word;
    line-height: 1.2;
    font-size: 16px;
    font-weight: 700;
    color: rgba(226, 232, 240, 0.88);
    pointer-events: none;
  }
  .viz-check {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 36px;
    height: 36px;
    border-radius: 999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    line-height: 1;
    font-weight: 700;
    background: rgba(15, 23, 42, 0.7);
    border: 2px solid currentColor;
    pointer-events: none;
  }
  h2 { font-size: 22px; margin: 18px 0 10px; letter-spacing: -0.01em; }
  .tbl {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin-top: 18px;
    overflow: hidden;
    border-radius: 16px;
    box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.15);
  }
  .tbl th, .tbl td { padding: 12px 14px; text-align: left; }
  .tbl th {
    background: rgba(148, 163, 184, 0.14);
    color: var(--ink);
    font-weight: 600;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    font-size: 12px;
  }
  .tbl td {
    background: rgba(15, 23, 42, 0.45);
    border-top: 1px solid rgba(148, 163, 184, 0.15);
    color: var(--ink-soft);
  }
  .tbl tr:first-child td { border-top: none; }
  .small strong { color: #fff; }
  .badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 600;
    background: rgba(168, 85, 247, 0.18);
    color: #c4b5fd;
    border: 1px solid rgba(168, 85, 247, 0.35);
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }
  details {
    margin-top: 16px;
    background: rgba(15, 23, 42, 0.55);
    border-radius: 18px;
    border: 1px solid rgba(148, 163, 184, 0.2);
    overflow: hidden;
  }
  summary {
    cursor: pointer;
    padding: 14px 18px;
    font-weight: 600;
  }
  details[open] summary { border-bottom: 1px solid rgba(148, 163, 184, 0.2); }
  details > div {
    padding: 16px 18px;
    font-size: 13px;
    color: var(--ink-soft);
    line-height: 1.5;
  }
  .tests { font-size: 13px; line-height: 1.5; color: var(--ink-soft); }
  .tests b { color: #fff; }
  footer {
    margin-top: 32px;
    font-size: 13px;
    color: var(--mut);
    line-height: 1.6;
  }
  @media (max-width: 940px) {
    .grid { grid-template-columns: 1fr; }
    .card.result { position: static; }
  }
</style>
</head>
<body>
<div class="wrap">
  <nav><a href="index.html">← Volver al inicio</a></nav>
  <h1>¿Puede pasar una <em>tubería</em> a través de una <em>ubicación</em>?</h1>
  <p class="small">Norma referencia GL (Tabla 11.5) y espesores mínimos por material (Tablas 11.6–11.8). Resultado inmediato y visual.</p>

  <div class="grid">
    <!-- Controles -->
    <div class="card">
      <div class="row">
        <div>
          <label>Sistema / fluido de la tubería</label>
          <select id="system"></select>
        </div>
        <div>
          <label>Ubicación (espacio o tanque)</label>
          <select id="location"></select>
        </div>
      </div>

      <div class="row row--spaced">
        <div>
          <label>Material</label>
          <select id="material">
            <option value="steel">Acero al carbono (Tabla 11.6)</option>
            <option value="stainless">Acero inoxidable austenítico (Tabla 11.7)</option>
            <option value="copper_family">Cobre y aleaciones de cobre (Tabla 11.8)</option>
          </select>
          <div id="groupBox" class="hint">Grupo (solo steel): <b id="groupHint">—</b></div>
          <div id="copperSub" class="hidden">
            <label for="copperType">Subtipo</label>
            <select id="copperType">
              <option value="copper">Cobre</option>
              <option value="copper_alloy">Aleaciones de cobre</option>
            </select>
          </div>
        </div>
        <div>
          <label>Diámetro exterior d<sub>a</sub> [mm]</label>
          <input id="da" type="number" step="0.1" min="1" value="60"/>
          <div class="hint">El espesor s se calcula según el intervalo [mín, máx] en la tabla del material.</div>
        </div>
      </div>
      <details>
        <summary><strong>Autoverificación de lógica (tests unitarios)</strong></summary>
        <div id="tests" class="tests"></div>
      </details>
    </div>

    <!-- Vista / resultado -->
    <div class="card result">
      <div class="svgbox viz-card" id="viz"></div>
      <div class="legend">
        <span class="pill ok">Compatible</span>
        <span class="pill bad">No compatible</span>
        <span class="pill warn">Especial (–)</span>
        <span class="badge">Visual: tanque + tubo</span>
      </div>
      <div class="result-meta">
        <h2 id="headline">—</h2>
        <div id="explain" class="small">—</div>
      </div>

      <table class="tbl" id="outTbl" style="display:none">
        <thead>
          <tr><th>Parámetro</th><th>Valor</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <footer>
    <p><strong>Leyenda</strong>: N/M/D = grupo para acero (espesor por Tabla 11.6). X = no instalar. “–” = instalación solo tras acuerdo especial de la Sociedad de Clasificación. En estos casos, se muestra el aviso: “Validar con el diseñador del sistema y con casa clasificadora”.</p>
  </footer>
</div>

<script>
// ==============================
// MATRIZ NORMATIVA (todas las ubicaciones) – valores: 'N','M','D','X','-'
// ==============================
const SPACES = [
  'Machinery spaces','Cofferdams / void spaces','Cargo holds','Ballast water tanks',
  'Fuel and changeover tanks','Fresh cooling water tanks','Lubricating oil tanks','Hydraulic oil tanks',
  'Drinking water tanks','Thermal oil tanks','Condensate and feedwater tanks','Accommodation',
  'Cargo tanks, tank ships','Cofferdams, tank ships','Cargo pump rooms','Weather deck',
];

const SYSTEMS = [
  'Bilge lines','Ballast lines','Seawater lines','Fuel lines','Lubricating lines',
  'Thermal oil lines','Steam lines','Condensate lines','Feedwater lines',
  'Drinking water lines','Fresh cooling water lines','Compressed air lines','Hydraulic lines'
];

const ALLOWED_SYMBOLS = new Set(['M','D','N','X','-']);

function normalizeSymbol(value){
  if(value==null) return 'X';
  const raw=String(value).trim();
  if(raw==='-') return '-';
  const upper=raw.toUpperCase();
  return ALLOWED_SYMBOLS.has(upper)?upper:'X';
}

function normalizeMatrix(matrix){
  const normalized={};
  Object.keys(matrix).forEach(system=>{
    normalized[system]={};
    Object.keys(matrix[system]).forEach(space=>{
      normalized[system][space]=normalizeSymbol(matrix[system][space]);
    });
  });
  return normalized;
}

const MATRIX = normalizeMatrix({
  'Bilge lines': {
    'Machinery spaces':'M','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'D','Fuel and changeover tanks':'D','Fresh cooling water tanks':'X','Lubricating oil tanks':'X','Hydraulic oil tanks':'X','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'X','Accommodation':'M','Cargo tanks, tank ships':'X','Cofferdams, tank ships':'M','Cargo pump rooms':'M','Weather deck':'-'
  },
  'Ballast lines': {
    'Machinery spaces':'M','Cofferdams / void spaces':'M','Cargo holds':'D','Ballast water tanks':'M','Fuel and changeover tanks':'D','Fresh cooling water tanks':'X','Lubricating oil tanks':'X','Hydraulic oil tanks':'X','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'X','Accommodation':'X','Cargo tanks, tank ships':'-','Cofferdams, tank ships':'-','Cargo pump rooms':'M','Weather deck':'N'
  },
  'Seawater lines': {
    'Machinery spaces':'M','Cofferdams / void spaces':'M','Cargo holds':'D','Ballast water tanks':'M','Fuel and changeover tanks':'D','Fresh cooling water tanks':'X','Lubricating oil tanks':'X','Hydraulic oil tanks':'X','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'X','Accommodation':'M','Cargo tanks, tank ships':'X','Cofferdams, tank ships':'-','Cargo pump rooms':'M','Weather deck':'N'
  },
  'Fuel lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'D','Ballast water tanks':'D','Fuel and changeover tanks':'N','Fresh cooling water tanks':'X','Lubricating oil tanks':'X','Hydraulic oil tanks':'X','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'X','Accommodation':'X','Cargo tanks, tank ships':'X','Cofferdams, tank ships':'-','Cargo pump rooms':'-','Weather deck':'N'
  },
  'Lubricating lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'-','Ballast water tanks':'X','Fuel and changeover tanks':'X','Fresh cooling water tanks':'X','Lubricating oil tanks':'N','Hydraulic oil tanks':'-','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'X','Accommodation':'X','Cargo tanks, tank ships':'X','Cofferdams, tank ships':'-','Cargo pump rooms':'-','Weather deck':'N'
  },
  'Thermal oil lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'M','Fuel and changeover tanks':'M','Fresh cooling water tanks':'M','Lubricating oil tanks':'M','Hydraulic oil tanks':'-','Drinking water tanks':'X','Thermal oil tanks':'N','Condensate and feedwater tanks':'X','Accommodation':'X','Cargo tanks, tank ships':'M','Cofferdams, tank ships':'-','Cargo pump rooms':'N','Weather deck':'N'
  },
  'Steam lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'M','Fuel and changeover tanks':'M','Fresh cooling water tanks':'M','Lubricating oil tanks':'M','Hydraulic oil tanks':'-','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'N','Accommodation':'N','Cargo tanks, tank ships':'M','Cofferdams, tank ships':'-','Cargo pump rooms':'N','Weather deck':'N'
  },
  'Condensate lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'M','Fuel and changeover tanks':'M','Fresh cooling water tanks':'M','Lubricating oil tanks':'M','Hydraulic oil tanks':'-','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'N','Accommodation':'N','Cargo tanks, tank ships':'M','Cofferdams, tank ships':'-','Cargo pump rooms':'N','Weather deck':'N'
  },
  'Feedwater lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'X','Fuel and changeover tanks':'X','Fresh cooling water tanks':'X','Lubricating oil tanks':'X','Hydraulic oil tanks':'X','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'N','Accommodation':'X','Cargo tanks, tank ships':'X','Cofferdams, tank ships':'X','Cargo pump rooms':'X','Weather deck':'N'
  },
  'Drinking water lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'X','Fuel and changeover tanks':'X','Fresh cooling water tanks':'X','Lubricating oil tanks':'X','Hydraulic oil tanks':'X','Drinking water tanks':'N','Thermal oil tanks':'X','Condensate and feedwater tanks':'X','Accommodation':'N','Cargo tanks, tank ships':'X','Cofferdams, tank ships':'X','Cargo pump rooms':'X','Weather deck':'N'
  },
  'Fresh cooling water lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'X','Fuel and changeover tanks':'D','Fresh cooling water tanks':'N','Lubricating oil tanks':'D','Hydraulic oil tanks':'X','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'X','Accommodation':'X','Cargo tanks, tank ships':'X','Cofferdams, tank ships':'-','Cargo pump rooms':'-','Weather deck':'N'
  },
  'Compressed air lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'M','Fuel and changeover tanks':'M','Fresh cooling water tanks':'M','Lubricating oil tanks':'M','Hydraulic oil tanks':'N','Drinking water tanks':'X','Thermal oil tanks':'N','Condensate and feedwater tanks':'X','Accommodation':'N','Cargo tanks, tank ships':'X','Cofferdams, tank ships':'N','Cargo pump rooms':'N','Weather deck':'N'
  },
  'Hydraulic lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'M','Fuel and changeover tanks':'M','Fresh cooling water tanks':'X','Lubricating oil tanks':'X','Hydraulic oil tanks':'N','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'X','Accommodation':'X','Cargo tanks, tank ships':'N','Cofferdams, tank ships':'N','Cargo pump rooms':'N','Weather deck':'N'
  },
});

const matrix_rendered = MATRIX;

// ==============================
// Tablas 11.6–11.8 como INTERVALOS [min,max]
// ==============================
const STEEL = {
  'N': [[10.2,13.5,1.6],[13.5,20.0,1.8],[20.0,48.3,2.0],[48.3,70.0,2.3],[70.0,88.9,2.6],[88.9,114.3,2.9],[114.3,133.0,3.2],[133.0,152.4,3.6],[152.4,177.8,4.0],[177.8,244.5,4.5],[244.5,323.9,5.0],[323.9,Infinity,5.6]],
  'M': [[21.3,38.0,3.2],[38.0,51.0,3.6],[51.0,76.1,4.0],[76.1,177.8,4.5],[177.8,193.7,5.0],[193.7,219.1,5.4],[219.1,244.5,5.9],[244.5,406.4,6.3],[406.4,660.4,6.3],[660.4,762.0,7.1],[762.0,863.6,8.0],[863.6,914.4,8.8],[914.4,Infinity,10.0]],
  'D': [[38.0,88.9,6.3],[88.9,114.3,7.1],[114.3,152.4,8.0],[152.4,Infinity,8.8]]
};
const INOX = [[0,17.2,1.0],[17.2,48.3,1.6],[48.3,88.9,2.0],[88.9,168.3,2.3],[168.3,219.1,2.6],[219.1,273.0,2.9],[273.0,406.0,3.6],[406.0,Infinity,4.0]];
const TABLE_118 = [
  { daMin: 8.0, daMax: 10.0, s: { copper: 1.0, copper_alloy: 0.8 } },
  { daMin: 12.0, daMax: 20.0, s: { copper: 1.2, copper_alloy: 1.0 } },
  { daMin: 25.0, daMax: 44.5, s: { copper: 1.5, copper_alloy: 1.2 } },
  { daMin: 50.0, daMax: 76.1, s: { copper: 2.0, copper_alloy: 1.5 } },
  { daMin: 88.9, daMax: 108.0, s: { copper: 2.5, copper_alloy: 2.0 } },
  { daMin: 133.0, daMax: 159.0, s: { copper: 3.0, copper_alloy: 2.5 } },
  { daMin: 193.7, daMax: 267.0, s: { copper: 3.5, copper_alloy: 3.0 } },
  { daMin: 273.0, daMax: 457.2, s: { copper: 4.0, copper_alloy: 3.5 } },
  { daMin: 470.0, daMax: 508.0, s: { copper: 4.5, copper_alloy: 4.0 } }
];

function inRangeClosedOpen(x,a,b){return x>=a && x<b;}
function inRangeClosed(x,a,b){return x>=a && x<=b;}
function tSteel(group,da){const arr=STEEL[group]||[];for(const[lo,hi,s]of arr){if(inRangeClosedOpen(da,lo,hi))return s;}return null;}
function tInox(da){for(const[lo,hi,s]of INOX){if(inRangeClosedOpen(da,lo,hi))return s;}return null;}
function tCopperFamily(da,subtype){
  for(const row of TABLE_118){
    if(inRangeClosed(da,row.daMin,row.daMax)){
      return row.s[subtype] ?? null;
    }
  }
  return null;
}

// ===== Etiquetas ES (sin cambiar las claves internas) =====
const SPACES_LABELS = {
  'Machinery spaces': 'Espacios de máquinas',
  'Cofferdams / void spaces': 'Espacios de separación (cofferdams / voids)',
  'Cargo holds': 'Bodegas de carga',
  'Ballast water tanks': 'Tanques de agua de lastre',
  'Fuel and changeover tanks': 'Tanques de combustible y conmutación',
  'Fresh cooling water tanks': 'Tanques de agua dulce de enfriamiento',
  'Lubricating oil tanks': 'Tanques de aceite lubricante',
  'Hydraulic oil tanks': 'Tanques de aceite hidráulico',
  'Drinking water tanks': 'Tanques de agua potable',
  'Thermal oil tanks': 'Tanques de aceite térmico',
  'Condensate and feedwater tanks': 'Tanques de condensado y agua de alimentación',
  'Accommodation': 'Acomodaciones / habitabilidad',
  'Cargo tanks, tank ships': 'Tanques de carga (buques tanque)',
  'Cofferdams, tank ships': 'Espacios de separación en buques tanque (cofferdams)',
  'Cargo pump rooms': 'Salas de bombas de carga',
  'Weather deck': 'Cubierta expuesta (weather deck)'
};

const SYSTEMS_LABELS = {
  'Bilge lines': 'Líneas de sentina (Achique)',
  'Ballast lines': 'Líneas de lastre',
  'Seawater lines': 'Líneas de agua de mar',
  'Fuel lines': 'Líneas de combustible',
  'Lubricating lines': 'Líneas de lubricación',
  'Thermal oil lines': 'Líneas de aceite térmico',
  'Steam lines': 'Líneas de vapor',
  'Condensate lines': 'Líneas de condensado',
  'Feedwater lines': 'Líneas de agua de alimentación',
  'Drinking water lines': 'Líneas de agua potable',
  'Fresh cooling water lines': 'Líneas de agua dulce de enfriamiento',
  'Compressed air lines': 'Líneas de aire comprimido',
  'Hydraulic lines': 'Líneas hidráulicas'
};

// Mensaje canónico para “–”
const MSG_AGREEMENT = 'Validar con el diseñador del sistema y con casa clasificadora';

// ==============================
// UI helpers
// ==============================
function fillSelect(id,arr,labelMap){
  const el=document.getElementById(id);
  el.innerHTML='';
  arr.forEach(v=>{
    const o=document.createElement('option');
    o.value = v;
    o.textContent = labelMap[v] || v;
    el.appendChild(o);
  });
}

function drawViz({status,place,system,s}){
  const svg=document.getElementById('viz');
  const w=svg.clientWidth||560;
  const h=svg.clientHeight||420;
  const pad=28;
  const tankX=pad,tankY=pad,tankW=w-pad*2,tankH=h-pad*2;
  const pipeH=Math.max(28,tankH*0.16);
  const pipeY=tankY+tankH*0.58;
  const color=status==='ok'?'var(--ok)':status==='warn'?'var(--warn)':'var(--bad)';
  const tankTop=status==='bad'?'#40202b':status==='warn'?'#3a2c15':'#1f2937';
  const tankBottom=status==='bad'?'#1a0c12':status==='warn'?'#17100a':'#0b1120';
  const icon=status==='ok'?'✔':status==='warn'?'!':'✖';
  const note=status==='warn'?MSG_AGREEMENT:status==='bad'?'Paso bloqueado':'Paso permitido';
  const pipeStroke=status==='warn'?'stroke-dasharray="20 12" stroke-width="4"':'stroke-width="2.4"';
  const filterId=status==='bad'?'glowBad':status==='warn'?'glowWarn':'glowOk';
  const placeES = SPACES_LABELS[place] || place;
  const systemES = SYSTEMS_LABELS[system] || system;
  svg.innerHTML=`
    <div class="viz-title"></div>
    <div class="viz-check" aria-hidden="true"></div>
    <svg width="100%" height="100%" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="${systemES} → ${placeES}">
    <defs>
      <linearGradient id="tankGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="${tankTop}" />
        <stop offset="100%" stop-color="${tankBottom}" />
      </linearGradient>
      <linearGradient id="pipeGrad" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stop-color="${color}" stop-opacity="0.55" />
        <stop offset="50%" stop-color="${color}" stop-opacity="1" />
        <stop offset="100%" stop-color="${color}" stop-opacity="0.55" />
      </linearGradient>
      <filter id="glowOk" x="-40%" y="-40%" width="180%" height="180%">
        <feDropShadow dx="0" dy="0" stdDeviation="8" flood-color="#22c55e" flood-opacity="0.65"/>
      </filter>
      <filter id="glowWarn" x="-40%" y="-40%" width="180%" height="180%">
        <feDropShadow dx="0" dy="0" stdDeviation="8" flood-color="#f59e0b" flood-opacity="0.6"/>
      </filter>
      <filter id="glowBad" x="-40%" y="-40%" width="180%" height="180%">
        <feDropShadow dx="0" dy="0" stdDeviation="9" flood-color="#f43f5e" flood-opacity="0.7"/>
      </filter>
    </defs>
    <rect x="${tankX}" y="${tankY}" rx="28" ry="28" width="${tankW}" height="${tankH}" fill="url(#tankGrad)" stroke="rgba(148,163,184,0.35)" stroke-width="2.2"/>
    <g filter="url(#${filterId})">
      <rect x="${tankX-52}" y="${pipeY-pipeH/2}" width="${tankW+104}" height="${pipeH}" rx="${pipeH/2}" fill="url(#pipeGrad)" stroke="${color}" ${pipeStroke} opacity="0.95"/>
    </g>
    <text x="${tankX+tankW/2}" y="${pipeY-pipeH/2-14}" text-anchor="middle" font-size="13" fill="rgba(226,232,240,0.78)">${systemES}</text>
    ${s&&status==='ok'?`<text x="${tankX+tankW/2}" y="${pipeY+pipeH/2+24}" text-anchor="middle" font-size="14" fill="#4ade80">s = ${s.toFixed(1)} mm</text>`:''}
    <text x="${tankX+36}" y="${tankY+tankH-28}" font-size="12" fill="rgba(226,232,240,0.64)">${note}</text>
    ${status==='bad'?`<line x1="${tankX+18}" y1="${tankY+18}" x2="${tankX+tankW-18}" y2="${tankY+tankH-18}" stroke="${color}" stroke-width="6" stroke-linecap="round" opacity="0.72"/>`:''}
    ${status==='bad'?`<line x1="${tankX+tankW-18}" y1="${tankY+18}" x2="${tankX+18}" y2="${tankY+tankH-18}" stroke="${color}" stroke-width="6" stroke-linecap="round" opacity="0.72"/>`:''}
  </svg>`;
  const titleNode=svg.querySelector('.viz-title');
  if(titleNode){
    titleNode.textContent=placeES;
  }
  const checkNode=svg.querySelector('.viz-check');
  if(checkNode){
    checkNode.textContent=icon;
    checkNode.style.color=color;
    checkNode.style.borderColor=color;
  }
}

const materialSel=document.getElementById('material');
const copperSub=document.getElementById('copperSub');
const copperTypeSel=document.getElementById('copperType');

function toggleCopperSub(){
  copperSub.classList.toggle('hidden', materialSel.value !== 'copper_family');
}

function calc(){
  const system=document.getElementById('system').value;
  const locationSel=document.getElementById('location').value;
  const mat=materialSel.value;
  const da=parseFloat(document.getElementById('da').value);

  const cell=(MATRIX[system]||{})[locationSel];
  let symbol=normalizeSymbol(cell);
  let group=null;

  if (symbol === '-') {
    drawViz({status:'warn', place:locationSel, system});
    document.getElementById('headline').innerHTML = '<span class="pill warn">Especial (–)</span>';
    document.getElementById('explain').textContent = MSG_AGREEMENT;
    document.getElementById('groupHint').textContent = '—';
    document.getElementById('outTbl').style.display = 'none';
    return;
  }

  if(symbol==='X'){
    drawViz({status:'bad',place:locationSel,system});
    document.getElementById('headline').innerHTML='<span class="pill bad">No compatible</span>';
    document.getElementById('explain').innerHTML='La tabla normativa (11.5) marca “X”: la tubería no debe instalarse en esta ubicación.';
    document.getElementById('groupHint').textContent='—';
    document.getElementById('outTbl').style.display='none';
    return;
  }

  let s=null; let rule='';
  if(mat==='steel'){
    group=symbol;
    document.getElementById('groupHint').textContent=group;
    s=tSteel(group,da);
    if(s==null){
      drawViz({status:'bad',place:locationSel,system});
      document.getElementById('headline').innerHTML='<span class="pill bad">Fuera de tabla (steel)</span>';
      document.getElementById('explain').innerHTML='El diámetro ingresado no cae en ningún intervalo de la Tabla 11.6 para el grupo '+group+'. Ajusta dₐ o consulta a clase.';
      document.getElementById('outTbl').style.display='none'; return;
    }
    rule=`Steel grupo <b>${group}</b> · Tabla 11.6 · intervalo válido para d<sub>a</sub> = ${da} mm.`;
  } else if(mat==='stainless'){
    document.getElementById('groupHint').textContent='—';
    s=tInox(da);
    if(s==null){
      drawViz({status:'bad',place:locationSel,system});
      document.getElementById('headline').innerHTML='<span class="pill bad">Fuera de tabla (inox)</span>';
      document.getElementById('explain').innerHTML='El diámetro no cae en los intervalos de la Tabla 11.7.';
      document.getElementById('outTbl').style.display='none'; return;
    }
    rule='Austenitic stainless steel · Tabla 11.7 · intervalo válido.';
  } else if(mat==='copper_family'){
    document.getElementById('groupHint').textContent='—';
    const sub=copperTypeSel.value;
    const row=TABLE_118.find(r=>da>=r.daMin && da<=r.daMax);
    s=row?row.s[sub]??null:null;
    if(s==null){
      drawViz({status:'bad',place:locationSel,system});
      document.getElementById('headline').innerHTML='<span class="pill bad">Fuera de tabla (Tabla 11.8)</span>';
      document.getElementById('explain').innerHTML='El diámetro no coincide con ningún rango de la Tabla 11.8 para el subtipo seleccionado.';
      document.getElementById('outTbl').style.display='none'; return;
    }
    const subtypeText=copperTypeSel.options[copperTypeSel.selectedIndex].text;
    rule=`Cobre y aleaciones · Tabla 11.8 · Subtipo: ${subtypeText}.`;
  } else {
    document.getElementById('groupHint').textContent='—';
  }

  drawViz({status:'ok',place:locationSel,system,s});
  document.getElementById('headline').innerHTML='<span class="pill ok">Compatible</span>';
  document.getElementById('explain').innerHTML=`Espesor mínimo <b>s = ${s.toFixed(1)} mm</b>. ${rule}`;

  const tbody=document.querySelector('#outTbl tbody');
  tbody.innerHTML='';
  const sysES = SYSTEMS_LABELS[system] || system;
  const locES = SPACES_LABELS[locationSel] || locationSel;
  const materialText = mat==='copper_family'
    ? `Cobre y aleaciones (Tabla 11.8) – ${copperTypeSel.options[copperTypeSel.selectedIndex].text}`
    : materialSel.options[materialSel.selectedIndex].text;
  const rows=[
    ['Sistema',sysES],['Ubicación',locES],['Material',materialText],
    ['Símbolo (Tabla 11.5)',symbol],['Grupo (si steel)',group||'—'],['dₐ [mm]',da],['Espesor s [mm]',s!=null?s.toFixed(1):'—'],
  ];
  for(const[k,v]of rows){const tr=document.createElement('tr');const a=document.createElement('td');a.textContent=k;tr.appendChild(a);const b=document.createElement('td');b.innerHTML=String(v);tr.appendChild(b);tbody.appendChild(tr);}
  document.getElementById('outTbl').style.display='table';
}

function runTests(){
  const cases=[];
  cases.push(['Fuel lines en Fuel&changeover = N',matrix_rendered['Fuel lines']['Fuel and changeover tanks']==='N']);
  cases.push(['Bilge lines en Ballast = D',matrix_rendered['Bilge lines']['Ballast water tanks']==='D']);
  cases.push(['Fresh cooling line en Fresh cooling tank = N',matrix_rendered['Fresh cooling water lines']['Fresh cooling water tanks']==='N']);
  cases.push(['Hydraulic lines en Hydraulic oil tank = N',matrix_rendered['Hydraulic lines']['Hydraulic oil tanks']==='N']);
  cases.push(['Drinking water line en Drinking water tank = N',matrix_rendered['Drinking water lines']['Drinking water tanks']==='N']);
  cases.push(['Fuel lines en Machinery spaces = N',matrix_rendered['Fuel lines']['Machinery spaces']==='N']);
  cases.push(['Bilge en Cofferdams/void = M',matrix_rendered['Bilge lines']['Cofferdams / void spaces']==='M']);
  cases.push(['Steam en Accommodation = N',matrix_rendered['Steam lines']['Accommodation']==='N']);
  cases.push(['Compressed air en Thermal oil tanks = N',matrix_rendered['Compressed air lines']['Thermal oil tanks']==='N']);
  cases.push(['Hydraulic lines en Cargo tanks (tank ships) = N',matrix_rendered['Hydraulic lines']['Cargo tanks, tank ships']==='N']);
  cases.push(['Fresh cooling line en Cargo pump rooms = –',matrix_rendered['Fresh cooling water lines']['Cargo pump rooms']==='-']);
  cases.push(['Bilge lines en Accommodation = M',matrix_rendered['Bilge lines']['Accommodation']==='M']);
  cases.push(['Ballast lines en Accommodation = X',matrix_rendered['Ballast lines']['Accommodation']==='X']);
  cases.push(['Seawater lines en Accommodation = M',matrix_rendered['Seawater lines']['Accommodation']==='M']);
  cases.push(['Fresh cooling water lines en Cofferdams, tank ships = –',matrix_rendered['Fresh cooling water lines']['Cofferdams, tank ships']==='-']);
  cases.push(['Compressed air lines en Cofferdams, tank ships = N',matrix_rendered['Compressed air lines']['Cofferdams, tank ships']==='N']);
  cases.push(['Steel M, dₐ=21.3 ⇒ s=3.2',Math.abs(tSteel('M',21.3)-3.2)<1e-9]);
  cases.push(['Steel D, dₐ=160 ⇒ s=8.8',Math.abs(tSteel('D',160)-8.8)<1e-9]);
  cases.push(['Inox, dₐ=21.3 ⇒ s=1.6',Math.abs(tInox(21.3)-1.6)<1e-9]);
  cases.push(['Cobre puro, dₐ=25 ⇒ s=1.5',Math.abs(tCopperFamily(25,'copper')-1.5)<1e-9]);
  cases.push(['Aleación de cobre, dₐ=25 ⇒ s=1.2',Math.abs(tCopperFamily(25,'copper_alloy')-1.2)<1e-9]);
  cases.push(['Cobre, dₐ=21 ⇒ fuera de tabla',tCopperFamily(21,'copper')===null]);
  cases.push(['Etiquetas ES cubren todos los SPACES',
    SPACES.every(k => !!SPACES_LABELS[k])
  ]);

  cases.push(['Etiquetas ES cubren todos los SYSTEMS',
    SYSTEMS.every(k => !!SYSTEMS_LABELS[k])
  ]);

  cases.push(['Solo símbolos permitidos en toda la matriz',
    Object.keys(matrix_rendered).every(r =>
      Object.keys(matrix_rendered[r]).every(c => ALLOWED_SYMBOLS.has(matrix_rendered[r][c]))
    )
  ]);

  cases.push(['Caso “–” muestra aviso exacto',
    matrix_rendered['Fresh cooling water lines']['Cargo pump rooms'] === '-'
  ]);

  const ok=cases.every(([_,p])=>p);
  document.getElementById('tests').innerHTML=(ok?'✅ Lógica verificada':'❌ Falla en pruebas')+'<br>'+cases.map(([n,p])=>(p?'✔️ ':'❌ ')+n).join('<br>');
}

// INIT
fillSelect('system', SYSTEMS, SYSTEMS_LABELS);
fillSelect('location', SPACES, SPACES_LABELS);
['system','location','da'].forEach(id=>{
  document.getElementById(id).addEventListener('change',calc);
  document.getElementById(id).addEventListener('input',calc);
});
materialSel.addEventListener('change',()=>{ toggleCopperSub(); calc(); });
materialSel.addEventListener('input',()=>{ toggleCopperSub(); calc(); });
copperTypeSel.addEventListener('change',calc);
(function mapLegacyMaterials(){
  const legacy=materialSel.value;
  if(legacy==='copper' || legacy==='copper_alloy'){
    materialSel.value='copper_family';
    copperTypeSel.value=legacy;
  }
  toggleCopperSub();
})();
runTests();
calc();
</script>
</body>
</html>

