<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Compatibilidad de tuberías a través de tanques · Norma cerrada</title>
<link rel="stylesheet" href="assets/css/app.css">
<style>
  :root {
    --bg: #0f172a;
    --bg-soft: #1e293b;
    --bg-card: rgba(15, 23, 42, 0.82);
    --surface: rgba(15, 23, 42, 0.6);
    --ink: #e2e8f0;
    --ink-soft: rgba(226, 232, 240, 0.76);
    --mut: rgba(148, 163, 184, 0.7);
    --border: rgba(148, 163, 184, 0.18);
    --accent: #38bdf8;
    --accent-2: #a855f7;
    --ok: #22c55e;
    --bad: #f43f5e;
    --warn: #f59e0b;
  }
  * { box-sizing: border-box; }
  html, body {
    margin: 0;
    min-height: 100%;
    background: radial-gradient(circle at top, #1e293b 0%, #0f172a 55%, #020617 100%);
    color: var(--ink);
    font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
  }
  a { color: inherit; }
  .wrap {
    max-width: 1240px;
    margin: 0 auto;
    padding: 48px 24px 64px;
  }
  nav { margin-bottom: 28px; }
  nav a {
    color: var(--accent);
    text-decoration: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: color 0.2s ease;
  }
  nav a:hover { color: #7dd3fc; }
  .relative { position: relative; }
  .mt-3 { margin-top: 0.75rem; }
  .text-slate-300 { color: rgba(203, 213, 225, 0.92); }
  .max-w-3xl { max-width: 48rem; }
  .page-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 24px;
    flex-wrap: wrap;
    margin-bottom: 32px;
  }
  .page-header .header-copy { flex: 1 1 380px; min-width: 260px; }
  .page-header .header-brand {
    flex: 0 0 auto;
    max-width: 200px;
    display: flex;
    align-items: flex-start;
    justify-content: flex-end;
    padding: 12px;
    border-radius: 22px;
    background: rgba(15, 23, 42, 0.5);
    backdrop-filter: blur(10px);
    box-shadow: 0 16px 40px rgba(8, 47, 73, 0.35);
  }
  .page-header .header-brand img {
    max-width: 100%;
    height: auto;
    border-radius: 14px;
  }
  .header-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 20px;
  }
  .header-cta {
    font-size: 15px;
    padding: 12px 20px;
  }
  h1 {
    font-size: clamp(26px, 4vw, 38px);
    margin: 0 0 12px;
    letter-spacing: -0.01em;
  }
  .small {
    font-size: 14px;
    color: var(--ink-soft);
    margin: 0 0 24px;
    max-width: 720px;
    line-height: 1.6;
  }
  .sublead {
    font-size: 1rem;
    line-height: 1.5;
    opacity: 0.9;
    max-width: 720px;
    margin: 0 0 24px;
  }
  .block-subtitle {
    display: block;
  }
  .grid {
    display: grid;
    grid-template-columns: minmax(0, 1.05fr) minmax(0, 1fr);
    gap: 26px;
    align-items: start;
  }
  .card {
    background: var(--bg-card);
    border-radius: 26px;
    border: 1px solid var(--border);
    padding: 28px;
    box-shadow: 0 20px 45px rgba(2, 6, 23, 0.55);
    backdrop-filter: blur(16px);
  }
  .card.result { position: sticky; top: 32px; }

  #notesCard[data-state="idle"] .card-title::after {
    content: " (pendiente de validar)";
    font-weight: 400;
    opacity: 0.7;
    font-size: 0.9em;
  }
  .row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px;
  }
  .row > div {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .card > .row + .row {
    margin-top: 20px;
  }
  .row.da-actions {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 16px;
    margin-top: 12px;
    flex-wrap: wrap;
  }
  .row.row--spaced {
    margin-top: 18px;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  }
  label {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: rgba(226, 232, 240, 0.78);
    margin-bottom: 0;
    display: block;
  }
  select, input[type="number"], input[type="text"] {
    width: 100%;
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid rgba(148, 163, 184, 0.35);
    background: var(--surface);
    color: var(--ink);
    font-size: 15px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }
  select:focus, input[type="number"]:focus, input[type="text"]:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.3);
    outline: none;
  }
  #daSelect { width: 100%; }
  .btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: #0ea5e9;
    color: #041628;
    font-weight: 600;
    font-size: 15px;
    padding: 12px 26px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    box-shadow: 0 12px 30px rgba(14, 165, 233, 0.28);
    transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
  }
  .btn-primary:hover {
    transform: translateY(-2px);
    background: #38bdf8;
    box-shadow: 0 14px 34px rgba(14, 165, 233, 0.35);
  }
  .btn-primary:focus-visible {
    outline: 2px solid rgba(56, 189, 248, 0.5);
    outline-offset: 3px;
  }
  .btn-primary .btn-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .btn-primary .btn-icon svg {
    width: 18px;
    height: 18px;
  }
  .hint {
    font-size: 12px;
    color: var(--mut);
    margin-top: 6px;
    line-height: 1.5;
  }
  .hint.error {
    color: #fca5a5;
    font-weight: 600;
  }
  .hidden { display: none; }
  .advanced-toggle {
    margin-top: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    color: var(--ink-soft);
    font-size: 13px;
  }
  .advanced-toggle label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    font-weight: 600;
    text-transform: none;
    letter-spacing: 0;
    margin-bottom: 0;
  }
  .advanced-toggle input[type="checkbox"] {
    width: auto;
    accent-color: var(--accent);
  }
  .pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border-radius: 999px;
    padding: 6px 12px;
    font-weight: 700;
    font-size: 13px;
    letter-spacing: 0.03em;
    text-transform: uppercase;
  }
  .pill.ok {
    background: #14532d;
    color: #f4fff4;
    border: 1px solid rgba(74, 222, 128, 0.7);
    box-shadow: inset 0 1px 0 rgba(209, 250, 229, 0.2);
  }
  .pill.bad { background: rgba(244, 63, 94, 0.15); color: #fb7185; border: 1px solid rgba(244, 63, 94, 0.45); }
  .pill.warn { background: rgba(245, 158, 11, 0.16); color: #fcd34d; border: 1px solid rgba(245, 158, 11, 0.45); }
  .legend {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 14px;
    justify-content: center;
  }
  .result-meta { margin-top: 18px; text-align: center; }
  .result-title { margin: 0 0 12px; font-size: 20px; letter-spacing: 0.02em; text-transform: uppercase; }
  .result-status { min-height: 40px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
  .result-status .pill { font-size: 14px; padding: 8px 18px; }
  .result-meta .small { margin: 0 auto; max-width: 420px; text-align: center; }
  .svgbox {
    position: relative;
    width: 100%;
    aspect-ratio: 4/3;
    border-radius: 22px;
    border: 1px solid var(--border);
    background: radial-gradient(circle at 15% 20%, rgba(56, 189, 248, 0.14), transparent 55%),
                linear-gradient(160deg, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.55));
    overflow: hidden;
  }
  .viz-card { position: relative; }
  .viz-card svg { display: block; }
  .viz-overlay {
    position: absolute;
    left: 0;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    pointer-events: none;
  }
  .viz-sline { font-weight: 600; }
  .viz-schline { font-size: 0.9rem; opacity: 0.9; }
  .viz-title {
    position: absolute;
    top: 8px;
    left: 8px;
    right: 48px;
    text-align: center;
    margin: 0 auto;
    white-space: normal;
    word-break: break-word;
    line-height: 1.2;
    font-size: 16px;
    font-weight: 700;
    color: rgba(226, 232, 240, 0.88);
    pointer-events: none;
  }
  .viz-check {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 36px;
    height: 36px;
    border-radius: 999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    line-height: 1;
    font-weight: 700;
    background: rgba(15, 23, 42, 0.7);
    border: 2px solid currentColor;
    pointer-events: none;
  }
  h2 { font-size: 22px; margin: 18px 0 10px; letter-spacing: -0.01em; }
  .tbl {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin-top: 18px;
    overflow: hidden;
    border-radius: 16px;
    box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.15);
  }
  .tbl th, .tbl td { padding: 12px 14px; text-align: left; }
  .tbl th {
    background: rgba(148, 163, 184, 0.14);
    color: var(--ink);
    font-weight: 600;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    font-size: 12px;
  }
  .tbl td {
    background: rgba(15, 23, 42, 0.45);
    border-top: 1px solid rgba(148, 163, 184, 0.15);
    color: var(--ink-soft);
  }
  .tbl tr:first-child td { border-top: none; }
  .small strong { color: #fff; }
  .mt-16 { margin-top: 4rem; }
  .max-w-6xl { max-width: 72rem; }
  .mx-auto { margin-left: auto; margin-right: auto; }
  .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
  .rounded-2xl { border-radius: 1rem; }
  .bg-slate-900\/70 { background-color: rgba(15, 23, 42, 0.7); }
  .border { border: 1px solid transparent; }
  .border-slate-700 { border-color: #334155; }
  .p-4 { padding: 1rem; }
  .flex { display: flex; }
  .flex-col { flex-direction: column; }
  .text-slate-200 { color: #e2e8f0; }
  .text-sm { font-size: 0.875rem; }
  .mt-1 { margin-top: 0.25rem; }
  .text-sky-300 { color: #7dd3fc; }
  .underline { text-decoration: underline; }
  .underline-offset-4 { text-underline-offset: 4px; }
  .hover\:text-sky-200:hover { color: #bae6fd; }
  .shadow-\[0_8px_40px_rgba\(0,0,0,0\.35\)\] { box-shadow: 0 8px 40px rgba(0, 0, 0, 0.35); }
  @media (min-width: 640px) {
    .sm\:flex-row { flex-direction: row; }
    .sm\:items-center { align-items: center; }
    .sm\:justify-between { justify-content: space-between; }
    .sm\:mt-0 { margin-top: 0; }
  }
  /* Modal genérico para el evaluador LR de juntas */
  .lrj-modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.8);
    z-index: 9999;
  }
  .lrj-modal.open { display: flex; }

  .lrj-modal iframe {
    width: min(1200px, 95vw);
    height: 90vh;
    border: 0;
    border-radius: 12px;
    background: #0e1320;
  }

  .lrj-close {
    position: absolute;
    top: 14px;
    right: 16px;
    font-size: 28px;
    line-height: 1;
    background: #111;
    color: #fff;
    border: 0;
    border-radius: 8px;
    padding: 6px 10px;
    cursor: pointer;
  }
  @media (max-width: 940px) {
    .grid { grid-template-columns: 1fr; }
    .card.result { position: static; }
  }
</style>
</head>
<body>
<div class="wrap">
  <nav><a href="index.html">← Volver al inicio</a></nav>
  <section class="relative hero-pr max-w-6xl mx-auto px-6">
    <div class="logo-badge" aria-hidden="true" role="presentation">
      <img src="assets/joints/cotec.jpg" alt="COTECMAR">
    </div>

    <h1 class="hero-title font-extrabold">
      Compatibilidad De Paso para Tuberías
    </h1>
    <p id="pageSublead" class="sublead block-subtitle mt-3 text-slate-300 max-w-3xl">
      Basado en norma GL para compatibilidad de rutas de tuberías; para agua potable se
      considera IMO. Criterios complementados con la experiencia del astillero COTECMAR.
    </p>
  </section>

  <div class="grid">
    <!-- Controles -->
    <div class="card">
      <div class="row">
        <div>
          <label>Sistema / fluido de la tubería</label>
          <select id="system"></select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Ubicación (espacio o tanque) a pasar</label>
          <select id="location"></select>
        </div>
      </div>

      <div class="row row--spaced">
        <div>
          <label>Material</label>
          <select id="material">
            <option value="steel">Acero al carbono</option>
            <option value="stainless">Acero inoxidable austenítico</option>
            <option value="copper_family">Cobre y aleaciones de cobre</option>
          </select>
          <div id="copperSub" class="hidden">
            <label for="copperType">Subtipo</label>
            <select id="copperType">
              <option value="copper">Cobre</option>
              <option value="copper_alloy">Aleaciones de cobre</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label for="daSelect">Diámetro exterior d<sub>a</sub> (dependiente de Material)</label>
          <select id="daSelect"></select>
          <div class="row da-actions">
            <button id="btnDaValidate" type="button" class="btn-primary">
              <span class="btn-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35m1.1-4.4a6.5 6.5 0 11-13 0 6.5 6.5 0 0113 0z" />
                </svg>
              </span>
              <span>Evaluar compatibilidad</span>
            </button>
            <small id="daHelp" class="hint"></small>
          </div>
          <div class="hint">El espesor s se calcula según el intervalo [mín, máx] en la tabla del material.</div>
        </div>
      </div>
      <div id="notesCard" class="card" data-state="idle" style="margin-top:1rem;">
        <div class="card-title">NOTAS</div>
        <div class="card-body">
          <p id="notesText" class="muted"></p>
        </div>
      </div>
    </div>

    <!-- Vista / resultado -->
    <div class="card result">
      <div class="viz-card">
        <div class="svgbox" id="viz"></div>
        <div class="viz-overlay">
          <div id="sLine" class="viz-sline">s = — mm</div>
          <div id="schLine" class="viz-schline"> </div>
        </div>
      </div>
      <div class="legend">
        <span class="pill ok">Compatible</span>
        <span class="pill bad">No compatible</span>
        <span class="pill warn">Especial (–)</span>
      </div>
      <div class="result-meta">
        <h2 class="result-title">Resultado de análisis</h2>
        <div id="headline" class="result-status">—</div>
        <div id="explain" class="small">—</div>
        <div id="outSummary" class="small muted">—</div>
      </div>

      <table class="tbl" id="outTbl" style="display:none">
        <thead>
          <tr><th>Parámetro</th><th>Valor</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<script>
// ==============================
// MATRIZ NORMATIVA (todas las ubicaciones) – valores: 'N','M','D','X','-'
// ==============================
// ===== SPACES (orden de columnas) =====
const SPACES = [
  'Machinery spaces',
  'Cofferdams / void spaces',
  'Cargo holds',
  'Ballast water tanks',
  'Fuel and changeover tanks',
  'Fresh cooling water tanks',
  'Lubricating oil tanks',
  'Hydraulic oil tanks',
  'Drinking water tanks',
  'Thermal oil tanks',
  'Condensate and feedwater tanks',
  'Accommodation',
  'Cargo tanks, tank ships',
  'Cofferdams, tank ships',
  'Cargo pump rooms',
  'Weather deck',
  // ↓↓↓ NUEVOS ESPACIOS (al final, sin alterar claves internas)
  'Blackwater Tanks',
  'Greywater Tanks',
];

// ===== SYSTEMS =====
const SYSTEMS = [
  'Bilge lines',
  'Ballast lines',
  'Seawater lines',
  'Fuel lines',
  'Lubricating lines',
  'Thermal oil lines',
  'Steam lines',
  'Condensate lines',
  'Feedwater lines',
  'Drinking water lines',
  'Fresh cooling water lines',
  'Compressed air lines',
  'Hydraulic lines',
  // ↓↓↓ NUEVOS SISTEMAS
  'Blackwater lines',
  'Greywater lines',
];

const ALLOWED_SYMBOLS = new Set(['M','D','N','X','-']);

// ===== Etiquetas ES (sin cambiar las claves internas) =====
const MATERIAL_ES = {
  steel: 'Acero al carbono',
  stainless: 'Acero inoxidable austenítico',
  inox: 'Acero inoxidable austenítico',
  copper_family: 'Aleaciones de cobre',
  copper: 'Cobre',
  copper_alloy: 'Aleaciones de cobre',
};

function stripTableRefs(text) {
  if (typeof text !== 'string') return '';
  const cleaned = text
    .replace(/\s*\((Tabla|Table)[^)]+\)/gi, '')
    .replace(/(?:·\s*)?Tabla\s+11\.\d\s*(?:·)?/gi, '')
    .replace(/\s{2,}/g, ' ')
    .trim();
  return cleaned;
}

const sublead = document.getElementById('pageSublead');
if (sublead) {
  sublead.innerHTML =
    'Basado en norma GL para compatibilidad de rutas de tuberías; para agua potable se considera IMO. ' +
    'Criterios complementados con la experiencia del astillero COTECMAR.';
}

const summaryEl = document.getElementById('outSummary');

function setSummary(content) {
  if (!summaryEl) return;
  if (!content) {
    summaryEl.textContent = '—';
    return;
  }
  const clean = stripTableRefs(content);
  summaryEl.innerHTML = clean || '—';
}

function cleanseLegacyTableRefs(){
  document.querySelectorAll('#pageSublead, #outSummary, .muted, .note, .help')
    .forEach(el=>{
      if(!el) return;
      const current=el.innerHTML || '';
      const clean=stripTableRefs(current);
      el.innerHTML = clean || '';
    });
}

function normalizeSymbol(value){
  if(value==null) return 'X';
  const raw=String(value).trim();
  if(raw==='-') return '-';
  const upper=raw.toUpperCase();
  return ALLOWED_SYMBOLS.has(upper)?upper:'X';
}

function normalizeMatrix(matrix){
  const normalized={};
  Object.keys(matrix).forEach(system=>{
    normalized[system]={};
    Object.keys(matrix[system]).forEach(space=>{
      normalized[system][space]=normalizeSymbol(matrix[system][space]);
    });
  });
  return normalized;
}

const MATRIX = normalizeMatrix({
  'Bilge lines': {
    'Machinery spaces':'M','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'D','Fuel and changeover tanks':'D','Fresh cooling water tanks':'X','Lubricating oil tanks':'X','Hydraulic oil tanks':'X','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'X','Accommodation':'M','Cargo tanks, tank ships':'X','Cofferdams, tank ships':'M','Cargo pump rooms':'M','Weather deck':'-'
  },
  'Ballast lines': {
    'Machinery spaces':'M','Cofferdams / void spaces':'M','Cargo holds':'D','Ballast water tanks':'M','Fuel and changeover tanks':'D','Fresh cooling water tanks':'X','Lubricating oil tanks':'X','Hydraulic oil tanks':'X','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'X','Accommodation':'X','Cargo tanks, tank ships':'-','Cofferdams, tank ships':'-','Cargo pump rooms':'M','Weather deck':'N'
  },
  'Seawater lines': {
    'Machinery spaces':'M','Cofferdams / void spaces':'M','Cargo holds':'D','Ballast water tanks':'M','Fuel and changeover tanks':'D','Fresh cooling water tanks':'X','Lubricating oil tanks':'X','Hydraulic oil tanks':'X','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'X','Accommodation':'M','Cargo tanks, tank ships':'X','Cofferdams, tank ships':'-','Cargo pump rooms':'M','Weather deck':'N'
  },
  'Fuel lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'D','Ballast water tanks':'D','Fuel and changeover tanks':'N','Fresh cooling water tanks':'X','Lubricating oil tanks':'X','Hydraulic oil tanks':'X','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'X','Accommodation':'X','Cargo tanks, tank ships':'X','Cofferdams, tank ships':'-','Cargo pump rooms':'-','Weather deck':'N'
  },
  'Lubricating lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'-','Ballast water tanks':'X','Fuel and changeover tanks':'X','Fresh cooling water tanks':'X','Lubricating oil tanks':'N','Hydraulic oil tanks':'-','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'X','Accommodation':'X','Cargo tanks, tank ships':'X','Cofferdams, tank ships':'-','Cargo pump rooms':'-','Weather deck':'N'
  },
  'Thermal oil lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'M','Fuel and changeover tanks':'M','Fresh cooling water tanks':'M','Lubricating oil tanks':'M','Hydraulic oil tanks':'-','Drinking water tanks':'X','Thermal oil tanks':'N','Condensate and feedwater tanks':'X','Accommodation':'X','Cargo tanks, tank ships':'M','Cofferdams, tank ships':'-','Cargo pump rooms':'N','Weather deck':'N'
  },
  'Steam lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'M','Fuel and changeover tanks':'M','Fresh cooling water tanks':'M','Lubricating oil tanks':'M','Hydraulic oil tanks':'-','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'N','Accommodation':'N','Cargo tanks, tank ships':'M','Cofferdams, tank ships':'-','Cargo pump rooms':'N','Weather deck':'N'
  },
  'Condensate lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'M','Fuel and changeover tanks':'M','Fresh cooling water tanks':'M','Lubricating oil tanks':'M','Hydraulic oil tanks':'-','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'N','Accommodation':'N','Cargo tanks, tank ships':'M','Cofferdams, tank ships':'-','Cargo pump rooms':'N','Weather deck':'N'
  },
  'Feedwater lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'X','Fuel and changeover tanks':'X','Fresh cooling water tanks':'X','Lubricating oil tanks':'X','Hydraulic oil tanks':'X','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'N','Accommodation':'X','Cargo tanks, tank ships':'X','Cofferdams, tank ships':'X','Cargo pump rooms':'X','Weather deck':'N'
  },
  'Drinking water lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'X','Fuel and changeover tanks':'X','Fresh cooling water tanks':'X','Lubricating oil tanks':'X','Hydraulic oil tanks':'X','Drinking water tanks':'N','Thermal oil tanks':'X','Condensate and feedwater tanks':'X','Accommodation':'N','Cargo tanks, tank ships':'X','Cofferdams, tank ships':'X','Cargo pump rooms':'X','Weather deck':'N'
  },
  'Fresh cooling water lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'X','Fuel and changeover tanks':'D','Fresh cooling water tanks':'N','Lubricating oil tanks':'D','Hydraulic oil tanks':'X','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'X','Accommodation':'X','Cargo tanks, tank ships':'X','Cofferdams, tank ships':'-','Cargo pump rooms':'-','Weather deck':'N'
  },
  'Compressed air lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'M','Fuel and changeover tanks':'M','Fresh cooling water tanks':'M','Lubricating oil tanks':'M','Hydraulic oil tanks':'N','Drinking water tanks':'X','Thermal oil tanks':'N','Condensate and feedwater tanks':'X','Accommodation':'N','Cargo tanks, tank ships':'X','Cofferdams, tank ships':'N','Cargo pump rooms':'N','Weather deck':'N'
  },
  'Hydraulic lines': {
    'Machinery spaces':'N','Cofferdams / void spaces':'M','Cargo holds':'M','Ballast water tanks':'M','Fuel and changeover tanks':'M','Fresh cooling water tanks':'X','Lubricating oil tanks':'X','Hydraulic oil tanks':'N','Drinking water tanks':'X','Thermal oil tanks':'X','Condensate and feedwater tanks':'X','Accommodation':'X','Cargo tanks, tank ships':'N','Cofferdams, tank ships':'N','Cargo pump rooms':'N','Weather deck':'N'
  },
});

// ===== Extensión de columnas para nuevos espacios =====
(() => {
  const tailBySystem = {
    'Bilge lines':            ['X','M'],
    'Ballast lines':          ['X','-'],
    'Seawater lines':         ['X','X'],
    'Fuel lines':             ['X','X'],
    'Lubricating lines':      ['X','X'],
    'Thermal oil lines':      ['X','X'],
    'Steam lines':            ['X','X'],
    'Condensate lines':       ['X','X'],
    'Feedwater lines':        ['X','X'],
    'Drinking water lines':   ['X','X'],
    'Fresh cooling water lines':['X','X'],
    'Compressed air lines':   ['X','X'],
    'Hydraulic lines':        ['X','X'],
  };
  Object.entries(tailBySystem).forEach(([sys, [bw, gw]]) => {
    if (MATRIX[sys]) {
      MATRIX[sys]['Blackwater Tanks'] = bw;
      MATRIX[sys]['Greywater Tanks']  = gw;
    }
  });
})();

// ===== Nuevas filas en MATRIX =====
MATRIX['Blackwater lines'] = {
  'Machinery spaces':'N',
  'Cofferdams / void spaces':'M',
  'Cargo holds':'-',
  'Ballast water tanks':'X',
  'Fuel and changeover tanks':'X',
  'Fresh cooling water tanks':'X',
  'Lubricating oil tanks':'X',
  'Hydraulic oil tanks':'X',
  'Drinking water tanks':'X',
  'Thermal oil tanks':'X',
  'Condensate and feedwater tanks':'X',
  'Accommodation':'N',
  'Cargo tanks, tank ships':'X',
  'Cofferdams, tank ships':'X',
  'Cargo pump rooms':'N',
  'Weather deck':'N',
  'Blackwater Tanks':'M',
  'Greywater Tanks':'M',
};

MATRIX['Greywater lines'] = {
  'Machinery spaces':'N',
  'Cofferdams / void spaces':'M',
  'Cargo holds':'-',
  'Ballast water tanks':'X',
  'Fuel and changeover tanks':'X',
  'Fresh cooling water tanks':'X',
  'Lubricating oil tanks':'X',
  'Hydraulic oil tanks':'X',
  'Drinking water tanks':'X',
  'Thermal oil tanks':'X',
  'Condensate and feedwater tanks':'X',
  'Accommodation':'N',
  'Cargo tanks, tank ships':'X',
  'Cofferdams, tank ships':'X',
  'Cargo pump rooms':'N',
  'Weather deck':'N',
  'Blackwater Tanks':'M',
  'Greywater Tanks':'M',
};

const matrix_rendered = MATRIX;

// ==============================
// Datos de diámetros / schedules (Tablas 11.6–11.8)
// ==============================
const SCHEDULES = [
  { nps: '1/8', dn: 6,   od: 10.3, label: 'DN6 (1/8) – OD 10,3',   t: { '5S': null,'5': null,'10S':1.24,'10':1.24,'40S':1.73,'40':1.73,'80S':2.41,'80':2.41,'160': null } },
  { nps: '1/4', dn: 8,   od: 13.7, label: 'DN8 (1/4) – OD 13,7',   t: { '5S': null,'5': null,'10S':1.65,'10':1.65,'40S':2.24,'40':2.24,'80S':3.02,'80':3.02,'160': null } },
  { nps: '3/8', dn: 10,  od: 17.2, label: 'DN10 (3/8) – OD 17,2',  t: { '5S': null,'5': null,'10S':1.65,'10':1.65,'40S':2.31,'40':2.31,'80S':3.20,'80':3.20,'160': null } },
  { nps: '1/2', dn: 15,  od: 21.3, label: 'DN15 (1/2) – OD 21,3',  t: { '5S':1.65,'5':1.65,'10S':2.11,'10':2.11,'40S':2.77,'40':2.77,'80S':3.73,'80':3.73,'160':4.78 } },
  { nps: '3/4', dn: 20,  od: 26.7, label: 'DN20 (3/4) – OD 26,7',  t: { '5S':1.65,'5':1.65,'10S':2.11,'10':2.11,'40S':2.87,'40':2.87,'80S':3.91,'80':3.91,'160':5.56 } },
  { nps: '1',   dn: 25,  od: 33.4, label: 'DN25 (1) – OD 33,4',    t: { '5S':1.65,'5':1.65,'10S':2.77,'10':2.77,'40S':3.38,'40':3.38,'80S':4.55,'80':4.55,'160':6.35 } },
  { nps: '1 1/4', dn:32, od:42.2,  label: 'DN32 (1¼) – OD 42,2',   t: { '5S':1.65,'5':1.65,'10S':2.77,'10':2.77,'40S':3.56,'40':3.56,'80S':4.85,'80':4.85,'160':6.35 } },
  { nps: '1 1/2', dn:40, od:48.3,  label: 'DN40 (1½) – OD 48,3',   t: { '5S':1.65,'5':1.65,'10S':2.77,'10':2.77,'40S':3.68,'40':3.68,'80S':5.08,'80':5.08,'160':7.14 } },
  { nps: '2',   dn: 50,  od: 60.3, label: 'DN50 (2) – OD 60,3',    t: { '5S':1.65,'5':1.65,'10S':2.77,'10':2.77,'40S':3.91,'40':3.91,'80S':5.54,'80':5.54,'160':8.74 } },
  { nps: '2 1/2',dn:65,  od: 73.0, label: 'DN65 (2½) – OD 73,0',   t: { '5S':2.11,'5':2.11,'10S':3.05,'10':3.05,'40S':5.16,'40':5.16,'80S':7.01,'80':7.01,'160':9.53 } },
  { nps: '3',   dn: 80,  od: 88.9, label: 'DN80 (3) – OD 88,9',    t: { '5S':2.11,'5':2.11,'10S':3.05,'10':3.05,'40S':5.49,'40':5.49,'80S':7.62,'80':7.62,'160':11.13 } },
  { nps: '3 1/2',dn:90,  od:101.6, label: 'DN90 (3½) – OD 101,6',  t: { '5S':2.11,'5':2.11,'10S':3.05,'10':3.05,'40S':5.74,'40':5.74,'80S':8.08,'80':8.08,'160': null } },
  { nps: '4',   dn:100,  od:114.3, label: 'DN100 (4) – OD 114,3',  t: { '5S':2.11,'5':2.11,'10S':3.05,'10':3.05,'40S':6.02,'40':6.02,'80S':8.56,'80':11.13,'160':13.49 } },
  { nps: '5',   dn:125,  od:141.3, label: 'DN125 (5) – OD 141,3',  t: { '5S':2.77,'5':2.77,'10S':3.40,'10':3.40,'40S':6.55,'40':6.55,'80S':9.53,'80':9.53,'160':15.88 } },
  { nps: '6',   dn:150,  od:168.3, label: 'DN150 (6) – OD 168,3',  t: { '5S':2.77,'5':2.77,'10S':3.40,'10':3.40,'40S':7.11,'40':7.11,'80S':10.97,'80':10.97,'160':18.26 } },
  { nps: '8',   dn:200,  od:219.1, label: 'DN200 (8) – OD 219,1',  t: { '5S':2.77,'5':2.77,'10S':3.76,'10':3.76,'40S':8.18,'40':8.18,'80S':12.70,'80':12.70,'160':23.01 } },
  { nps: '10',  dn:250,  od:273.1, label: 'DN250 (10) – OD 273,1', t: { '5S':3.40,'5':3.40,'10S':4.19,'10':4.19,'40S':9.27,'40':9.27,'80S':12.70,'80':15.09,'160':28.58 } },
  { nps: '12',  dn:300,  od:323.9, label: 'DN300 (12) – OD 323,9', t: { '5S':3.96,'5':3.96,'10S':4.57,'10':4.57,'40S':9.53,'40':10.31,'80S':12.70,'80':17.48,'160':33.32 } }
];

// ==============================
// Tablas 11.6–11.8 como INTERVALOS [min,max]
// ==============================
const STEEL = {
  'N': [[10.2,13.5,1.6],[13.5,20.0,1.8],[20.0,48.3,2.0],[48.3,70.0,2.3],[70.0,88.9,2.6],[88.9,114.3,2.9],[114.3,133.0,3.2],[133.0,152.4,3.6],[152.4,177.8,4.0],[177.8,244.5,4.5],[244.5,323.9,5.0],[323.9,Infinity,5.6]],
  'M': [[21.3,38.0,3.2],[38.0,51.0,3.6],[51.0,76.1,4.0],[76.1,177.8,4.5],[177.8,193.7,5.0],[193.7,219.1,5.4],[219.1,244.5,5.9],[244.5,406.4,6.3],[406.4,660.4,6.3],[660.4,762.0,7.1],[762.0,863.6,8.0],[863.6,914.4,8.8],[914.4,Infinity,10.0]],
  'D': [[38.0,88.9,6.3],[88.9,114.3,7.1],[114.3,152.4,8.0],[152.4,Infinity,8.8]]
};
const INOX = [[0,17.2,1.0],[17.2,48.3,1.6],[48.3,88.9,2.0],[88.9,168.3,2.3],[168.3,219.1,2.6],[219.1,273.0,2.9],[273.0,406.0,3.6],[406.0,Infinity,4.0]];
const TABLE_118 = [
  { daMin: 8,    daMax: 10,    s: { copper: 1.0, copper_alloy: 0.8 } },
  { daMin: 12,   daMax: 20,    s: { copper: 1.2, copper_alloy: 1.0 } },
  { daMin: 25,   daMax: 44.5,  s: { copper: 1.5, copper_alloy: 1.2 } },
  { daMin: 50,   daMax: 76.1,  s: { copper: 2.0, copper_alloy: 1.5 } },
  { daMin: 88.9, daMax: 108,   s: { copper: 2.5, copper_alloy: 2.0 } },
  { daMin: 133,  daMax: 159,   s: { copper: 3.0, copper_alloy: 2.5 } },
  { daMin: 193.7,daMax: 267,   s: { copper: 3.5, copper_alloy: 3.0 } },
  { daMin: 273,  daMax: 457.2, s: { copper: 4.0, copper_alloy: 3.5 } },
  { daMin: 508,  daMax: 508,   s: { copper: 4.5, copper_alloy: 4.0 } }
];

function inRangeClosedOpen(x,a,b){return x>=a && x<b;}
function inRangeClosed(x,a,b){return x>=a && x<=b;}
function tSteel(group,da){const arr=STEEL[group]||[];for(const[lo,hi,s]of arr){if(inRangeClosedOpen(da,lo,hi))return s;}return null;}
function tInox(da){for(const[lo,hi,s]of INOX){if(inRangeClosedOpen(da,lo,hi))return s;}return null;}
function tCopperFamily(da,subtype){
  for(const row of TABLE_118){
    if(inRangeClosed(da,row.daMin,row.daMax)){
      return row.s[subtype] ?? null;
    }
  }
  return null;
}

// ===== Etiquetas ES (sin cambiar las claves internas) =====
const SPACES_LABELS = {
  'Machinery spaces': 'Espacios de máquinas',
  'Cofferdams / void spaces': 'Espacios de separación (cofferdams / voids)',
  'Cargo holds': 'Bodegas de carga',
  'Ballast water tanks': 'Tanques de agua de lastre',
  'Fuel and changeover tanks': 'Tanques de combustible y conmutación',
  'Fresh cooling water tanks': 'Tanques de agua dulce de enfriamiento',
  'Lubricating oil tanks': 'Tanques de aceite lubricante',
  'Hydraulic oil tanks': 'Tanques de aceite hidráulico',
  'Drinking water tanks': 'Tanques de agua potable',
  'Thermal oil tanks': 'Tanques de aceite térmico',
  'Condensate and feedwater tanks': 'Tanques de condensado y agua de alimentación',
  'Accommodation': 'Acomodaciones / habitabilidad',
  'Cargo tanks, tank ships': 'Tanques de carga (buques tanque)',
  'Cofferdams, tank ships': 'Espacios de separación en buques tanque (cofferdams)',
  'Cargo pump rooms': 'Salas de bombas de carga',
  'Weather deck': 'Cubierta expuesta (weather deck)',
  // ↓↓↓ NUEVOS ESPACIOS
  'Blackwater Tanks': 'Tanques de aguas negras',
  'Greywater Tanks': 'Tanques de aguas grises',
};

const SYSTEMS_LABELS = {
  'Bilge lines': 'Líneas de sentina (Achique)',
  'Ballast lines': 'Líneas de lastre',
  'Seawater lines': 'Líneas de agua de mar',
  'Fuel lines': 'Líneas de combustible',
  'Lubricating lines': 'Líneas de lubricación',
  'Thermal oil lines': 'Líneas de aceite térmico',
  'Steam lines': 'Líneas de vapor',
  'Condensate lines': 'Líneas de condensado',
  'Feedwater lines': 'Líneas de agua de alimentación',
  'Drinking water lines': 'Líneas de agua potable',
  'Fresh cooling water lines': 'Líneas de agua dulce de enfriamiento',
  'Compressed air lines': 'Líneas de aire comprimido',
  'Hydraulic lines': 'Líneas hidráulicas',
  // ↓↓↓ NUEVOS SISTEMAS
  'Blackwater lines': 'Líneas de aguas negras',
  'Greywater lines': 'Líneas de aguas grises',
};

// Mensaje canónico para “–”
const MSG_AGREEMENT = 'Validar con el diseñador del sistema y con casa clasificadora';

const mmFormatter = new Intl.NumberFormat('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 1 });
function formatMM(value){
  return mmFormatter.format(Number(value));
}
function findScheduleByOd(od){
  const target=Number(od);
  if(Number.isNaN(target)) return null;
  return SCHEDULES.find(r=>Math.abs(r.od-target)<1e-6) || null;
}
function parseRangeKey(rangeKey){
  return (rangeKey||'').split('-').map(v=>Number(v));
}
function findTable118Range(rangeKey){
  const [min,max]=parseRangeKey(rangeKey);
  if(Number.isNaN(min) || Number.isNaN(max)) return null;
  return TABLE_118.find(r=>Math.abs(r.daMin-min)<1e-6 && Math.abs(r.daMax-max)<1e-6) || null;
}
function getSFrom118(rangeKey,sub){
  const row=findTable118Range(rangeKey);
  return row?row.s[sub]??null:null;
}
// ===== Notas contextuales (GL / IMO / COTECMAR) =====
function computeNotes(systemKey, spaceKey) {
  const isBW = systemKey === 'Blackwater lines' || spaceKey === 'Blackwater Tanks';
  const isGW = systemKey === 'Greywater lines'  || spaceKey === 'Greywater Tanks';
  const isDW = systemKey === 'Drinking water lines' || spaceKey === 'Drinking water tanks';

  // 1) Agua potable con negras/grises → IMO
  if (isDW && (isBW || isGW)) {
    return 'Clasificación considerando IMO. GL 2015 no detalla la relación de agua potable con aguas negras/grises.';
  }

  // 2) Cualquier combinación que incluya negras o grises (sin potable) → COTECMAR
  if (isBW || isGW) {
    return 'Definición según COTECMAR. Confirmar con Diseñador.';
  }

  // 3) Resto de combinaciones → GL 2015
  return 'Definición tomada de GL 2015.';
}
function pickSchedule(mat,od,sMin){
  const orderSteel=['5','10','40','80','160'];
  const orderStainless=['5S','10S','40S','80S'];
  if(mat==='steel' || mat==='stainless'){
    const rec=findScheduleByOd(od);
    if(!rec) return {sch:null,t:null};
    const order=mat==='steel'?orderSteel:orderStainless;
    for(const sch of order){
      const t=rec.t[sch];
      if(t!=null && t>=sMin-1e-9){
        return {sch,t};
      }
    }
    return {sch:null,t:null};
  }
  return {sch:null,t:null};
}

// ==============================
// UI helpers
// ==============================
// ===== Notas: helpers =====
function setNote(text) {
  const card = document.getElementById('notesCard');
  const txt  = document.getElementById('notesText');
  if (!card || !txt) return;
  txt.textContent = text;
  card.dataset.state = 'active';
  if (card.style.display === 'none') {
    card.style.display = '';
  }
}

function resetNotes() {
  const card = document.getElementById('notesCard');
  const txt  = document.getElementById('notesText');
  if (!card || !txt) return;
  txt.textContent = '';
  card.dataset.state = 'idle';
  // Para ocultar completamente la tarjeta en estado "idle",
  // descomente la siguiente línea:
  // card.style.display = 'none';
}

function fillSelect(id,arr,labelMap){
  const el=document.getElementById(id);
  el.innerHTML='';
  arr.forEach(v=>{
    const o=document.createElement('option');
    o.value = v;
    o.textContent = labelMap[v] || v;
    el.appendChild(o);
  });
}

function drawViz({status,place,system,s}){
  const svg=document.getElementById('viz');
  const w=svg.clientWidth||560;
  const h=svg.clientHeight||420;
  const pad=28;
  const tankX=pad,tankY=pad,tankW=w-pad*2,tankH=h-pad*2;
  const pipeH=Math.max(32,tankH*0.2);
  const pipeY=tankY+tankH/2;
  const availableLeft=Math.max(0,tankX-6);
  const availableRight=Math.max(0,w-(tankX+tankW)-6);
  const maxExtension=Math.max(0,Math.min(availableLeft,availableRight));
  const pipeExtension=Math.min(Math.max(18,tankW*0.06),maxExtension);
  const pipeX=tankX-pipeExtension;
  const pipeW=Math.max(0,tankW+pipeExtension*2);
  const color=status==='ok'?'var(--ok)':status==='warn'?'var(--warn)':'var(--bad)';
  const tankTop=status==='bad'?'#40202b':status==='warn'?'#3a2c15':'#1f2937';
  const tankBottom=status==='bad'?'#1a0c12':status==='warn'?'#17100a':'#0b1120';
  const icon=status==='ok'?'✔':status==='warn'?'!':'✖';
  const note=status==='warn'?MSG_AGREEMENT:status==='bad'?'Paso bloqueado':'Paso permitido';
  const pipeStroke=status==='warn'?'stroke-dasharray="20 12" stroke-width="4"':'stroke-width="2.4"';
  const filterId=status==='bad'?'glowBad':status==='warn'?'glowWarn':'glowOk';
  const placeES = SPACES_LABELS[place] || place;
  const systemES = SYSTEMS_LABELS[system] || system;
  svg.innerHTML=`
    <div class="viz-title"></div>
    <div class="viz-check" aria-hidden="true"></div>
    <svg width="100%" height="100%" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="${systemES} → ${placeES}">
    <defs>
      <linearGradient id="tankGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="${tankTop}" />
        <stop offset="100%" stop-color="${tankBottom}" />
      </linearGradient>
      <linearGradient id="pipeGrad" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stop-color="${color}" stop-opacity="0.55" />
        <stop offset="50%" stop-color="${color}" stop-opacity="1" />
        <stop offset="100%" stop-color="${color}" stop-opacity="0.55" />
      </linearGradient>
      <filter id="glowOk" x="-40%" y="-40%" width="180%" height="180%">
        <feDropShadow dx="0" dy="0" stdDeviation="8" flood-color="#22c55e" flood-opacity="0.65"/>
      </filter>
      <filter id="glowWarn" x="-40%" y="-40%" width="180%" height="180%">
        <feDropShadow dx="0" dy="0" stdDeviation="8" flood-color="#f59e0b" flood-opacity="0.6"/>
      </filter>
      <filter id="glowBad" x="-40%" y="-40%" width="180%" height="180%">
        <feDropShadow dx="0" dy="0" stdDeviation="9" flood-color="#f43f5e" flood-opacity="0.7"/>
      </filter>
    </defs>
    <rect x="${tankX}" y="${tankY}" rx="28" ry="28" width="${tankW}" height="${tankH}" fill="url(#tankGrad)" stroke="rgba(148,163,184,0.35)" stroke-width="2.2"/>
    <g filter="url(#${filterId})">
      <rect x="${pipeX}" y="${pipeY-pipeH/2}" width="${pipeW}" height="${pipeH}" rx="0" ry="0" fill="url(#pipeGrad)" stroke="${color}" ${pipeStroke} opacity="0.95"/>
    </g>
    <text x="${tankX+tankW/2}" y="${pipeY-pipeH/2-16}" text-anchor="middle" font-size="13" fill="rgba(226,232,240,0.78)">${systemES}</text>
    <text x="${tankX+tankW/2}" y="${tankY+tankH-24}" text-anchor="middle" font-size="12" fill="rgba(226,232,240,0.64)">${note}</text>
    ${status==='bad'?`<line x1="${tankX+18}" y1="${tankY+18}" x2="${tankX+tankW-18}" y2="${tankY+tankH-18}" stroke="${color}" stroke-width="6" stroke-linecap="round" opacity="0.72"/>`:''}
    ${status==='bad'?`<line x1="${tankX+tankW-18}" y1="${tankY+18}" x2="${tankX+18}" y2="${tankY+tankH-18}" stroke="${color}" stroke-width="6" stroke-linecap="round" opacity="0.72"/>`:''}
  </svg>`;
  const titleNode=svg.querySelector('.viz-title');
  if(titleNode){
    titleNode.textContent=placeES;
  }
  const checkNode=svg.querySelector('.viz-check');
  if(checkNode){
    checkNode.textContent=icon;
    checkNode.style.color=color;
    checkNode.style.borderColor=color;
  }
}

const materialSel=document.getElementById('material');
const copperSub=document.getElementById('copperSub');
const copperTypeSel=document.getElementById('copperType');
const daSelect=document.getElementById('daSelect');
const daHelp=document.getElementById('daHelp');
const btnDaValidate=document.getElementById('btnDaValidate');
const sLine=document.getElementById('sLine');
const schLine=document.getElementById('schLine');

function setDaHelp(message,{isError=false}={}){
  daHelp.textContent=message;
  if(isError){
    daHelp.classList.add('error');
  } else {
    daHelp.classList.remove('error');
  }
}

let selectedDaKey=null;
let selectedDaText='';

function setDaSelection(key,label){
  if(key==null){
    window.__daSelection__={key:null,label:''};
    return;
  }
  const mat=materialSel.value;
  if(mat==='steel' || mat==='stainless'){
    const numericKey=Number(key);
    window.__daSelection__={
      key:Number.isNaN(numericKey)?null:numericKey,
      label:label||''
    };
  } else {
    window.__daSelection__={key:String(key),label:label||''};
  }
}

function getDaSelection(){
  return window.__daSelection__ || { key:null, label:'' };
}

function setSLineValue(value){
  if(value==null){
    sLine.textContent='s = — mm';
  } else {
    sLine.textContent=`s = ${value.toFixed(1)} mm`;
  }
}

function setSchLineValue(text){
  schLine.textContent=text && text.trim()?text:' ';
}

function updateGroupHint(value){
  const hint=document.getElementById('groupHint');
  if(hint){
    hint.textContent=value;
  }
}

function resetResults(){
  document.getElementById('headline').textContent='—';
  document.getElementById('explain').textContent='—';
  updateGroupHint('—');
  document.getElementById('outTbl').style.display='none';
  setSLineValue(null);
  setSchLineValue('');
  setSummary('');
}

function toggleCopperSub(){
  copperSub.classList.toggle('hidden', materialSel.value !== 'copper_family');
}

function populateDaOptions(){
  const mat=materialSel.value;
  let options=[];
  const hadFocus=document.activeElement===daSelect;
  if(mat==='steel' || mat==='stainless'){
    options=SCHEDULES.map(r=>({key:String(r.od),text:r.label}));
  } else if(mat==='copper_family'){
    options=TABLE_118.map(r=>({key:`${r.daMin}-${r.daMax}`,text:`${formatMM(r.daMin)} – ${formatMM(r.daMax)} mm`}));
  }
  daSelect.innerHTML='';
  if(!options.length){
    selectedDaKey=null;
    selectedDaText='';
    setDaHelp('Sin opciones disponibles');
    return 0;
  }
  const validated=getDaSelection();
  const validatedKey=validated.key!=null?String(validated.key):'';
  const pendingKey=selectedDaKey!=null?String(selectedDaKey):'';
  const targetKey=pendingKey || validatedKey;
  let matchedText='';

  const placeholder=document.createElement('option');
  placeholder.value='';
  placeholder.textContent='Selecciona un diámetro…';
  placeholder.disabled=true;
  daSelect.appendChild(placeholder);

  options.forEach(o=>{
    const opt=document.createElement('option');
    opt.value=o.key;
    opt.textContent=o.text;
    if(targetKey && o.key===targetKey){
      opt.selected=true;
      matchedText=o.text;
    }
    daSelect.appendChild(opt);
  });

  if(targetKey && matchedText){
    placeholder.selected=false;
    selectedDaKey=targetKey;
    selectedDaText=matchedText;
  } else {
    placeholder.selected=true;
    selectedDaKey=null;
    selectedDaText='';
    if(targetKey){
      setDaSelection(null,'');
    }
  }

  if(hadFocus){
    daSelect.focus();
  }

  if(!(validated.key!=null)){
    setDaHelp(`${options.length} opciones disponibles.`);
  }

  return options.length;
}

function calc(){
  const system=document.getElementById('system').value;
  const locationSel=document.getElementById('location').value;
  const mat=materialSel.value;
  const matLabelBase=MATERIAL_ES?.[mat] || materialSel.options[materialSel.selectedIndex]?.text || 'Material';
  const table=document.getElementById('outTbl');
  const {key:daKeyRaw,label:daLabel}=getDaSelection();

  const noteText = computeNotes(system, locationSel);
  setNote(noteText);

  if(daKeyRaw==null || daKeyRaw===''){
    resetResults();
    return;
  }

  const daKey=(mat==='steel' || mat==='stainless')?Number(daKeyRaw):daKeyRaw;
  if((mat==='steel' || mat==='stainless') && (Number.isNaN(daKey) || !isFinite(daKey))){
    resetResults();
    return;
  }

  const cell=(MATRIX[system]||{})[locationSel];
  let symbol=normalizeSymbol(cell);
  let group=null;

  if(symbol==='-'){
    drawViz({status:'warn', place:locationSel, system});
    document.getElementById('headline').innerHTML='<span class="pill warn">Especial (–)</span>';
    document.getElementById('explain').textContent=MSG_AGREEMENT;
    updateGroupHint('—');
    setSLineValue(null);
    setSchLineValue('SCH NO disponible');
    table.style.display='none';
    setSummary('');
    return;
  }

  if(symbol==='X'){
    drawViz({status:'bad',place:locationSel,system});
    document.getElementById('headline').innerHTML='<span class="pill bad">No compatible</span>';
    document.getElementById('explain').textContent='La normativa vigente marca “X”: la tubería no debe instalarse en esta ubicación.';
    updateGroupHint('—');
    setSLineValue(null);
    setSchLineValue('SCH NO disponible');
    table.style.display='none';
    setSummary('');
    return;
  }

  let s=null;
  let rule='';
  let selectionLabel=daLabel||'';
  let odValue=null;
  let subtypeLabel='';

  if(mat==='steel'){
    group=symbol;
    updateGroupHint(group);
    const rec=findScheduleByOd(Number(daKey));
    if(!rec){
      drawViz({status:'bad',place:locationSel,system});
      document.getElementById('headline').innerHTML='<span class="pill bad">Fuera de rango (acero)</span>';
      document.getElementById('explain').textContent='La selección no coincide con los diámetros de referencia disponibles para este grupo.';
      setSLineValue(null);
      setSchLineValue('SCH NO disponible');
      table.style.display='none';
      setSummary('');
      return;
    }
    odValue=rec.od;
    selectionLabel=selectionLabel || rec.label;
    s=tSteel(group,odValue);
    if(s==null){
      drawViz({status:'bad',place:locationSel,system});
      document.getElementById('headline').innerHTML='<span class="pill bad">Fuera de rango (acero)</span>';
      document.getElementById('explain').textContent=`El diámetro seleccionado (${selectionLabel}) no se encuentra en los intervalos permitidos para el grupo ${group}.`;
      setSLineValue(null);
      setSchLineValue('SCH NO disponible');
      table.style.display='none';
      setSummary('');
      return;
    }
    rule=`${matLabelBase} · grupo ${group}.`;
  } else if(mat==='stainless'){
    updateGroupHint('—');
    const rec=findScheduleByOd(Number(daKey));
    if(!rec){
      drawViz({status:'bad',place:locationSel,system});
      document.getElementById('headline').innerHTML='<span class="pill bad">Fuera de rango (inox)</span>';
      document.getElementById('explain').textContent='La selección no coincide con los diámetros normativos disponibles para este material.';
      setSLineValue(null);
      setSchLineValue('SCH NO disponible');
      table.style.display='none';
      setSummary('');
      return;
    }
    odValue=rec.od;
    selectionLabel=selectionLabel || rec.label;
    s=tInox(odValue);
    if(s==null){
      drawViz({status:'bad',place:locationSel,system});
      document.getElementById('headline').innerHTML='<span class="pill bad">Fuera de rango (inox)</span>';
      document.getElementById('explain').textContent='El diámetro seleccionado no cae en los intervalos normativos definidos para el material.';
      setSLineValue(null);
      setSchLineValue('SCH NO disponible');
      table.style.display='none';
      setSummary('');
      return;
    }
    rule=`${matLabelBase}.`;
  } else if(mat==='copper_family'){
    updateGroupHint('—');
    const sub=copperTypeSel.value;
    const rangeRow=findTable118Range(String(daKey));
    if(!rangeRow){
      drawViz({status:'bad',place:locationSel,system});
      document.getElementById('headline').innerHTML='<span class="pill bad">Fuera de rango (cobre)</span>';
      document.getElementById('explain').textContent='El rango seleccionado no figura en la referencia normativa.';
      setSLineValue(null);
      setSchLineValue('SCH NO disponible');
      table.style.display='none';
      setSummary('');
      return;
    }
    selectionLabel=selectionLabel || `${formatMM(rangeRow.daMin)} – ${formatMM(rangeRow.daMax)} mm`;
    s=getSFrom118(String(daKey),sub);
    if(s==null){
      drawViz({status:'bad',place:locationSel,system});
      document.getElementById('headline').innerHTML='<span class="pill bad">Fuera de rango (cobre)</span>';
      document.getElementById('explain').textContent='No existe espesor disponible para el subtipo seleccionado en ese rango.';
      setSLineValue(null);
      setSchLineValue('SCH NO disponible');
      table.style.display='none';
      setSummary('');
      return;
    }
    subtypeLabel=MATERIAL_ES?.[sub] || copperTypeSel.options[copperTypeSel.selectedIndex]?.text || '';
    rule=`${matLabelBase}. ${subtypeLabel?`Subtipo: ${subtypeLabel}.`:''}`.trim();
  } else {
    updateGroupHint('—');
    rule=`${matLabelBase}.`;
  }

  drawViz({status:'ok',place:locationSel,system,s});
  document.getElementById('headline').innerHTML='<span class="pill ok">Compatible</span>';
  const explainHTML=`Espesor mínimo <b>s = ${s.toFixed(1)} mm</b>. ${rule}`;
  document.getElementById('explain').innerHTML=stripTableRefs(explainHTML);
  setSLineValue(s);

  const groupLetter=(mat==='steel')?(group||'—'):'';
  const selDaLabel=selectionLabel || '—';
  // === Obtener SCH sugerido solo para acero/inox ===
  let schSuggested=null;
  let schData=null;
  if((mat==='steel' || mat==='stainless') && odValue!=null){
    const picked=pickSchedule(mat,odValue,s);
    schSuggested=picked.sch;
    schData=picked;
  }

  const summaryLines=[];
  if(mat==='steel' || mat==='stainless'){
    const schLabel=schSuggested?`SCH sugerido: SCH ${schSuggested}.`:'SCH sugerido: —.';
    summaryLines.push(schLabel);
  } else if(mat==='copper_family'){
    summaryLines.push('SCH sugerido: N/A.');
  }
  summaryLines.push(`Selección: ${selDaLabel}.`);
  setSummary(summaryLines.join('<br>'));

  const tbody=document.querySelector('#outTbl tbody');
  tbody.innerHTML='';
  const sysES=SYSTEMS_LABELS[system]||system;
  const locES=SPACES_LABELS[locationSel]||locationSel;
  const materialText=mat==='copper_family'
    ? `${matLabelBase}${subtypeLabel?` – ${subtypeLabel}`:''}`
    : matLabelBase;

  // === Construcción de filas para #outTbl ===
  const rows=[];
  rows.push(['Sistema',sysES]);
  rows.push(['Ubicación',locES]);
  rows.push(['Material',materialText]);

  if(mat==='steel'){
    rows.push(['Grupo (si steel)',group||'—']);
  }

  if(mat==='copper_family'){
    rows.push(['Rango dₐ [mm]',selectionLabel]);
  } else {
    rows.push(['Selección dₐ',selectionLabel]);
    if(odValue!=null){
      rows.push(['OD [mm]',`${formatMM(odValue)} mm`]);
    }
  }

  rows.push(['Espesor s [mm]',s!=null?s.toFixed(1):'—']);

  let schCell='N/A';
  if(mat==='steel' || mat==='stainless'){
    schCell=schSuggested?`SCH ${schSuggested}`:'—';
  }
  rows.push(['SCH sugerido',schCell]);

  for(const[k,v]of rows){
    const tr=document.createElement('tr');
    const a=document.createElement('td');
    a.textContent=k;
    tr.appendChild(a);
    const b=document.createElement('td');
    b.innerHTML=String(v);
    tr.appendChild(b);
    tbody.appendChild(tr);
  }
  table.style.display='table';

  if(mat==='steel' || mat==='stainless'){
    setSchLineValue(schSuggested && schData?.t!=null
      ? `SCH recomendado: SCH ${schSuggested} [t = ${schData.t.toFixed(2)} mm]`
      : 'SCH NO disponible');
  } else {
    setSchLineValue('Referencia GL (sin schedule)');
  }
}

// INIT
fillSelect('system', SYSTEMS, SYSTEMS_LABELS);
fillSelect('location', SPACES, SPACES_LABELS);

function invalidateResults({preserveHelp=false,message=''}={}){
  resetResults();
  if(message){
    setDaHelp(message);

    return;
  }
  if(preserveHelp){
    return;
  }
  const validated=getDaSelection();
  const hasValidated=validated.key!=null && validated.key!=='';
  setDaHelp(hasValidated
    ? 'Parámetros cambiaron. Pulse Validar para recalcular.'
    : 'Seleccione un diámetro y pulse Validar.');
}

['system','location'].forEach(id=>{
  const el=document.getElementById(id);
  el.addEventListener('change',()=>{
    invalidateResults();
  });
  el.addEventListener('input',()=>invalidateResults());
});
function handleMaterialChange(){
  toggleCopperSub();
  selectedDaKey=null;
  selectedDaText='';
  populateDaOptions();
  setDaSelection(null,'');
  invalidateResults({message:'Seleccione un diámetro y pulse Validar.'});
}
materialSel.addEventListener('change',handleMaterialChange);
materialSel.addEventListener('input',handleMaterialChange);
copperTypeSel.addEventListener('change',()=>{
  invalidateResults();
});
daSelect.addEventListener('change',()=>{
  const opt=daSelect.options[daSelect.selectedIndex];
  if(!opt){
    selectedDaKey=null;
    selectedDaText='';
    return;
  }
  if(!opt.value){
    selectedDaKey=null;
    selectedDaText='';
    invalidateResults({message:'Seleccione un diámetro y pulse Validar.'});
    return;
  }
  invalidateResults({preserveHelp:true});
  selectedDaKey=opt.value;
  selectedDaText=opt.textContent;
  setDaHelp(`Seleccionado: ${selectedDaText}. Pulse Validar para aplicar.`);
});
btnDaValidate.addEventListener('click',()=>{
  if(selectedDaKey==null || selectedDaKey===''){
    setDaHelp('FALTA DIGITAR DIÁMETRO O TAMAÑO NOMINAL', {isError:true});
    return;
  }
  setDaSelection(selectedDaKey,selectedDaText);
  setDaHelp(`Validado: ${selectedDaText}`);
  calc();
  const systemKey = document.getElementById('system').value;
  const spaceKey  = document.getElementById('location').value;
  const note = computeNotes(systemKey, spaceKey);
  setNote(note);
});
(function mapLegacyMaterials(){
  const legacy=materialSel.value;
  if(legacy==='copper' || legacy==='copper_alloy'){
    materialSel.value='copper_family';
    copperTypeSel.value=legacy;
  }
})();
toggleCopperSub();
setDaSelection(null,'');
populateDaOptions();
setDaHelp('Seleccione un diámetro y pulse Validar.');
resetResults();

['system','location','material','copperType','daSelect'].forEach(id=>{
  const el=document.getElementById(id);
  if(el){
    el.addEventListener('change',resetNotes);
    el.addEventListener('input',resetNotes);
  }
});

window.addEventListener('DOMContentLoaded',()=>{
  resetNotes();
  cleanseLegacyTableRefs();
});
</script>

  <footer class="site-footer">
    <div class="footer-wrap">
      <div>Por <strong>Jhon Eric Gomez</strong> – DVMPR-GEDIN</div>
      <div>Para consultas contactar a: <a href="mailto:jegomez@cotecmar.com">jegomez@cotecmar.com</a></div>
    </div>
  </footer>
</body>
</html>

