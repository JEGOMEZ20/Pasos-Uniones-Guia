<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Evaluador de juntas · LR (Naval/Ships)</title>
<link rel="stylesheet" href="assets/css/app.css">
<style>
  :root {
    --ink: #eef2f8;
    --mut: rgba(203, 213, 225, 0.78);
    --card: linear-gradient(160deg, rgba(27, 40, 66, 0.95), rgba(12, 19, 34, 0.88));
    --border: rgba(148, 163, 184, 0.34);
    --ok: #34d399;
    --warn: #fbbf24;
    --bad: #f87171;
    --group: rgba(22, 34, 54, 0.72);
  }
  body {
    margin: 0;
    background: radial-gradient(circle at top, #1b2d4f 0%, #0f1c33 55%, #040915 100%);
    color: var(--ink);
    font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
  }
  .site-footer {
    margin: 60px 0 38px;
    text-align: center;
    font-size: 13px;
    color: rgba(203, 213, 225, 0.74);
  }
  .site-footer .footer-wrap {
    display: inline-grid;
    gap: 6px;
  }
  .site-footer a {
    color: inherit;
    text-decoration: underline;
  }
  .wrap {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 32px 60px;
    background: linear-gradient(160deg, rgba(19, 31, 52, 0.94), rgba(8, 15, 30, 0.88));
    border-radius: 34px;
    border: 1px solid rgba(148, 163, 184, 0.32);
    box-shadow: 0 40px 110px rgba(3, 9, 22, 0.6);
    backdrop-filter: blur(24px);
  }
  .page-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    margin: 12px 0 24px;
  }
  .page-header .logo-wrapper {
    margin-left: auto;
    display: flex;
    align-items: center;
    justify-content: flex-end;
  }
  .page-header .brand-logo {
    width: 120px;
    height: auto;
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(2, 6, 23, 0.55);
  }
  .h1 {
    font-size: clamp(24px, 3vw, 34px);
    font-weight: 700;
    margin: 0 0 18px;
  }
  .card {
    background: var(--card);
    color: var(--ink);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 24px 26px;
    box-shadow: 0 28px 70px rgba(4, 11, 28, 0.55);
    backdrop-filter: blur(18px);
  }
  .controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 14px;
  }
  .lbl {
    display: block;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--mut);
    margin: 0 0 6px;
  }
  select,
  input[type="number"] {
    width: 100%;
    border: 1px solid rgba(148, 163, 184, 0.45);
    border-radius: 16px;
    padding: 12px 14px;
    background: rgba(23, 35, 57, 0.78);
    color: var(--ink);
    font-size: 14px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
  }
  select:focus,
  input[type="number"]:focus {
    border-color: rgba(125, 211, 252, 0.85);
    box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.28);
    background: rgba(31, 48, 78, 0.9);
    outline: none;
  }
  .checks {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 16px;
    margin-top: 16px;
  }
  #classInfoCard {
    margin-top: 18px;
  }
  .info-card {
    border-radius: 18px;
    border: 1px solid rgba(148, 163, 184, 0.25);
    background: rgba(15, 23, 42, 0.55);
    box-shadow: 0 18px 34px rgba(2, 6, 23, 0.35);
    padding: 16px 18px;
    display: grid;
    gap: 8px;
  }
  .info-card-title {
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(226, 232, 240, 0.72);
  }
  .info-card-body {
    margin: 0;
    font-size: 14px;
    line-height: 1.6;
    font-family: inherit;
    white-space: pre-wrap;
    color: rgba(226, 232, 240, 0.9);
  }
  .info-card-hint {
    font-size: 12px;
    color: rgba(148, 163, 184, 0.75);
  }
  .check-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    font-size: 13px;
    color: var(--ink);
    padding: 14px 16px;
    border-radius: 18px;
    border: 1px solid rgba(148, 163, 184, 0.28);
    background: rgba(23, 35, 57, 0.55);
    box-shadow: inset 0 0 0 1px rgba(10, 16, 28, 0.36);
  }
  .check-item input {
    margin-top: 2px;
    flex-shrink: 0;
  }
  .check-text {
    display: grid;
    gap: 6px;
    flex: 1;
  }
  .check-item label {
    font-size: 13px;
    color: var(--ink);
    line-height: 1.5;
    display: block;
  }
  .check-item .mut {
    line-height: 1.4;
  }
  .axial-control .check-text {
    gap: 10px;
  }
  .axial-control select {
    margin-top: 4px;
  }
  .btn {
    background: #0ea5e9;
    color: #041628;
    border: 0;
    border-radius: 12px;
    padding: 11px 18px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    box-shadow: 0 12px 30px rgba(14, 165, 233, 0.32);
  }
  .btn:hover {
    background: #38bdf8;
    transform: translateY(-1px);
    box-shadow: 0 16px 34px rgba(14, 165, 233, 0.34);
  }
  .badge {
    font-size: 12px;
    border-radius: 999px;
    border: 1px solid;
    padding: 3px 10px;
    font-weight: 700;
  }
  .b-ok {
    color: #4ade80;
    border-color: rgba(74, 222, 128, 0.5);
    background: rgba(21, 128, 61, 0.35);
  }
  .b-warn {
    color: #facc15;
    border-color: rgba(250, 204, 21, 0.55);
    background: rgba(120, 53, 15, 0.35);
  }
  .b-bad {
    color: #f87171;
    border-color: rgba(248, 113, 113, 0.55);
    background: rgba(127, 29, 29, 0.35);
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 14px;
    align-items: stretch;
  }
  .result-card {
    display: flex;
    flex-direction: column;
    height: 100%;
    gap: 12px;
  }
  .group {
    background: var(--group);
    border: 1px solid rgba(148, 163, 184, 0.24);
    border-radius: 20px;
    padding: 18px;
    box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.22);
  }
  .g-title {
    font-weight: 700;
    font-size: 14px;
    color: var(--ink);
  }
  .g-sub {
    font-size: 12px;
    color: var(--mut);
    margin-top: 4px;
  }
  #notesChips,
  #generalChips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .chip,
  .note-chip,
  .rule-chip {
    font-size: 11px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.35);
    background: rgba(30, 41, 59, 0.85);
    color: var(--ink);
    padding: 4px 10px;
    cursor: pointer;
  }
  .mt-1 { margin-top: 4px; }
  .mt-2 { margin-top: 8px; }
  .mt-3 { margin-top: 12px; }
  .mt-4 { margin-top: 16px; }
  .mb-2 { margin-bottom: 8px; }
  .mb-3 { margin-bottom: 12px; }
  .mut { color: var(--mut); }
  .small { font-size: 12px; }
  .reasons {
    margin: 6px 0 0 18px;
    font-size: 12px;
    color: var(--mut);
  }
  .view-action {
    margin-top: auto;
    padding-top: 16px;
    display: flex;
    justify-content: flex-end;
  }
  .view-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.04em;
    padding: 10px 24px;
    border-radius: 999px;
    border: 0;
    background: #0ea5e9;
    color: #041628;
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 14px 28px rgba(14, 165, 233, 0.3);
  }
  .view-btn:hover {
    background: #38bdf8;
    transform: translateY(-1px);
    box-shadow: 0 18px 34px rgba(14, 165, 233, 0.34);
  }
  .view-btn:active {
    transform: translateY(0);
  }
  .empty-state {
    padding: 26px;
    border-radius: 18px;
    border: 1px dashed rgba(148, 163, 184, 0.35);
    background: rgba(15, 23, 42, 0.5);
    color: var(--ink);
    font-size: 14px;
    text-align: center;
  }
  .empty-state strong {
    color: #f8fafc;
  }
  /* Modal imagen */
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    z-index: 20;
  }
  .modal.open {
    display: flex;
  }
  .modal .box {
    background: rgba(15, 23, 42, 0.92);
    border: 1px solid rgba(51, 65, 85, 0.8);
    border-radius: 14px;
    padding: 18px;
    max-width: 95vw;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 14px;
    position: relative;
    box-shadow: 0 24px 40px rgba(2, 6, 23, 0.6);
  }
  .modal img {
    max-width: 90vw;
    max-height: 70vh;
    display: block;
    border-radius: 12px;
  }
  .modal .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: 0;
    color: rgba(148, 163, 184, 0.9);
    font-size: 24px;
    cursor: pointer;
    padding: 4px;
  }
  .modal .close-btn:hover {
    color: #e2e8f0;
  }
  .modal-caption {
    font-size: 14px;
    color: rgba(203, 213, 225, 0.85);
    text-align: center;
  }
  .note-modal .box {
    max-width: 520px;
    width: 100%;
    padding: 20px;
    color: var(--ink);
    display: grid;
    gap: 16px;
    background: rgba(15, 23, 42, 0.95);
  }
  .note-title {
    font-weight: 700;
    font-size: 16px;
  }
  .note-body {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    font-size: 14px;
  }
  .note-lang {
    font-weight: 600;
    color: rgba(148, 163, 184, 0.85);
    margin-bottom: 4px;
  }
  .note-modal .close-btn {
    justify-self: flex-end;
    position: static;
  }
  .note-modal .close-btn:hover {
    color: #e2e8f0;
  }
  body.modal-open {
    overflow: hidden;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header class="page-header">
      <a href="index.html" class="back-link">← Volver al inicio</a>
      <div class="logo-wrapper">
        <img src="assets/joints/cotec.jpg" alt="COTECMAR" class="brand-logo">
      </div>
    </header>
    <div class="h1">Evaluador de juntas – LR</div>

    <!-- Controles -->
    <div class="card mb-3">
      <div class="controls">
        <div>
          <label class="lbl">Norma</label>
          <select id="stdSel">
            <option value="naval">LR Naval</option>
            <option value="ships">LR Ships</option>
          </select>
        </div>
        <div>
          <label class="lbl">Grupo de sistema</label>
          <select id="groupSel"></select>
        </div>
        <div>
          <label class="lbl">Sistema</label>
          <select id="systemSel"></select>
        </div>
        <div>
          <label class="lbl">Clase de tubería</label>
          <select id="classSel">
            <option value="I">Clase I</option>
            <option value="II">Clase II</option>
            <option value="III">Clase III</option>
          </select>
        </div>
        <div>
          <label class="lbl">Diámetro exterior (OD) [mm]</label>
          <input id="odInp" type="number" value="25"/>
        </div>
        <div>
          <label class="lbl">Espacio</label>
          <select id="spaceSel"></select>
        </div>
      </div>
      <div class="checks">
        <div class="check-item">
          <div class="check-text">
            <label for="visibleSelect">Posición visible y accesible</label>
            <select id="visibleSelect">
              <option value="yes">Sí</option>
              <option value="no">No</option>
            </select>
          </div>
        </div>
        <div class="check-item">
          <div class="check-text">
            <label for="sameMediumSelect">(Si está en tanque) Medio del tubo coincide con el del tanque</label>
            <select id="sameMediumSelect">
              <option value="no">No coincide</option>
              <option value="yes">Sí coincide</option>
            </select>
          </div>
        </div>
        <div class="check-item axial-control">
          <div class="check-text">
            <label for="axialSelect">(Slip type) Requiere compensación axial</label>
            <select id="axialSelect">
              <option value="no">No requiere compensación</option>
              <option value="yes">Sí requiere compensación</option>
            </select>
          </div>
        </div>
        <div class="check-item">
          <input type="checkbox" id="chkAboveWLI" checked>
          <div class="check-text">
            <label for="chkAboveWLI">(Drenajes) Por encima del límite de estanqueidad</label>
            <div id="helpWLI" class="mut small mt-1">Requisito de la Nota 6 en LR Naval para drenes de cubierta internos.</div>
          </div>
        </div>
      </div>
      <div id="classInfoCard" style="display:none"></div>
      <div class="mt-3">
        <button id="btnEval" class="btn">Evaluar</button>
      </div>
    </div>

    <!-- Notas -->
    <div class="card mb-3">
      <div class="small" id="notesWrap">
        <div class="mb-2"><strong>Notas aplicables</strong></div>
        <div id="notesChips"></div>
        <div class="mt-2 mut small">Ensayo fuego (fila): <span id="fireRow">—</span> – ver Nota 7 para especificación.</div>
        <div class="mt-3">
          <div class="mb-2"><strong>Reglas generales</strong></div>
          <div id="generalChips"></div>
        </div>
      </div>
    </div>

    <!-- Resultados -->
    <div id="results"></div>
  </div>

  <!-- Modal -->
  <div id="imgModal" class="modal" onclick="hideImageModal()">
    <div class="box" onclick="event.stopPropagation()">
      <button type="button" class="close-btn" aria-label="Cerrar" onclick="hideImageModal()">&times;</button>
      <img id="imgModalSrc" alt="Figura de junta"/>
      <div id="imgModalCaption" class="modal-caption" style="display:none"></div>
    </div>
  </div>

  <div id="noteModal" class="modal note-modal" onclick="hideNoteModal()">
    <div class="box" onclick="event.stopPropagation()">
      <button type="button" class="close-btn" onclick="hideNoteModal()">&times;</button>
      <div id="noteTitle" class="note-title">Nota</div>
      <div class="note-body">
        <div>
          <div class="note-lang">ES</div>
          <p id="noteES"></p>
        </div>
        <div>
          <div class="note-lang">EN</div>
          <p id="noteEN"></p>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   DATASETS (LR Naval + LR Ships)
   ========================= */
function buildNaval(){
  const JOINT_TYPES = [
    { key: "pipe_union_welded_brazed", group: "Pipe unions", label: "Unión roscada soldada/soldadura fuerte" },
    { key: "comp_swage", group: "Compression couplings", label: "Compresión tipo swage" },
    { key: "comp_bite", group: "Compression couplings", label: "Compresión tipo bite" },
    { key: "comp_typical", group: "Compression couplings", label: "Compresión típica" },
    { key: "comp_flared", group: "Compression couplings", label: "Compresión tipo flare" },
    { key: "comp_press", group: "Compression couplings", label: "Compresión tipo press" },
    { key: "slip_mgrooved", group: "Slip-on joints", label: "Slip-on ranurado a máquina" },
    { key: "slip_grip", group: "Slip-on joints", label: "Slip-on tipo grip" },
    { key: "slip_type", group: "Slip-on joints", label: "Slip-on tipo slip" }
  ];
  const SPACES = [
    { key: "mach_cat_a", label: "Espacio de máquinas Cat. A" },
    { key: "accommodation", label: "Acomodaciones" },
    { key: "munitions", label: "Pañoles de municiones" },
    { key: "other_mach_service", label: "Otros esp. de máquinas/servicio" },
    { key: "open_deck", label: "Cubierta abierta" },
    { key: "cargo_hold", label: "Bodega de carga" },
    { key: "inside_tank", label: "Dentro de tanque" }
  ];
  const NOTES = {
    n1: {
      id: "n1",
      tag: "N1",
      titleES: "Tipo resistente al fuego en Cat. A",
      es: "Las juntas mecánicas con componentes que se deterioran con el fuego deben ser de tipo resistente al fuego cuando se instalen en espacios de máquinas Cat. A. En bilge main en Cat. A: acoplamientos de acero/CuNi o equivalente.",
      en: "Mechanical joints that include components which readily deteriorate in case of fire are to be of an approved fire-resistant type when fitted in machinery spaces of Category A. Mechanical couplings on the bilge main in Category A are to be of steel, CuNi or equivalent."
    },
    n2: {
      id: "n2",
      tag: "N2",
      titleES: "Restricciones a slip-on por espacio",
      es: "Los slip-on no se aceptan en espacios de máquinas Cat. A, pañoles de municiones o acomodaciones. En otros espacios de máquinas/servicio: solo si están en posiciones visibles y accesibles.",
      en: "Slip-on joints are not accepted inside machinery spaces of Category A, munition stores, or accommodation spaces. Accepted in other machinery/service spaces only where joints are in easily visible and accessible positions."
    },
    n3: {
      id: "n3",
      tag: "N3",
      titleES: "Tipo resistente al fuego salvo en cubierta abierta",
      es: "Las juntas mecánicas deben ser de tipo resistente al fuego aprobado, excepto cuando estén en cubiertas abiertas con poco o nulo riesgo de incendio.",
      en: "Mechanical joints are to be of an approved fire-resistant type, except when fitted on open decks with little or no fire risk."
    },
    n4: {
      id: "n4",
      tag: "N4",
      titleES: "Ensayo de resistencia al fuego",
      es: "Las juntas mecánicas deben ser de tipo resistente al fuego (ensayo requerido en ubicaciones indicadas).",
      en: "Mechanical joints are to be of an approved fire-resistant type (fire endurance test required at indicated locations)."
    },
    n5: {
      id: "n5",
      tag: "N5",
      titleES: "Slip type como medio principal",
      es: "Slip type no permitido como medio principal; solo si compensa deformación axial.",
      en: "Slip type not permitted as main means except where compensation of axial deformation is necessary."
    },
    n6: {
      id: "n6",
      tag: "N6",
      titleES: "Por encima del límite de estanqueidad",
      es: "Solo por encima del límite de estanqueidad al agua.",
      en: "Only permitted above the limit of watertight integrity."
    },
    n7: {
      id: "n7",
      tag: "N7",
      titleES: "Condición de ensayo de fuego",
      es: "Condición de ensayo (30 dry / 8+22 / 30 wet) según aplique.",
      en: "Fire endurance test condition (30 dry / 8+22 / 30 wet) as applicable."
    }
  };
  const GENERAL = {
    g_slip_on: {
      id: "g_slip_on",
      tag: "Regla 5.10.9",
      titleES: "Slip-on en bodegas/tanques",
      es: "Slip-on generalmente no en bodegas/tanques; en tanques solo si el medio coincide.",
      en: "Slip-on joints generally not to be used in cargo holds/tanks; inside tanks only where the medium is the same."
    },
    g_slip_type: {
      id: "g_slip_type",
      tag: "Regla 5.10.10",
      titleES: "Slip type como medio principal",
      es: "Slip type no como medio principal salvo para compensar dilatación axial.",
      en: "Slip type not as main means except for compensating axial deformation."
    }
  };
  const CLASS_RULES = {
    pipe_union_welded_brazed: { I:{allowed:true, odLE:60.3}, II:{allowed:true, odLE:60.3}, III:{allowed:true} },
    comp_swage: { I:{allowed:false}, II:{allowed:false}, III:{allowed:true} },
    comp_bite:  { I:{allowed:true, odLE:60.3}, II:{allowed:true, odLE:60.3}, III:{allowed:true} },
    comp_typical:{ I:{allowed:true, odLE:60.3}, II:{allowed:true, odLE:60.3}, III:{allowed:true} },
    comp_flared: { I:{allowed:true, odLE:60.3}, II:{allowed:true, odLE:60.3}, III:{allowed:true} },
    comp_press:  { I:{allowed:false}, II:{allowed:false}, III:{allowed:true} },
    slip_mgrooved:{ I:{allowed:true}, II:{allowed:true}, III:{allowed:true} },
    slip_grip:   { I:{allowed:false}, II:{allowed:true}, III:{allowed:true} },
    slip_type:   { I:{allowed:false}, II:{allowed:true}, III:{allowed:true} }
  };
  const allowAll = () => ({
    pipe_union_welded_brazed:true,
    comp_swage:true,
    comp_bite:true,
    comp_typical:true,
    comp_flared:true,
    comp_press:true,
    slip_mgrooved:true,
    slip_grip:true,
    slip_type:true
  });
  const SYSTEM_GROUPS = [
    { key:"flamm_lt60", label:"Fluidos inflamables (fp < 60°C)", systems:[
      { key:"veh_aircraft_fuel_lt60", label:"Líneas de combustible (vehículos / aeronaves)", allow:allowAll(), notes:["n2","n4"], fire:"30 min dry" },
      { key:"vent_lt60", label:"Líneas de venteo", allow:allowAll(), notes:["n3"], fire:"30 min dry" }
    ]},
    { key:"flamm_gt60", label:"Fluidos inflamables (fp > 60°C)", systems:[
      { key:"veh_aircraft_fuel_gt60", label:"Líneas de combustible (vehículos / aeronaves)", allow:allowAll(), notes:["n2","n4"], fire:"30 min dry" },
      { key:"machinery_fuel", label:"Líneas de combustible – maquinaria de a bordo", allow:allowAll(), notes:["n2","n3"], fire:"30 min wet" },
      { key:"lube_oil", label:"Líneas de aceite lubricante", allow:allowAll(), notes:["n2","n3"], fire:"30 min wet" },
      { key:"hydraulic_oil", label:"Aceite hidráulico", allow:allowAll(), notes:["n2","n3"], fire:"30 min wet" }
    ]},
    { key:"seawater", label:"Agua de mar", systems:[
      { key:"bilge", label:"Líneas de achique (bilge)", allow:allowAll(), notes:["n1"], fire:"8 dry + 22 wet" },
      { key:"hp_seawater", label:"Agua de mar HP / spray (no llenado permanente)", allow:allowAll(), notes:[], fire:"8 dry + 22 wet" },
      { key:"fire_perm", label:"Contra-incendios (llenado permanente)", allow:allowAll(), notes:["n3"], fire:"30 min wet" },
      { key:"fire_nonperm", label:"Contra-incendios (no permanente) / espuma / drencher", allow:allowAll(), notes:["n3"], fire:"8 dry + 22 wet" },
      { key:"ballast", label:"Lastre", allow:allowAll(), notes:["n1"], fire:"8 dry + 22 wet" },
      { key:"cooling_sw", label:"Refrigeración – agua de mar", allow:allowAll(), notes:["n1"], fire:"8 dry + 22 wet" },
      { key:"tank_cleaning_services", label:"Servicios de limpieza de tanques", allow:allowAll(), notes:[], fire:"Fire endurance test not required" },
      { key:"non_essential_systems", label:"Sistemas no esenciales", allow:allowAll(), notes:[], fire:"Fire endurance test not required" }
    ]},
    { key:"freshwater", label:"Agua dulce", systems:[
      { key:"cooling_fw", label:"Refrigeración – agua dulce", allow:allowAll(), notes:["n1"], fire:"(no aplica)" },
      { key:"chilled", label:"Agua helada (chilled)", allow:allowAll(), notes:["n1"], fire:"30 min wet" },
      { key:"cond_return", label:"Retorno de condensado", allow:allowAll(), notes:["n1"], fire:"(dry)" },
      { key:"demin", label:"Agua tratada / desmineralizada", allow:allowAll(), notes:[], fire:"(wet)" },
      { key:"ancillary", label:"Sistemas auxiliares (FW)", allow:allowAll(), notes:[], fire:"(dry)" }
    ]},
    { key:"sanitary", label:"Sanitarios / drenajes / escuppers", systems:[
      { key:"deck_drains_internal", label:"Drenajes de cubierta (internos)", allow:allowAll(), notes:["n6"], fire:"(no aplica)" },
      { key:"sanitary_drains", label:"Drenajes sanitarios", allow:allowAll(), notes:[], fire:"(dry)" },
      { key:"scuppers_overboard", label:"Scuppers y descarga (sobre costado)", allow:{...allowAll(), slip_mgrooved:false, slip_grip:false, slip_type:false}, notes:[], fire:"(dry)" }
    ]},
    { key:"sounding_vent", label:"Sondajes / venteos", systems:[
      { key:"water_tanks_dry_spaces", label:"Tanques de agua / espacios secos", allow:allowAll(), notes:[], fire:"Fire endurance test not required" },
      { key:"oil_tanks_fp_gt60", label:"Tanques de aceite (fp > 60°C)", allow:allowAll(), notes:["n2","n3"], fire:"Fire endurance test not required" },
      { key:"gas_turbine_intakes_uptakes", label:"Tomas y descargas de turbina de gas", allow:allowAll(), notes:["n7"], fire:"Fire endurance test not required" },
      { key:"hvac_trunking", label:"Conductos HVAC", allow:allowAll(), notes:["n7"], fire:"Fire endurance test not required" }
    ]},
    { key:"misc", label:"Misceláneos / gases / vapor", systems:[
      { key:"air_hp", label:"Aire alta presión (HP)", allow:allowAll(), notes:["n1"], fire:"30 min dry" },
      { key:"air_mp", label:"Aire media presión (MP)", allow:allowAll(), notes:["n1"], fire:"30 min dry" },
      { key:"air_lp", label:"Aire baja presión (LP)", allow:allowAll(), notes:["n1"], fire:"(no aplica)" },
      { key:"service_air", label:"Aire de servicio (no esencial)", allow:allowAll(), notes:[], fire:"(no aplica)" },
      { key:"brine", label:"Salmuera (brine)", allow:allowAll(), notes:[], fire:"(wet)" },
      { key:"co2_outside", label:"CO₂ (fuera del espacio protegido)", allow:{...allowAll(), slip_mgrooved:false, slip_grip:false, slip_type:false}, notes:["n1"], fire:"30 min dry" },
      { key:"co2_inside", label:"CO₂ (dentro del espacio protegido)", allow:{...allowAll(), slip_mgrooved:false, slip_grip:false, slip_type:false}, notes:[], fire:"(dry)" },
      { key:"steam", label:"Vapor", allow:{pipe_union_welded_brazed:true,comp_swage:true,comp_bite:true,comp_typical:true,comp_flared:true,comp_press:true,slip_mgrooved:false,slip_grip:false,slip_type:true}, notes:["n5"], fire:"(no aplica)" }
    ]}
  ];
  return {
    id: "naval",
    title: "LR Naval",
    JOINT_TYPES,
    SPACES,
    NOTES,
    GENERAL,
    CLASS_RULES,
    SYSTEM_GROUPS,
    EXTRA: {
      n2_forbiddenSpaces: ["mach_cat_a","accommodation","munitions"],
      n2_visibleOnlySpaces: ["other_mach_service"]
    }
  };
}

function buildShips(){
  const JOINT_TYPES = [
    { key: "pipe_union_welded_brazed", group: "Pipe unions", label: "Unión roscada soldada/soldadura fuerte" },
    { key: "comp_swage", group: "Compression couplings", label: "Compresión tipo swage" },
    { key: "comp_bite", group: "Compression couplings", label: "Compresión tipo bite" },
    { key: "comp_typical", group: "Compression couplings", label: "Compresión típica" },
    { key: "comp_flared", group: "Compression couplings", label: "Compresión tipo flare" },
    { key: "comp_press", group: "Compression couplings", label: "Compresión tipo press" },
    { key: "slip_mgrooved", group: "Slip-on joints", label: "Slip-on ranurado a máquina" },
    { key: "slip_grip", group: "Slip-on joints", label: "Slip-on tipo grip" },
    { key: "slip_type", group: "Slip-on joints", label: "Slip-on tipo slip" }
  ];
  const SPACES = [
    { key: "mach_cat_a", label: "Espacio de máquinas Cat. A" },
    { key: "pump_room", label: "Sala de bombas" },
    { key: "accommodation", label: "Acomodaciones" },
    { key: "other_mach_service", label: "Otros esp. de máquinas/servicio" },
    { key: "open_deck", label: "Cubierta abierta" },
    { key: "cargo_hold", label: "Bodega de carga" },
    { key: "inside_tank", label: "Dentro de tanque" }
  ];
  const NOTES = {
    n1: {
      id: "n1",
      tag: "N1",
      titleES: "Tipo resistente al fuego en Cat. A",
      es: "Las juntas mecánicas con componentes que se deterioran con el fuego deben ser de tipo resistente al fuego cuando se instalen en espacios de máquinas Cat. A. En bilge main en Cat. A: acoplamientos de acero/CuNi o equivalente.",
      en: "Mechanical joints that include components which readily deteriorate in case of fire are to be of an approved fire-resistant type when fitted in machinery spaces of Category A. Mechanical couplings on the bilge main in Category A are to be of steel, CuNi or equivalent."
    },
    n2: {
      id: "n2",
      tag: "N2",
      titleES: "Restricciones a slip-on por espacio",
      es: "Slip-on no aceptado en espacios de máquinas Cat. A ni en acomodaciones. En otros espacios de máquinas/servicio, solo si la posición es visible y accesible. No usar en bodegas o tanques no accesibles.",
      en: "Slip-on joints are not accepted inside machinery spaces of Category A nor accommodation spaces. In other machinery/service spaces they are only accepted where the position is visible and accessible. Not to be used in cargo holds or tanks that are not accessible."
    },
    n3: {
      id: "n3",
      tag: "N3",
      titleES: "Tipo resistente al fuego salvo cubierta abierta",
      es: "Requiere tipo resistente al fuego aprobado salvo cuando se instale en cubierta abierta.",
      en: "Requires an approved fire-resistant type except when fitted on open deck."
    },
    n4: {
      id: "n4",
      tag: "N4",
      titleES: "Tipo resistente al fuego en Cat. A",
      es: "En espacios de máquinas Cat. A, las juntas deben ser de tipo resistente al fuego con ensayo aprobado.",
      en: "In machinery spaces of Category A, joints are to be of an approved fire-resistant type with the prescribed fire test."
    },
    n5: {
      id: "n5",
      tag: "N5",
      titleES: "Solo sobre cubierta de referencia",
      es: "Drenajes de cubierta internos: únicamente por encima de la cubierta de mamparos / francobordo.",
      en: "Internal deck drains: only above the bulkhead deck / freeboard deck."
    },
    n6: {
      id: "n6",
      tag: "N6",
      titleES: "Slip type en cubierta hasta 10 bar",
      es: "Slip type en cubierta solo si la presión de diseño es ≤ 10 bar (según clase/medio).",
      en: "Slip type on deck only where design pressure is ≤ 10 bar (as limited by class/medium)."
    },
    n7: {
      id: "n7",
      tag: "N7",
      titleES: "Equivalencias de ensayo de fuego",
      es: "Equivalencias: 30 dry ≈ (8+22) ≈ 30 wet.",
      en: "Equivalences: 30 dry ≈ (8+22) ≈ 30 wet."
    },
    n8: {
      id: "n8",
      tag: "N8",
      titleES: "Vapor: slip-on restringida",
      es: "En vapor, la junta slip-on debe estar restringida para movimiento axial.",
      en: "For steam, the slip-on joint is to be restrained for axial movement."
    }
  };
  const GENERAL = {
    g_slip_on: {
      id: "g_slip_on",
      tag: "Regla 2.12.8",
      titleES: "Slip-on en bodegas/tanques",
      es: "Slip-on no en bodegas/tanques no accesibles; en tanques solo si el medio coincide.",
      en: "Slip-on not in cargo holds/tanks not easily accessible; inside tanks only if the medium is the same."
    },
    g_slip_type: {
      id: "g_slip_type",
      tag: "Regla 2.12.9",
      titleES: "Slip type como medio principal",
      es: "Slip type como medio principal solo si compensa dilatación axial.",
      en: "Slip type as main means only where compensating axial deformation."
    },
    g_steam: {
      id: "g_steam",
      tag: "Regla 2.12.10",
      titleES: "Vapor: restricción axial",
      es: "En vapor: slip-on restringida para movimiento axial.",
      en: "For steam systems: slip-on joints are to be restrained for axial movement."
    }
  };
  const CLASS_RULES = {
    pipe_union_welded_brazed: { I:{allowed:true, odLE:60.3}, II:{allowed:true, odLE:60.3}, III:{allowed:true} },
    comp_swage: { I:{allowed:true}, II:{allowed:true}, III:{allowed:true} },
    comp_bite:  { I:{allowed:true, odLE:60.3}, II:{allowed:true, odLE:60.3}, III:{allowed:true} },
    comp_typical:{ I:{allowed:true, odLE:60.3}, II:{allowed:true, odLE:60.3}, III:{allowed:true} },
    comp_flared: { I:{allowed:true, odLE:60.3}, II:{allowed:true, odLE:60.3}, III:{allowed:true} },
    comp_press:  { I:{allowed:false}, II:{allowed:false}, III:{allowed:true} },
    slip_mgrooved:{ I:{allowed:true}, II:{allowed:true}, III:{allowed:true} },
    slip_grip:   { I:{allowed:false}, II:{allowed:true}, III:{allowed:true} },
    slip_type:   { I:{allowed:false}, II:{allowed:true}, III:{allowed:true} }
  };
  const allowAll = () => ({
    pipe_union_welded_brazed:true,
    comp_swage:true,
    comp_bite:true,
    comp_typical:true,
    comp_flared:true,
    comp_press:true,
    slip_mgrooved:true,
    slip_grip:true,
    slip_type:true
  });
  const SYSTEM_GROUPS = [
    { key:"flamm_lt60", label:"Fluidos inflamables (fp < 60°C)", systems:[
      { key:"cargo_oil", label:"Líneas de crudo (fp <60°C)", allow:allowAll(), notes:["n1"], fire:"30 min dry" },
      { key:"cow_lines", label:"Líneas de lavado de crudo (COW)", allow:allowAll(), notes:["n1"], fire:"30 min dry" },
      { key:"vent_lt60", label:"Líneas de venteo", allow:allowAll(), notes:["n3"], fire:"30 min dry" }
    ]},
    { key:"inert_gas", label:"Gas inerte", systems:[
      { key:"water_seal_effluent", label:"Efluentes del sello hidráulico", allow:allowAll(), notes:[], fire:"30 min wet" },
      { key:"scrubber_effluent", label:"Efluentes del depurador", allow:allowAll(), notes:[], fire:"30 min wet" },
      { key:"main_lines", label:"Líneas principales", allow:allowAll(), notes:["n1","n2"], fire:"30 min dry" },
      { key:"distribution", label:"Líneas de distribución", allow:allowAll(), notes:["n1"], fire:"30 min dry" }
    ]},
    { key:"flamm_gt60", label:"Fluidos inflamables (fp > 60°C)", systems:[
      { key:"cargo_oil_gt60", label:"Líneas de crudo (fp >60°C)", allow:allowAll(), notes:["n1"], fire:"30 min dry" },
      { key:"fuel_oil", label:"Líneas de fuel oil", allow:allowAll(), notes:["n2","n3"], fire:"30 min wet" },
      { key:"lube_oil", label:"Líneas de aceite lubricante", allow:allowAll(), notes:["n2","n3"], fire:"30 min wet" },
      { key:"hydraulic_oil", label:"Aceite hidráulico", allow:allowAll(), notes:["n2","n3"], fire:"30 min wet" },
      { key:"thermal_oil", label:"Aceite térmico", allow:allowAll(), notes:["n2","n3"], fire:"30 min wet" }
    ]},
    { key:"seawater", label:"Agua de mar", systems:[
      { key:"bilge", label:"Líneas de achique (bilge)", allow:allowAll(), notes:["n4"], fire:"8 dry + 22 wet" },
      { key:"fire_perm", label:"Contra-incendios / rociadores (llenado permanente)", allow:allowAll(), notes:["n3"], fire:"30 min wet" },
      { key:"fire_nonperm", label:"Extinción (no permanente) / drencher / espuma", allow:allowAll(), notes:["n3"], fire:"8 dry + 22 wet" },
      { key:"ballast", label:"Sistema de lastre", allow:allowAll(), notes:["n4"], fire:"30 min wet" },
      { key:"cooling_sw", label:"Refrigeración – agua de mar", allow:allowAll(), notes:["n4"], fire:"30 min wet" }
    ]},
    { key:"freshwater", label:"Agua dulce", systems:[
      { key:"cooling_fw", label:"Refrigeración – agua dulce", allow:allowAll(), notes:["n4"], fire:"30 min wet" },
      { key:"cond_return", label:"Retorno de condensado", allow:allowAll(), notes:["n4"], fire:"30 min wet" },
      { key:"non_essential_fw", label:"Sistema no esencial", allow:allowAll(), notes:[], fire:"(no test)" }
    ]},
    { key:"sanitary", label:"Sanitarios / drenajes / escuppers", systems:[
      { key:"deck_drains_internal", label:"Drenajes de cubierta (internos)", allow:allowAll(), notes:["n5"], fire:"(no test)" },
      { key:"sanitary_drains", label:"Drenajes sanitarios", allow:allowAll(), notes:[], fire:"(dry)" },
      { key:"scuppers_overboard", label:"Escuppers y descarga sobre costado", allow:{...allowAll(), slip_mgrooved:false, slip_grip:false, slip_type:false}, notes:[], fire:"(dry)" }
    ]},
    { key:"sounding_vent", label:"Sondajes / venteos", systems:[
      { key:"water_tanks_dry_spaces", label:"Tanques de agua / espacios secos", allow:allowAll(), notes:[], fire:"(no test)" },
      { key:"oil_tanks_fp_gt60", label:"Tanques de aceite (fp > 60°C)", allow:allowAll(), notes:["n2","n3"], fire:"(dry)" }
    ]},
    { key:"misc", label:"Misceláneos / gases / vapor", systems:[
      { key:"start_control_air", label:"Aire de arranque / control", allow:{...allowAll(), slip_mgrooved:false, slip_grip:false, slip_type:false}, notes:["n4"], fire:"30 min dry" },
      { key:"service_air", label:"Aire de servicio (no esencial)", allow:allowAll(), notes:[], fire:"(no test)" },
      { key:"brine", label:"Salmuera", allow:allowAll(), notes:[], fire:"(wet)" },
      { key:"co2_outside", label:"CO₂ (fuera del espacio protegido)", allow:{...allowAll(), slip_mgrooved:false, slip_grip:false, slip_type:false}, notes:[], fire:"30 min dry" },
      { key:"co2_inside", label:"CO₂ (dentro del espacio protegido)", allow:{...allowAll(), slip_mgrooved:false, slip_grip:false, slip_type:false}, notes:[], fire:"(dry)" },
      { key:"steam", label:"Vapor", allow:{ pipe_union_welded_brazed:true, comp_swage:true, comp_bite:true, comp_typical:true, comp_flared:true, comp_press:true, slip_mgrooved:false, slip_grip:false, slip_type:true }, notes:["n8"], fire:"(no test)" }
    ]}
  ];
  const CLASS_PRESS_LIMITS = {
    steam: { II:16, III:7 },
    thermal: { II:16, III:7 },
    flammable: { II:16, III:7 },
    other: { II:40, III:16 }
  };
  const SYSTEM_CATEGORY = {
    cargo_oil:"flammable",
    cow_lines:"flammable",
    vent_lt60:"flammable",
    water_seal_effluent:"other",
    scrubber_effluent:"other",
    main_lines:"other",
    distribution:"other",
    cargo_oil_gt60:"flammable",
    fuel_oil:"flammable",
    lube_oil:"flammable",
    hydraulic_oil:"flammable",
    thermal_oil:"thermal",
    bilge:"other",
    fire_perm:"other",
    fire_nonperm:"other",
    ballast:"other",
    cooling_sw:"other",
    cooling_fw:"other",
    cond_return:"other",
    non_essential_fw:"other",
    deck_drains_internal:"other",
    sanitary_drains:"other",
    scuppers_overboard:"other",
    water_tanks_dry_spaces:"other",
    oil_tanks_fp_gt60:"flammable",
    start_control_air:"other",
    service_air:"other",
    brine:"other",
    co2_outside:"other",
    co2_inside:"other",
    steam:"steam"
  };
  return {
    id: "ships",
    title: "LR Ships",
    JOINT_TYPES,
    SPACES,
    NOTES,
    GENERAL,
    CLASS_RULES,
    SYSTEM_GROUPS,
    EXTRA: {
      n2_forbiddenSpaces: ["mach_cat_a","accommodation"],
      n2_visibleOnlySpaces: ["other_mach_service"],
      CLASS_PRESS_LIMITS,
      SYSTEM_CATEGORY
    }
  };
}

// === Registro global
const DATASETS = {
  naval: buildNaval(),
  ships: buildShips()
};

// === Mapeo imagen por tipo de junta (usa tus archivos en assets/joints) ===
const JOINT_IMAGES = {
  pipe_union_welded_brazed: 'pipe_welded_brazed.jpg',
  comp_swage: 'compression_swage.jpg',
  comp_bite: 'compression_bite.jpg',
  comp_typical: 'compression_typical.jpg',
  comp_flared: 'compression_flared.jpg',
  comp_press: 'compression_press.jpg',
  slip_mgrooved: 'slip_machine_grooved.jpg',
  slip_grip: 'slip_grip.jpg',
  slip_type: 'slip_slip.jpg'
};
function jointImgPath(key){
  return 'assets/joints/' + (JOINT_IMAGES[key] || 'not-found.jpg');
}

const CLASS_CARD_LIMITS = {
  Steam:             { P2_bar:16, T2_C:300, P1_bar:7,  T1_C:170 },
  'Thermal oil':     { P2_bar:16, T2_C:300, P1_bar:7,  T1_C:150 },
  'Flammable liquids': { P2_bar:16, T2_C:150, P1_bar:7,  T1_C:60  },
  'Other media':     { P2_bar:40, T2_C:300, P1_bar:16, T1_C:200 },
  'Cargo oil':       { P2_bar:40, T2_C:300, P1_bar:16, T1_C:200, shipsOnly:true },
};

const toMPa = (bar)=>+(bar/10).toFixed(2);
const escapeHtml = (s)=>(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function detectMediumLabel(groupLabel, systemLabel){
  const raw = `${groupLabel || ''} ${systemLabel || ''}`.trim();
  if(!raw) return null;
  const normalized = raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
  if(normalized.includes('vapor') || normalized.includes('steam')) return 'Steam';
  if(normalized.includes('termico') || normalized.includes('thermal')) return 'Thermal oil';
  if(
    normalized.includes('cargo') ||
    normalized.includes('crudo') ||
    normalized.includes('derivado') ||
    normalized.includes('lavado') ||
    normalized.includes('washing')
  ){
    return 'Cargo oil';
  }
  if(
    normalized.includes('inflamable') ||
    normalized.includes('combustible') ||
    normalized.includes('fuel') ||
    normalized.includes('aceite') ||
    normalized.includes('oil')
  ){
    return 'Flammable liquids';
  }
  return 'Other media';
}

function infoCardHtml({ title, body, hint }){
  return `<div class="info-card">
    <div class="info-card-title">${escapeHtml(title)}</div>
    <pre class="info-card-body">${escapeHtml(body)}</pre>
    ${hint ? `<div class="info-card-hint">${escapeHtml(hint)}</div>` : ''}
  </div>`;
}

function renderClassInfoCard(dataset){
  const card = classInfoCard;
  if(!card) return;

  const groupIdx = Number(groupSel?.value ?? 0) || 0;
  const fallbackGroup = dataset.SYSTEM_GROUPS[groupIdx];
  const sysKey = systemSel?.value;
  const group = dataset.SYSTEM_GROUPS.find(g=>g.systems.some(s=>s.key===sysKey)) || fallbackGroup;
  const system = group?.systems.find(s=>s.key===sysKey) || group?.systems[0];
  const pipeClass = classSel?.value;

  if(!group || !system || !pipeClass){
    card.innerHTML='';
    card.style.display='none';
    return;
  }

  const medio = detectMediumLabel(group.label, system.label);
  if(!medio){
    card.innerHTML='';
    card.style.display='none';
    return;
  }

  const lim = CLASS_CARD_LIMITS[medio];
  if(!lim){
    card.innerHTML='';
    card.style.display='none';
    return;
  }

  const norma = dataset.title || (dataset.id === 'ships' ? 'LR Ships' : 'LR Naval');
  if(norma === 'LR Naval' && lim.shipsOnly){
    card.innerHTML = infoCardHtml({
      title:'Límites por clase',
      body:'El servicio seleccionado no aplica en LR Naval (no hay límites tabulados para este medio).\n\nSelecciona otro grupo de sistema.',
    });
    card.style.display='';
    return;
  }

  const p2 = toMPa(lim.P2_bar);
  const p1 = toMPa(lim.P1_bar);
  let html = '';
  if(pipeClass === 'I'){
    html = infoCardHtml({
      title:'Límites por clase – Clase I',
      body:
        'Clase I no tiene límite tabulado de P/T. Se selecciona cuando P > P₂ o T > T₂ del medio seleccionado.\n\n' +
        'Umbrales (Clase II) para este medio:\n' +
        `• P₂ = ${lim.P2_bar} bar (${p2} MPa)\n` +
        `• T₂ = ${lim.T2_C} °C`,
      hint:`Norma: ${norma}`,
    });
  } else if(pipeClass === 'II'){
    html = infoCardHtml({
      title:'Límites por clase – Clase II',
      body:
        'Máximos permitidos para el medio seleccionado:\n' +
        `• P₂ = ${lim.P2_bar} bar (${p2} MPa)\n` +
        `• T₂ = ${lim.T2_C} °C`,
      hint:`Norma: ${norma}`,
    });
  } else {
    html = infoCardHtml({
      title:'Límites por clase – Clase III',
      body:
        'Máximos permitidos para el medio seleccionado:\n' +
        `• P₁ = ${lim.P1_bar} bar (${p1} MPa)\n` +
        `• T₁ = ${lim.T1_C} °C`,
      hint:`Norma: ${norma}`,
    });
  }

  card.innerHTML = html;
  card.style.display = html ? '' : 'none';
}

/* =========================
   MOTOR DE EVALUACIÓN (JS puro)
   ========================= */
function evaluate(dataset, input, systemKey){
  const group = dataset.SYSTEM_GROUPS.find(g => g.systems.some(s => s.key === systemKey));
  const sys = group?.systems.find(s => s.key === systemKey);
  if(!sys) return [];

  const results = [];
  for(const jt of dataset.JOINT_TYPES){
    const allowedBySystem = Boolean(sys.allow && sys.allow[jt.key]);
    let status = allowedBySystem ? 'ok' : 'no';
    const reasons = [];

    if(!allowedBySystem){
      reasons.push(dataset.id === 'ships'
        ? 'No permitido para este sistema (Tabla 12.2.3).'
        : 'No permitido para este sistema (Tabla 1.5.3).');
      results.push({ jt: jt.key, status, reasons });
      continue;
    }

    const classRule = dataset.CLASS_RULES[jt.key]?.[input.pipeClass];
    if(classRule){
      if(!classRule.allowed){
        status = 'no';
        reasons.push(dataset.id === 'ships'
          ? `No permitido para Clase ${input.pipeClass} (Tabla 12.2.4).`
          : `No permitido para Clase ${input.pipeClass} (Tabla 1.5.4).`);
      } else if(classRule.odLE && Number(input.od || 0) > classRule.odLE){
        status = 'no';
        reasons.push(dataset.id === 'ships'
          ? `OD > ${classRule.odLE} mm excede el límite para Clase ${input.pipeClass} (Tabla 12.2.4).`
          : `OD > ${classRule.odLE} mm no permitido para Clase ${input.pipeClass} (Tabla 1.5.4).`);
      }
    }

    let ctx = { dataset, joint: jt, input, sys, reasons, status };
    if(ctx.status !== 'no' && sys.notes?.length){
      for(const code of sys.notes){
        ctx = applyNote(dataset, code, ctx);
        if(ctx.status === 'no') break;
      }
    }

    if(ctx.status !== 'no'){
      ctx = applyGeneralRules(ctx);
    }

    results.push({ jt: jt.key, status: ctx.status, reasons });
  }
  return results;
}

function applyNote(dataset, code, ctx){
  if(dataset.id === 'naval') return applyNavalNote(code, ctx);
  if(dataset.id === 'ships') return applyShipsNote(code, ctx);
  return ctx;
}

function applyNavalNote(code, ctx){
  const { dataset, joint, input, sys, reasons } = ctx;
  let { status } = ctx;
  switch(code){
    case 'n1':
      if(input.space === 'mach_cat_a'){
        status = escalateWarn(status);
        reasons.push('Requiere tipo resistente al fuego aprobado (Nota 1).');
        if(sys.key === 'bilge'){
          reasons.push('En bilge main (Cat. A): acoplamientos de acero/CuNi o equivalente (Nota 1).');
        }
      }
      break;
    case 'n2':
      if(joint.key.startsWith('slip_')){
        const forbidden = dataset.EXTRA?.n2_forbiddenSpaces || [];
        const visibleOnly = dataset.EXTRA?.n2_visibleOnlySpaces || [];
        if(forbidden.includes(input.space)){
          status = 'no';
          reasons.push('Slip-on prohibido en este espacio (Nota 2).');
        } else if(visibleOnly.includes(input.space)){
          status = escalateWarn(status);
          if(!input.visible){
            status = 'no';
            reasons.push('Debe estar visible y accesible (Nota 2).');
          } else {
            reasons.push('Permitido solo si la posición es visible y accesible (Nota 2).');
          }
        }
      }
      break;
    case 'n3':
      if(input.space !== 'open_deck'){
        status = escalateWarn(status);
        reasons.push('Requiere tipo resistente al fuego aprobado (Nota 3).');
      }
      break;
    case 'n6':
      if(!input.aboveWLI){
        status = escalateWarn(status);
        reasons.push('Solo por encima del límite de estanqueidad (Nota 6).');
      }
      break;
    default:
      break;
  }
  ctx.status = status;
  return ctx;
}

function applyShipsNote(code, ctx){
  const { dataset, joint, input, sys, reasons } = ctx;
  let { status } = ctx;
  switch(code){
    case 'n1':
      if(input.space === 'pump_room' || input.space === 'open_deck'){
        status = escalateWarn(status);
        reasons.push('Requiere tipo resistente al fuego aprobado (Nota 1).');
      }
      break;
    case 'n2':
      if(joint.key.startsWith('slip_')){
        const forbidden = dataset.EXTRA?.n2_forbiddenSpaces || [];
        const visibleOnly = dataset.EXTRA?.n2_visibleOnlySpaces || [];
        if(forbidden.includes(input.space)){
          status = 'no';
          reasons.push('Slip-on prohibido en este espacio (Nota 2).');
        } else if(visibleOnly.includes(input.space)){
          status = escalateWarn(status);
          if(!input.visible){
            status = 'no';
            reasons.push('Debe estar visible y accesible (Nota 2).');
          } else {
            reasons.push('Permitido solo si la posición es visible y accesible (Nota 2).');
          }
        }
      }
      break;
    case 'n3':
      if(input.space !== 'open_deck' || sys.key === 'fuel_oil'){
        status = escalateWarn(status);
        reasons.push('Requiere tipo resistente al fuego aprobado (Nota 3).');
      }
      break;
    case 'n4':
      if(input.space === 'mach_cat_a'){
        status = escalateWarn(status);
        reasons.push('Requiere tipo resistente al fuego aprobado en Cat. A (Nota 4).');
      }
      break;
    case 'n5':
      if(!input.aboveWLI){
        status = escalateWarn(status);
        reasons.push('Solo por encima de la cubierta de mamparos / francobordo (Nota 5).');
      }
      break;
    case 'n6':
      if(joint.key === 'slip_type' && input.space === 'open_deck'){
        const category = dataset.EXTRA?.SYSTEM_CATEGORY?.[sys.key] || 'other';
        const limit = dataset.EXTRA?.CLASS_PRESS_LIMITS?.[category]?.[input.pipeClass];
        if(limit != null){
          if(limit <= 10){
            status = escalateWarn(status);
            reasons.push(`Slip type en cubierta solo si la presión de diseño es ≤ ${limit} bar (Nota 6).`);
          } else {
            status = 'no';
            reasons.push(`Slip type en cubierta no permitido; límite aplicable ${limit} bar > 10 bar (Nota 6).`);
          }
        }
      }
      break;
    default:
      break;
  }
  ctx.status = status;
  return ctx;
}

function applyGeneralRules(ctx){
  const { dataset, joint, input, sys, reasons } = ctx;
  let { status } = ctx;
  const slipRule = dataset.id === 'ships' ? 'Regla 2.12.8' : 'Regla 5.10.9';
  if(joint.key.startsWith('slip_')){
    if(input.space === 'cargo_hold'){
      status = 'no';
      reasons.push(`Slip-on prohibido en bodegas de carga (${slipRule}).`);
    } else if(input.space === 'inside_tank'){
      status = escalateWarn(status);
      if(input.sameMedium){
        reasons.push(`Condición: el medio del tubo debe coincidir con el del tanque (${slipRule}).`);
      } else {
        reasons.push(`En tanques: solo si el medio coincide con el del tanque (${slipRule}).`);
      }
    }
  }

  if(joint.key === 'slip_type'){
    status = escalateWarn(status);
    const slipTypeRule = dataset.id === 'ships' ? 'Regla 2.12.9' : 'Regla 5.10.10';
    if(input.axial){
      reasons.push(`Condición: slip type solo como medio principal si compensa deformación axial (${slipTypeRule}).`);
    } else {
      reasons.push(`Slip type como medio principal: solo si compensa deformación axial (${slipTypeRule}).`);
    }
    if(dataset.id === 'ships' && sys.notes?.includes('n8') && input.axial){
      reasons.push('Vapor: slip-on restringida para movimiento axial (Nota 8 / Regla 2.12.10).');
    }
  }

  ctx.status = status;
  return ctx;
}

function escalateWarn(status){
  return status === 'ok' ? 'warn' : status;
}
/* =========================
   UI – render
   ========================= */
const $ = (s)=>document.querySelector(s);
const $$= (s)=>Array.from(document.querySelectorAll(s));

const stdSel = $('#stdSel');
const groupSel = $('#groupSel');
const systemSel = $('#systemSel');
const classSel = $('#classSel');
const odInp = $('#odInp');
const spaceSel = $('#spaceSel');
const visibleSel = $('#visibleSelect');
const sameSel = $('#sameMediumSelect');
const axialSel = $('#axialSelect');
const chkWLI = $('#chkAboveWLI');
const notesBox = $('#notesChips');
const generalBox = $('#generalChips');
const fireRow = $('#fireRow');
const results = $('#results');
const imgModal = $('#imgModal');
const imgModalSrc = $('#imgModalSrc');
const imgModalCaption = $('#imgModalCaption');
const classInfoCard = document.getElementById('classInfoCard');

let applied = null; // estado congelado

function loadDataset(){
  const ds = DATASETS[stdSel.value || 'naval'];
  groupSel.innerHTML = ds.SYSTEM_GROUPS.map((g,i)=>`<option value="${i}">${g.label}</option>`).join('');
  groupSel.value = groupSel.options.length ? '0' : '';
  fillSystemsFromGroup(ds);
  spaceSel.innerHTML = ds.SPACES.map(s=>`<option value="${s.key}">${s.label}</option>`).join('');
  renderNotesLegend(ds);
  showContextualChecks(ds);
  clearResultsAndHints();
}

function fillSystemsFromGroup(ds){
  const idx = Number(groupSel.value) || 0;
  const group = ds.SYSTEM_GROUPS[idx] || ds.SYSTEM_GROUPS[0];
  const effectiveIdx = ds.SYSTEM_GROUPS.indexOf(group);
  if(effectiveIdx>=0) groupSel.value = String(effectiveIdx);
  systemSel.innerHTML = group ? group.systems.map(s=>`<option value="${s.key}">${s.label}</option>`).join('') : '';
  if(group && group.systems.length){
    systemSel.value = group.systems[0].key;
  }
}

function renderNotesLegend(ds){
  const sysKey = systemSel.value;
  const group = ds.SYSTEM_GROUPS.find(g => g.systems.some(s=>s.key===sysKey));
  const sys = group?.systems.find(s=>s.key===sysKey);
  notesBox.innerHTML = '';
  if(generalBox) generalBox.innerHTML = '';
  if(!sys){
    fireRow.textContent = '—';
    renderGeneralLegend(ds);
    return;
  }
  fireRow.textContent = sys.fire || '—';

  if(sys.notes?.length){
    for(const code of sys.notes){
      const note = ds.NOTES?.[code];
      if(!note) continue;
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'chip';
      chip.textContent = note.tag || code.toUpperCase();
      chip.addEventListener('click', ()=>{
        showNoteModal({
          title: `${note.tag || code.toUpperCase()} · ${note.titleES || ''}`.trim(),
          es: note.es || '',
          en: note.en || ''
        });
      });
      notesBox.appendChild(chip);
    }
  }

  renderGeneralLegend(ds);
}

function renderGeneralLegend(ds){
  if(!generalBox) return;
  generalBox.innerHTML = '';
  const items = ds.GENERAL ? Object.values(ds.GENERAL) : [];
  if(!items.length) return;
  for(const rule of items){
    const chip = document.createElement('button');
    chip.type = 'button';
    chip.className = 'rule-chip';
    chip.textContent = rule.tag || (rule.id || '').toUpperCase();
    chip.addEventListener('click', ()=>{
      showNoteModal({
        title: `${rule.tag || rule.id || ''} · ${rule.titleES || ''}`.trim(),
        es: rule.es || '',
        en: rule.en || ''
      });
    });
    generalBox.appendChild(chip);
  }
}

function showContextualChecks(dataset){
  const lblAbove = document.querySelector('label[for="chkAboveWLI"]');
  const helpAbove = document.getElementById('helpWLI');
  const sysKey = systemSel.value;
  const group = dataset.SYSTEM_GROUPS.find(g => g.systems.some(s=>s.key===sysKey));
  const sys = group?.systems.find(s=>s.key===sysKey);
  const space = spaceSel.value;
  const pipeClass = classSel.value;

  const visibleWrap = visibleSel?.closest('.check-item');
  const sameWrap = sameSel?.closest('.check-item');
  const axialWrap = axialSel?.closest('.check-item');
  const aboveWrap = chkWLI?.closest('.check-item');

  const needsVisible = Boolean(sys?.notes?.includes('n2') && dataset.EXTRA?.n2_visibleOnlySpaces?.includes(space));
  if(visibleWrap){
    visibleWrap.style.display = needsVisible ? '' : 'none';
    if(visibleSel){
      visibleSel.disabled = !needsVisible;
      if(!needsVisible) visibleSel.value = 'yes';
    }
  }

  const needsSameMedium = space === 'inside_tank';
  if(sameWrap){
    sameWrap.style.display = needsSameMedium ? '' : 'none';
    if(sameSel){
      sameSel.disabled = !needsSameMedium;
      if(!needsSameMedium) sameSel.value = 'no';
    }
  }

  const showAbove = sys?.key === 'deck_drains_internal';
  if(aboveWrap){
    aboveWrap.style.display = showAbove ? '' : 'none';
    if(!showAbove) chkWLI.checked = true;
  }

  if(lblAbove && helpAbove){
    if(dataset.id==='ships'){
      lblAbove.textContent = '(Drenajes) Ubicado sobre cubierta de mamparos / francobordo';
      helpAbove.textContent = 'Requisito de la Nota 5 en LR Ships para drenes de cubierta internos.';
    } else {
      lblAbove.textContent = '(Drenajes) Ubicado por encima del límite de estanqueidad';
      helpAbove.textContent = 'Requisito de la Nota 6 en LR Naval para drenes de cubierta internos.';
    }
  }

  const systemAllowsSlipType = Boolean(sys?.allow?.slip_type);
  const classAllowsSlipType = dataset.CLASS_RULES?.slip_type?.[pipeClass]?.allowed !== false;
  const needsAxial = (systemAllowsSlipType && classAllowsSlipType) || sys?.key === 'steam';
  if(axialWrap){
    axialWrap.style.display = needsAxial ? '' : 'none';
    if(axialSel){
      axialSel.disabled = !needsAxial;
      if(!needsAxial) axialSel.value = 'no';
    }
  }

  renderClassInfoCard(dataset);
}

function clearResultsAndHints(){
  applied = null;
  if(results){
    results.innerHTML = '<div class="empty-state">Haz clic en <strong>Evaluar</strong> para ver las juntas permitidas.</div>';
  }
  hideImageModal();
}

function onEvaluate(){
  const ds = DATASETS[stdSel.value || 'naval'];
  const group = ds.SYSTEM_GROUPS[Number(groupSel.value)||0];
  const sys = group?.systems.find(s=>s.key===systemSel.value);
  if(!sys) return;

  applied = {
    systemKey: sys.key,
    pipeClass: classSel.value,
    space: spaceSel.value,
    od: Number(odInp.value||0),
    visible: visibleSel?.value === 'yes',
    sameMedium: sameSel?.value === 'yes',
    axial: axialSel?.value === 'yes',
    aboveWLI: chkWLI.checked
  };

  const items = evaluate(ds, applied, sys.key);
  renderResults(ds, items);
}

function renderResults(ds, items){
  const order = Array.from(new Set(ds.JOINT_TYPES.map(j=>j.group)));
  const byGroup = {};
  for(const it of items){
    const joint = ds.JOINT_TYPES.find(x=>x.key===it.jt);
    if(!joint) continue;
    const g = joint.group;
    (byGroup[g] ||= []).push({joint, ...it});
  }
  const jointMap = new Map(ds.JOINT_TYPES.map(j=>[j.key, j]));
  const sections = order.map(gr=>{
    const arr = byGroup[gr]||[];
    if(!arr.length) return '';
    return `
      <section class="group mb-3">
        <div class="g-title">${groupES(gr)}</div>
        <div class="g-sub">${gr}</div>
        <div class="grid mt-2">
          ${arr.map(item=>cardHTML(ds, item)).join('')}
        </div>
      </section>`;
  }).join('');

  if(!sections.trim()){
    results.innerHTML = '<div class="empty-state">No hay resultados disponibles para la selección actual.</div>';
    return;
  }

  results.innerHTML = sections;
  const fallbackFigure = ds.id === 'ships' ? '12.2.4/12.2.5' : '1.5.4/1.5.5';
  $$('.js-view').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.getAttribute('data-key') || '';
      if(!key) return;
      const joint = jointMap.get(key);
      const label = joint?.label || 'Figura de junta';
      const figure = btn.getAttribute('data-figure') || fallbackFigure;
      showImageModal({
        src: jointImgPath(key),
        label,
        figure
      });
    });
  });
}

function groupES(gr){
  if(gr==='Pipe unions') return 'Uniones de tubería';
  if(gr==='Compression couplings') return 'Acoplamientos de compresión';
  if(gr==='Slip-on joints') return 'Juntas slip-on';
  return gr;
}

function cardHTML(ds, {joint,jt,status,reasons}){
  const jtObj = joint || ds.JOINT_TYPES.find(x=>x.key===jt);
  if(!jtObj) return '';
  const badge = status==='ok' ? '<span class="badge b-ok">Permitido</span>'
              : status==='warn' ? '<span class="badge b-warn">Permitido con condiciones</span>'
              : '<span class="badge b-bad">Prohibido</span>';
  const rs = reasons?.length ? `<ul class="reasons">${reasons.map(r=>`<li>${r}</li>`).join('')}</ul>` : `<div class="small mut">Sin observaciones.</div>`;
  const figureCode = ds.id==='ships' ? '12.2.4/12.2.5' : '1.5.4/1.5.5';
  return `
    <div class="card result-card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <div style="font-weight:600">${jtObj.label}</div>
        ${badge}
      </div>
      ${rs}
      <div class="view-action"><button type="button" class="view-btn js-view" data-key="${jtObj.key}" data-figure="${figureCode}">VER</button></div>
    </div>`;
}

function showImageModal({src, label, figure}){
  if(!imgModal || !imgModalSrc) return;
  if(src){
    imgModalSrc.src = src;
  }
  imgModalSrc.alt = label || 'Figura de junta';
  if(imgModalCaption){
    const parts = [];
    if(figure) parts.push(`Figura ${figure}`);
    if(label) parts.push(label);
    imgModalCaption.textContent = parts.join(' · ');
    imgModalCaption.style.display = parts.length ? '' : 'none';
  }
  imgModal.classList.add('open');
  document.body.classList.add('modal-open');
}

function hideImageModal(){
  if(imgModal){
    imgModal.classList.remove('open');
  }
  if(imgModalSrc){
    imgModalSrc.removeAttribute('src');
    imgModalSrc.alt = 'Figura de junta';
  }
  if(imgModalCaption){
    imgModalCaption.textContent = '';
    imgModalCaption.style.display = 'none';
  }
  document.body.classList.remove('modal-open');
}

function showNoteModal({title, es, en}){
  const modal = $('#noteModal');
  if(!modal) return;
  $('#noteTitle').textContent = title || 'Nota';
  $('#noteES').textContent = es || '—';
  $('#noteEN').textContent = en || '—';
  modal.classList.add('open');
}

function hideNoteModal(){
  $('#noteModal')?.classList.remove('open');
}

/* =========================
   Eventos y arranque
   ========================= */
stdSel.addEventListener('change', ()=>{
  loadDataset();
});

groupSel.addEventListener('change', ()=>{
  const ds = DATASETS[stdSel.value || 'naval'];
  fillSystemsFromGroup(ds);
  renderNotesLegend(ds);
  showContextualChecks(ds);
  clearResultsAndHints();
});

systemSel.addEventListener('change', ()=>{
  const ds = DATASETS[stdSel.value || 'naval'];
  renderNotesLegend(ds);
  showContextualChecks(ds);
  clearResultsAndHints();
});

[spaceSel, classSel].forEach(el=>{
  el.addEventListener('change', ()=>{
    const ds = DATASETS[stdSel.value || 'naval'];
    showContextualChecks(ds);
    clearResultsAndHints();
  });
});
odInp.addEventListener('input', clearResultsAndHints);

document.querySelectorAll('.check-item input').forEach(inp=>{
  inp.addEventListener('change', clearResultsAndHints);
});

$('#btnEval').addEventListener('click', onEvaluate);

document.addEventListener('keydown', event => {
  if(event.key === 'Escape'){
    if(imgModal?.classList.contains('open')){
      hideImageModal();
    }
    const noteModalEl = $('#noteModal');
    if(noteModalEl?.classList.contains('open')){
      hideNoteModal();
    }
  }
});

const urlStd = new URLSearchParams(location.search).get('std');
if (urlStd && DATASETS[urlStd]) {
  stdSel.value = urlStd;
}

loadDataset();
const initialDataset = DATASETS[stdSel.value || 'naval'];
renderNotesLegend(initialDataset);
showContextualChecks(initialDataset);
clearResultsAndHints();
</script>
  <footer class="site-footer">
    <div class="footer-wrap">
      <div>Por <strong>Jhon Eric Gomez</strong> – DVMPR-GEDIN</div>
      <div>Para consultas contactar a: <a href="mailto:jegomez@cotecmar.com">jegomez@cotecmar.com</a></div>
    </div>
  </footer>
</body>
</html>
