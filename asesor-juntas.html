<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Asesor de Juntas · LR Ships / LR Naval</title>
<link rel="stylesheet" href="assets/css/app.css">
<style>
  :root { --ink:#e2e8f0; --mut:rgba(148,163,184,.76); --border:rgba(148,163,184,.18);
          --ok:#22c55e; --warn:#f59e0b; --bad:#f43f5e; --bg-card:rgba(15,23,42,.82); }
  body{margin:0;background:radial-gradient(circle at top,#1e293b 0%,#0f172a 55%,#020617 100%);
       color:var(--ink);font-family:Inter,system-ui,-apple-system,"Segoe UI","Helvetica Neue",sans-serif;}
  .wrap{max-width:1240px;margin:0 auto;padding:36px 20px 64px;}
  nav a{color:#38bdf8;text-decoration:none;font-weight:700}
  .grid{display:grid;grid-template-columns:minmax(0,420px) minmax(0,1fr);gap:22px;align-items:start}
  .card{background:var(--bg-card);border:1px solid var(--border);border-radius:22px;padding:22px;box-shadow:0 20px 45px rgba(2,6,23,.55)}
  label{display:block;font-size:12px;font-weight:800;letter-spacing:.05em;text-transform:uppercase;margin:0 0 6px}
  select,input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.35);background:rgba(15,23,42,.6);color:var(--ink)}
  .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .btn{display:inline-flex;gap:10px;align-items:center;background:#0ea5e9;border:0;border-radius:12px;color:#041628;font-weight:700;padding:10px 16px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:800;letter-spacing:.04em;text-transform:uppercase;border-radius:999px;padding:6px 12px;border:1px solid currentColor}
  .pill.ok{color:#4ade80;background:rgba(34,197,94,.12)}
  .pill.cond{color:#fcd34d;background:rgba(245,158,11,.12)}
  .pill.bad{color:#fb7185;background:rgba(244,63,94,.12)}
  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
  .joint-card header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .joint-card h4{margin:0;font-size:15px}
  .notes{font-size:12px;color:var(--mut);margin-top:10px}
  .lr-modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:99}
  .lr-modal.open{display:flex}
  .lr-modal .box{background:#0b1220;border-radius:14px;max-width:min(95vw,1024px);max-height:90vh;padding:10px;border:1px solid rgba(148,163,184,.25)}
  .lr-modal img{max-width:100%;height:auto;display:block}
  .lr-modal .close{position:absolute;top:12px;right:14px;background:#111;color:#fff;border:0;border-radius:8px;font-size:20px;padding:6px 10px;cursor:pointer}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <nav><a href="./index.html">← Volver al inicio</a></nav>
  <h1 style="margin:10px 0 16px">Asesor de juntas (LR)</h1>
  <div class="grid">
    <section class="card">
      <div class="row">
        <div>
          <label>Norma</label>
          <select id="norm"></select>
        </div>
        <div>
          <label>Sistema / Línea</label>
          <select id="system"></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label>Espacio / Compartimento</label>
          <select id="space"></select>
        </div>
        <div>
          <label>Clase de tubería</label>
          <select id="pclass">
            <option value="I">Clase I</option>
            <option value="II">Clase II</option>
            <option value="III">Clase III</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label>Diámetro exterior (mm)</label>
          <input id="od" type="number" step="0.1" min="1" placeholder="ej. 75">
        </div>
      </div>
      <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
        <button id="btnEval" class="btn">Evaluar</button>
        <small id="help" style="color:var(--mut)"></small>
      </div>
      <div class="notes" id="notesBox"></div>
    </section>

    <section class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <h2 style="margin:0">Resultado</h2>
        <div class="legend">
          <span class="pill ok">Permitido</span>
          <span class="pill cond">Condicional</span>
          <span class="pill bad">No permitido</span>
        </div>
      </div>
      <div id="results" class="cards" style="margin-top:10px"></div>
    </section>
  </div>
</div>

<!-- Modal de imagen -->
<div class="lr-modal" id="imgModal" aria-hidden="true">
  <button class="close" id="imgClose" aria-label="Cerrar">✕</button>
  <div class="box"><img id="imgView" alt=""></div>
</div>

<script type="module">
/* =======================
   CONFIG (GitHub Pages)
   ======================= */
const REGISTRY_URL = "./norms.registry.json";
const I18N_URL     = "./i18n.es.json";

/* =======================
   DATA CONSTANTS (UI)
   ======================= */
const SPACES = [
  "machinery_category_A","machinery_other","accommodation","open_deck_low_fire_risk","pump_room",
  "cargo_hold","tank","weather_deck","protected_space","dry_space","water_tank","munition_store"
];

const JOINT_IMAGE = {
  "pipe_unions.welded_brazed": "assets/joints/welded_brazed.png",
  "compression.swage": "assets/joints/compression_swage.png",
  "compression.bite": "assets/joints/compression_bite.png",
  "compression.typical_compression": "assets/joints/compression_typical.png",
  "compression.flared": "assets/joints/compression_flared.png",
  "compression.press": "assets/joints/compression_press.png",
  "slip_on.machine_grooved": "assets/joints/slip_machine_grooved.png",
  "slip_on.grip": "assets/joints/slip_grip.png",
  "slip_on.slip": "assets/joints/slip_slip.png"
};

const JOINT_FIRE_SUSCEPTIBLE = new Set([
  "compression.swage", "compression.bite", "compression.typical_compression",
  "compression.flared", "compression.press",
  "slip_on.machine_grooved", "slip_on.grip", "slip_on.slip"
]);

const NORM_LABEL = { "LR_SHIPS":"LR Buques (Ships)", "LR_NAVAL":"LR Naval" };

/* Títulos ES para “grupos” tal como vienen en tus JSON (incluye sinónimos) */
const GROUP_LABELS_ES = {
  "Flammable fluids (<60°C)": "Fluidos inflamables (f.p. ≤ 60°C)",
  "Flammable fluids (>60°C)": "Fluidos inflamables (f.p. > 60°C)",
  "Flammable fluids (flash point < 60oC)": "Fluidos inflamables (f.p. ≤ 60°C)",
  "Flammable fluids (flash point > 60oC)": "Fluidos inflamables (f.p. > 60°C)",
  "Inert gas": "Gas inerte",
  "Sea water": "Agua de mar",
  "Fresh water": "Agua dulce",
  "Sanitary/drains/scuppers": "Sanitarios / drenajes / imbornales",
  "Sounding/vent": "Aforos / venteos",
  "Miscellaneous": "Varios"
};
const GROUP_ORDER = [
  "Flammable fluids (flash point < 60°C)",
  "Flammable fluids (<60°C)",
  "Flammable fluids (flash point > 60°C)",
  "Flammable fluids (>60°C)",
  "Sea water",
  "Fresh water",
  "Sanitary/drains/scuppers",
  "Sounding/vent",
  "Miscellaneous"
];

/* Formateo legible de ensayos de fuego */
const FIRE_TEST_PRETTY = {
  "30min_dry": "30 min seco",
  "30min_wet": "30 min húmedo",
  "8dry_22wet": "8 min seco + 22 min húmedo",
  "not_required": "No requerido"
};
const fmtFireTest = (code)=> FIRE_TEST_PRETTY[code||"not_required"] || code;

/* Resumen breve de notas (tooltip) */
const NOTE_SNIPPETS = {
  LR_SHIPS: {
    1: "Ensayo de fuego en salas de bombas/cubierta abierta.",
    2: "Slip-on no en Cat. A/acomodación (MSC/Circ.734).",
    3: "Tipo resistente al fuego; excepción cubierta abierta de bajo riesgo.",
    4: "Ensayo de fuego en Cat. A.",
    5: "Drenajes internos: sobre cubierta de francobordo/límite estanco.",
    6: "Slip type en cubierta si P≤10 bar.",
    7: "Equivalencias de ensayo.",
    8: "Steam: restrained slip-on ≤1 MPa en weather deck."
  },
  LR_NAVAL: {
    1: "Cat. A: tipo resistente al fuego; bilge main acero/CuNi.",
    2: "Slip-on no en Cat. A/munitions/accommodation.",
    3: "Excepción cubierta abierta (bajo riesgo).",
    4: "Tipo resistente al fuego.",
    5: "Steam: restrained slip-on ≤10 bar en weather deck.",
    6: "Drenajes internos: por encima del límite de integridad estanca.",
    7: "HVAC/Intakes-Uptakes: ver secciones específicas."
  }
};

/* =======================
   DOM HELPERS
   ======================= */
const $ = (q)=>document.querySelector(q);
const normSel = $("#norm"), sysSel = $("#system"), spSel = $("#space"), clSel = $("#pclass"), odInp = $("#od");
const results = $("#results"), help = $("#help"), notesBox = $("#notesBox");

let I18N = {}; // almacena i18n para uso global (optgroups, labels)

async function j(url){ const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error(url); return r.json(); }
function text(i18n, key, fallback){ return i18n[key] ?? fallback ?? key; }
const chip = (label)=> `<span class="pill" style="color:#cbd5e1;border-color:#475569;background:rgba(71,85,105,.2)">${label}</span>`;

/* =======================
   CARGA DE DATOS
   ======================= */
async function loadAll() {
  I18N = await j(I18N_URL);
  const reg  = await j(REGISTRY_URL);

  const loadNorm = async (id) => {
    const meta = reg[id];
    const [service, classes, notes] = await Promise.all([j(meta.serviceUrl), j(meta.classUrl), j(meta.notesUrl)]);
    return { id, service, classes, notes };
  };
  const norms = {};
  for (const id of Object.keys(reg)) norms[id] = await loadNorm(id);
  return { i18n: I18N, norms };
}

/* =======================
   EVALUACIÓN (LR SHIPS / NAVAL)
   ======================= */
function unifyFireTest(base, required, eq){
  if (!required) return base || "not_required";
  if (!base || base==="not_required") return required;
  if (base===required) return base;
  const supersets = (eq && eq[base]) || [];
  return supersets.includes(required) ? base : required;
}

/**
 * input: { normId, system, space, od_mm, piping_class }
 * normData: { service:Array, classes:Object, notes:{space_rules:[],global_rules:[],test_equivalence:{}} }
 * Devuelve lista de joints con: status, razones, chips (ensayo/tipo fuego), notas y refs aplicadas.
 */
function evaluate(input, normData){
  const out = [];
  const { system, space, od_mm, piping_class } = input;

  const row = normData.service.find(r => (r.system || "").toLowerCase() === system.toLowerCase());
  if (!row) return out;

  const typeFireTest = row.type_fire_test || row.fire_test || "not_required";
  const baseAllowed = new Set(row.allowed_joints || []);

  const classOk = (joint) => {
    const c = normData.classes[joint]?.[piping_class];
    if (!c || !c.allowed) return { ok: false, reason: `Class table: not allowed in Class ${piping_class}` };
    if (typeof c.od_mm_max === "number" && od_mm > c.od_mm_max) {
      return { ok: false, reason: `Class table: OD ${od_mm}mm exceeds ${c.od_mm_max}mm` };
    }
    return { ok: true };
  };

  const eq = normData.notes?.test_equivalence || {
    "30min_dry": ["8dry_22wet", "30min_wet"],
    "8dry_22wet": ["30min_wet"]
  };

  let forceFireResistant = false;
  (normData.notes?.global_rules || []).forEach(rule => {
    const hitSystem = Array.isArray(rule.applies_if_system_in) && rule.applies_if_system_in.includes(system);
    if (!hitSystem) return;
    if (rule.force_fire_resistant_type === true) forceFireResistant = true;
  });

  const forbids = new Set();
  const appliedRefs = [];
  let requireFireResistant = null;
  let installFireTest = "not_required";

  (normData.notes?.space_rules || []).forEach(rule => {
    const hitSpace = Array.isArray(rule.applies_if_space_in) && rule.applies_if_space_in.includes(space);
    const hitSystem = !rule.applies_if_system_in || rule.applies_if_system_in.includes(system);
    if (!hitSpace || !hitSystem) return;

    (rule.forbid_joints || []).forEach(j => forbids.add(j));
    if (typeof rule.require_fire_resistant_type === "boolean") {
      requireFireResistant = (requireFireResistant === true) ? true : rule.require_fire_resistant_type;
    }
    if (rule.require_installation_fire_test === true) {
      installFireTest = unifyFireTest(installFireTest, typeFireTest || "not_required", eq);
    }
    if (rule.require_fire_test) {
      installFireTest = unifyFireTest(installFireTest, rule.require_fire_test, eq);
    }
    (rule.refs || []).forEach(r => appliedRefs.push(r));
  });

  const allJoints = Array.from(new Set([...Object.keys(normData.classes), ...baseAllowed]));
  for (const joint of allJoints) {
    const reasons = [];
    let status = "forbidden";

    if (!baseAllowed.has(joint)) {
      reasons.push("Service table: joint not permitted for system");
    } else if (forbids.has(joint)) {
      reasons.push("Space note: joint forbidden in selected space");
    } else {
      const ck = classOk(joint);
      if (!ck.ok) {
        reasons.push(ck.reason);
      } else {
        status = "allowed";
      }
    }

    if (status === "allowed") {
      const susceptible = JOINT_FIRE_SUSCEPTIBLE.has(joint);
      const needsFireResistant = susceptible && (forceFireResistant === true || requireFireResistant === true);
      const needsInstallTest = susceptible && (installFireTest && installFireTest !== "not_required");

      if (needsFireResistant || needsInstallTest) {
        status = "conditional";
        if (needsFireResistant) reasons.push("Requires fire-resistant type");
        if (needsInstallTest) reasons.push(`Requires fire test: ${installFireTest}`);
      }
    }

    out.push({
      joint,
      status,
      reasons,
      type_fire_test: typeFireTest,
      install_fire_test: installFireTest,
      fire_resistant_required: (requireFireResistant === true || forceFireResistant === true),
      note_nums: row.notes || [],
      applied_refs: Array.from(new Set(appliedRefs))
    });
  }

  const rank = { allowed: 0, conditional: 1, forbidden: 2 };
  return out.sort((a, b) => rank[a.status] - rank[b.status] || a.joint.localeCompare(b.joint));
}

/* =======================
   RENDER / UI
   ======================= */
function fillSelect(el, values, i18n, keyPrefix){
  el.innerHTML = "";
  for(const v of values){
    const o = document.createElement("option");
    o.value = v;
    o.textContent = text(i18n, `${keyPrefix}${v}`, v);
    el.appendChild(o);
  }
}

/* Selector de Sistemas/Líneas agrupado por grupo (optgroup) */
function refreshSystems(norms){
  const n = norms[normSel.value];
  const groups = {};
  for (const r of n.service) {
    const g = r.system_group || "Miscellaneous";
    (groups[g] ||= []).push(r.system);
  }
  const orderIndex = (g) => {
    const idx = GROUP_ORDER.findIndex(x => x === g);
    return idx === -1 ? Number.MAX_SAFE_INTEGER : idx;
  };
  const groupKeys = Object.keys(groups).sort((a,b)=>{
    const ai = orderIndex(a);
    const bi = orderIndex(b);
    if (ai !== bi) return ai - bi;
    const A = GROUP_LABELS_ES[a] || a;
    const B = GROUP_LABELS_ES[b] || b;
    return A.localeCompare(B, "es");
  });

  sysSel.innerHTML = "";
  for (const g of groupKeys) {
    const og = document.createElement("optgroup");
    og.label = GROUP_LABELS_ES[g] || g;
    const systems = [...new Set(groups[g])]
      .sort((a,b)=> text(I18N,"system."+a,a).localeCompare(text(I18N,"system."+b,b),"es"));
    for (const s of systems) {
      const o = document.createElement("option");
      o.value = s;
      o.textContent = text(I18N,"system."+s,s);
      og.appendChild(o);
    }
    sysSel.appendChild(og);
  }
}

/* Traducción rápida de “razones” a ES corto */
function tReason(s){
  if (s.startsWith("Service table")) return "La tabla de servicio no permite este tipo de unión para el sistema.";
  if (s.startsWith("Space note"))    return "Las notas del espacio seleccionado prohíben esta unión.";
  if (s.startsWith("Class table: not allowed")) return "La tabla por clase no permite esta unión en la clase seleccionada.";
  if (s.startsWith("Class table: OD"))          return s.replace("Class table:","Tabla por clase:").replace("exceeds","excede");
  if (s.startsWith("Requires fire test")) {
    const parts = s.split(":");
    const code = parts[1] ? parts[1].trim() : "not_required";
    return `Requiere ensayo de fuego: ${fmtFireTest(code)}`;
  }
  if (s.startsWith("Requires fire-resistant type")) return "Requiere tipo resistente al fuego.";
  return s;
}

function renderResults(list){
  const results = $("#results");
  results.innerHTML = "";
  if(!list.length){
    results.innerHTML = `<div class="notes">No hay resultados para la selección actual.</div>`;
    return;
  }
  for(const r of list){
    const title = text(I18N, `joint.${r.joint}`, r.joint);
    const pill =
      r.status==="allowed" ? '<span class="pill ok">Permitido</span>' :
      r.status==="conditional" ? '<span class="pill cond">Condicional</span>' :
      '<span class="pill bad">No permitido</span>';

    const btn = (r.status==="forbidden")
      ? `<button class="btn" disabled aria-disabled="true">VER</button>`
      : `<button class="btn" data-view="${r.joint}">VER</button>`;

    // Chips compactos
    const chips = [];
    chips.push(chip(`Clase ${clSel.value}`));
    chips.push(chip(`OD ${Number(odInp.value)} mm`));
    if (r.type_fire_test && r.type_fire_test!=="not_required") {
      chips.push(chip(`Ensayo (tipo): ${fmtFireTest(r.type_fire_test)}`));
    }
    if (r.fire_resistant_required) chips.push(chip("Tipo resistente al fuego"));
    if (r.install_fire_test && r.install_fire_test!=="not_required") {
      chips.push(chip(`Ensayo (instalación): ${fmtFireTest(r.install_fire_test)}`));
    }

    // Notas por número con tooltip
    if (Array.isArray(r.note_nums) && r.note_nums.length){
      const nn = r.note_nums.map(n => {
        const tip = (NOTE_SNIPPETS[normSel.value]?.[n]) || `Nota ${n}`;
        return `<span class="pill" title="${tip}">N${n}</span>`;
      }).join(" ");
      chips.push(nn);
    }

    // Refs aplicadas (p.ej., “2.12.8”)
    if (Array.isArray(r.applied_refs) && r.applied_refs.length){
      const rr = r.applied_refs.map(x=> `<span class="pill" title="${x}">${x}</span>`).join(" ");
      chips.push(rr);
    }

    // Razones (traducidas) — cortas
    const reasons = r.reasons?.length
      ? `<ul style="margin:8px 0 0 18px;font-size:13px">${r.reasons.map(x=>`<li>${tReason(x)}</li>`).join("")}</ul>`
      : "";

    const card = document.createElement("article");
    card.className = "card joint-card";
    card.innerHTML = `
      <header><h4>${title}</h4>${pill}</header>
      <div class="notes" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">${chips.join(" ")}</div>
      ${reasons}
      <div style="margin-top:10px">${btn}</div>
    `;
    results.appendChild(card);

    if(r.status!=="forbidden"){
      card.querySelector("button[data-view]")?.addEventListener("click", ()=>{
        const img = JOINT_IMAGE[r.joint] || "assets/joints/placeholder.png";
        openImage(title, img);
      });
    }
  }
}

/* =======================
   MODAL IMAGEN
   ======================= */
const modal = $("#imgModal"), imgEl = $("#imgView"), closeBtn = $("#imgClose");
function openImage(title, src){ imgEl.src=src; imgEl.alt=title; modal.classList.add("open"); modal.setAttribute("aria-hidden","false"); }
function closeImage(){ modal.classList.remove("open"); modal.setAttribute("aria-hidden","true"); imgEl.src=""; imgEl.alt=""; }
closeBtn.addEventListener("click", closeImage);
modal.addEventListener("click",(e)=>{ if(e.target===modal) closeImage(); });
window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeImage(); });

/* =======================
   BOOTSTRAP
   ======================= */
(async function main(){
  try{
    help.textContent = "Cargando datos…";
    const { norms } = await loadAll();

    // Normas
    const normIds = Object.keys(norms);
    fillSelect(normSel, normIds, I18N, "norm.");

    // Espacios (ES)
    fillSelect(spSel, SPACES, I18N, "space.");

    // Sistemas agrupados por grupo
    const doRefresh = ()=> refreshSystems(norms);
    normSel.addEventListener("change", doRefresh);
    doRefresh();

    help.textContent = "Listo. Completa los campos y pulsa Evaluar.";
    $("#btnEval").addEventListener("click", ()=>{
      const normId = normSel.value;
      const normData = norms[normId];
      const input = {
        normId,
        system: sysSel.value,
        space: spSel.value,
        od_mm: Number(odInp.value),
        piping_class: clSel.value
      };
      if(!input.od_mm || input.od_mm<=0){
        help.textContent = "Ingresa un OD (mm) válido.";
        return;
      }
      notesBox.textContent = (normId==="LR_SHIPS")
        ? "Secuencia: 12.2.8 → notas → 12.2.9; aplica equivalencias de ensayo."
        : "Secuencia: 1.5.3 → notas → 1.5.4; considerar tailoring Naval si aplica.";
      const res = evaluate(input, normData);
      renderResults(res);
    });

  }catch(err){
    console.error(err);
    help.textContent = "Error cargando datos. Revisa rutas / CORS.";
  }
})();
</script>
</body>
</html>
