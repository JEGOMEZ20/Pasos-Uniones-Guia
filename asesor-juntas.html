<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Asesor de Juntas · LR Ships / LR Naval</title>
<link rel="stylesheet" href="assets/css/app.css">
<style>
  :root { --ink:#e2e8f0; --mut:rgba(148,163,184,.76); --border:rgba(148,163,184,.18);
          --ok:#22c55e; --warn:#f59e0b; --bad:#f43f5e; --bg-card:rgba(15,23,42,.82); }
  body{margin:0;background:radial-gradient(circle at top,#1e293b 0%,#0f172a 55%,#020617 100%);
       color:var(--ink);font-family:Inter,system-ui,-apple-system,"Segoe UI","Helvetica Neue",sans-serif;}
  .wrap{max-width:1240px;margin:0 auto;padding:36px 20px 64px;}
  nav a{color:#38bdf8;text-decoration:none;font-weight:700}
  .grid{display:grid;grid-template-columns:minmax(0,420px) minmax(0,1fr);gap:22px;align-items:start}
  .card{background:var(--bg-card);border:1px solid var(--border);border-radius:22px;padding:22px;box-shadow:0 20px 45px rgba(2,6,23,.55)}
  label{display:block;font-size:12px;font-weight:800;letter-spacing:.05em;text-transform:uppercase;margin:0 0 6px}
  select,input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.35);background:rgba(15,23,42,.6);color:var(--ink)}
  .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .btn{display:inline-flex;gap:10px;align-items:center;background:#0ea5e9;border:0;border-radius:12px;color:#041628;font-weight:700;padding:10px 16px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:800;letter-spacing:.04em;text-transform:uppercase;border-radius:999px;padding:6px 12px;border:1px solid currentColor}
  .pill.ok{color:#4ade80;background:rgba(34,197,94,.12)}
  .pill.cond{color:#fcd34d;background:rgba(245,158,11,.12)}
  .pill.bad{color:#fb7185;background:rgba(244,63,94,.12)}
  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
  .joint-card header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .joint-card h4{margin:0;font-size:15px}
  .notes{font-size:12px;color:var(--mut);margin-top:10px}
  .lr-modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:99}
  .lr-modal.open{display:flex}
  .lr-modal .box{background:#0b1220;border-radius:14px;max-width:min(95vw,1024px);max-height:90vh;padding:10px;border:1px solid rgba(148,163,184,.25)}
  .lr-modal img{max-width:100%;height:auto;display:block}
  .lr-modal .close{position:absolute;top:12px;right:14px;background:#111;color:#fff;border:0;border-radius:8px;font-size:20px;padding:6px 10px;cursor:pointer}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <nav><a href="./index.html">← Volver al inicio</a></nav>
  <h1 style="margin:10px 0 16px">Asesor de juntas (LR)</h1>
  <div class="grid">
    <section class="card">
      <div class="row">
        <div>
          <label>Norma</label>
          <select id="norm"></select>
        </div>
        <div>
          <label>Sistema / Línea</label>
          <select id="system"></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label>Espacio / Compartimento</label>
          <select id="space"></select>
        </div>
        <div>
          <label>Clase de tubería</label>
          <select id="pclass">
            <option value="I">Clase I</option>
            <option value="II">Clase II</option>
            <option value="III">Clase III</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label>Diámetro exterior (mm)</label>
          <input id="od" type="number" step="0.1" min="1" placeholder="ej. 75">
        </div>
      </div>
      <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
        <button id="btnEval" class="btn">Evaluar</button>
        <small id="help" style="color:var(--mut)"></small>
      </div>
      <div class="notes" id="notesBox"></div>
    </section>

    <section class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <h2 style="margin:0">Resultado</h2>
        <div class="legend">
          <span class="pill ok">Permitido</span>
          <span class="pill cond">Condicional</span>
          <span class="pill bad">No permitido</span>
        </div>
      </div>
      <div id="results" class="cards" style="margin-top:10px"></div>
    </section>
  </div>
</div>

<!-- Modal de imagen -->
<div class="lr-modal" id="imgModal" aria-hidden="true">
  <button class="close" id="imgClose" aria-label="Cerrar">✕</button>
  <div class="box"><img id="imgView" alt=""></div>
</div>

<script type="module">
/* ========= Config & constants ========= */
const REGISTRY_URL = "./src/data/norms.registry.json"; // luego podrás apuntar a “la otra web”
const I18N_URL     = "./src/data/i18n.es.json";

const SPACES = [
  "machinery_category_A","machinery_other","accommodation","open_deck_low_fire_risk","pump_room",
  "cargo_hold","tank","weather_deck","protected_space","dry_space","water_tank","munition_store"
];

const JOINT_IMAGE = {
  "pipe_unions.welded_brazed": "assets/joints/pipe_welded_brazed.jpg",
  "compression.swage": "assets/joints/compression_swage.jpg",
  "compression.bite": "assets/joints/compression_bite.jpg",
  "compression.typical_compression": "assets/joints/compression_typical.jpg",
  "compression.flared": "assets/joints/compression_flared.jpg",
  "compression.press": "assets/joints/compression_press.jpg",
  "slip_on.machine_grooved": "assets/joints/slip_machine_grooved.jpg",
  "slip_on.grip": "assets/joints/slip_grip.jpg",
  "slip_on.slip": "assets/joints/slip_slip.jpg"
};

const NORM_LABEL = { "LR_SHIPS":"LR Buques (Ships)", "LR_NAVAL":"LR Naval" };

/* ========= Helpers ========= */
const $ = (q)=>document.querySelector(q);
const normSel = $("#norm"), sysSel = $("#system"), spSel = $("#space"), clSel = $("#pclass"), odInp = $("#od");
const results = $("#results"), help = $("#help"), notesBox = $("#notesBox");

async function j(url){ const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error(url); return r.json(); }
function text(i18n, key, fallback){ return i18n[key] ?? fallback ?? key; }

/* ========= Carga de datos ========= */
async function loadAll() {
  const i18n = await j(I18N_URL);
  const reg  = await j(REGISTRY_URL);

  const loadNorm = async (id) => {
    const meta = reg[id];
    const [service, classes, notes] = await Promise.all([j(meta.serviceUrl), j(meta.classUrl), j(meta.notesUrl)]);
    return { id, service, classes, notes };
  };
  const norms = {};
  for (const id of Object.keys(reg)) norms[id] = await loadNorm(id);
  return { i18n, norms };
}

/* ========= Lógica de evaluación (completa) ========= */
/**
 * input: { normId, system, space, od_mm, piping_class }
 * normData: { service:Array, classes:Object, notes:{space_rules:[],global_rules:[],test_equivalence:{}} }
 */
function evaluate(input, normData){
  const out = [];
  const { system, space, od_mm, piping_class } = input;

  // 1) fila de servicio
  const row = normData.service.find(r => (r.system||"").toLowerCase() === system.toLowerCase());
  if(!row){ return out; }

  // 2) base permitidos por servicio
  const baseAllowed = new Set(row.allowed_joints || []);

  // 3) restricciones de clase/OD
  const classOk = (joint) => {
    const c = normData.classes[joint]?.[piping_class];
    if(!c || !c.allowed) return { ok:false, reason:`Class table: not allowed in Class ${piping_class}` };
    if (typeof c.od_mm_max === "number" && od_mm > c.od_mm_max) {
      return { ok:false, reason:`Class table: OD ${od_mm}mm exceeds ${c.od_mm_max}mm` };
    }
    return { ok:true };
  };

  // 4) notas por espacio: prohibiciones + requisitos de fuego
  const forbids = new Set();
  let fire_resistant_required = false;
  let fire_test = row.fire_test ?? "not_required";
  const eq = normData.notes?.test_equivalence || { "30min_dry":["8dry_22wet","30min_wet"], "8dry_22wet":["30min_wet"] };

  (normData.notes?.space_rules||[]).forEach(rule=>{
    if(Array.isArray(rule.applies_if_space_in) && rule.applies_if_space_in.includes(space)){
      (rule.forbid_joints||[]).forEach(j => forbids.add(j));
      if(rule.require_fire_resistant_type) fire_resistant_required = true;
      if(rule.require_fire_test){
        fire_test = unifyFireTest(fire_test, rule.require_fire_test, eq);
      }
    }
  });

  // 5) construir resultados para todos los joints conocidos (union de base + clase)
  const allJoints = Array.from(new Set([...Object.keys(normData.classes), ...baseAllowed]));
  for(const joint of allJoints){
    const reasons = [];
    let status = "forbidden";

    if (!baseAllowed.has(joint)) {
      reasons.push("Service table: joint not permitted for system");
    } else if (forbids.has(joint)) {
      reasons.push("Space note: joint forbidden in selected space");
    } else {
      const ck = classOk(joint);
      if(!ck.ok){
        reasons.push(ck.reason);
      } else {
        status = "allowed";
      }
    }

    // condicional si exige tipo resistente al fuego o ensayo
    if (status === "allowed" && (fire_resistant_required || (fire_test && fire_test !== "not_required"))) {
      status = "conditional";
      if (fire_resistant_required) reasons.push("Requires fire-resistant type");
      if (fire_test && fire_test !== "not_required") reasons.push(`Requires fire test: ${fire_test}`);
    }

    out.push({ joint, status, reasons, fire_test, fire_resistant_required });
  }
  // Orden: allowed → conditional → forbidden
  const rank = { allowed:0, conditional:1, forbidden:2 };
  return out.sort((a,b)=> rank[a.status]-rank[b.status] || a.joint.localeCompare(b.joint));
}

function unifyFireTest(base, required, eq){
  if (base === required) return base;
  const supersets = eq[base] || [];
  return supersets.includes(required) ? base : required;
}

/* ========= Render ========= */
function fillSelect(el, values, i18n, keyPrefix){
  el.innerHTML = "";
  for(const v of values){
    const o = document.createElement("option");
    o.value = v;
    o.textContent = text(i18n, `${keyPrefix}${v}`, v);
    el.appendChild(o);
  }
}

function renderResults(i18n, list){
  results.innerHTML = "";
  if(!list.length){
    results.innerHTML = `<div class="notes">No hay resultados para la selección actual.</div>`;
    return;
  }
  for(const r of list){
    const title = text(i18n, `joint.${r.joint}`, r.joint);
    const pill =
      r.status==="allowed" ? '<span class="pill ok">Permitido</span>' :
      r.status==="conditional" ? '<span class="pill cond">Condicional</span>' :
      '<span class="pill bad">No permitido</span>';

    const btn = (r.status==="forbidden")
      ? `<button class="btn" disabled aria-disabled="true">VER</button>`
      : `<button class="btn" data-view="${r.joint}">VER</button>`;

    const reasons = r.reasons?.length
      ? `<ul style="margin:8px 0 0 18px;font-size:13px">${r.reasons.map(x=>`<li>${x}</li>`).join("")}</ul>`
      : "";

    const card = document.createElement("article");
    card.className = "card joint-card";
    card.innerHTML = `
      <header><h4>${title}</h4>${pill}</header>
      ${reasons}
      <div class="notes">${hintFire(i18n, r)}</div>
      <div style="margin-top:10px">${btn}</div>
    `;
    results.appendChild(card);

    if(r.status!=="forbidden"){
      card.querySelector("button[data-view]")?.addEventListener("click", ()=>{
        const img = JOINT_IMAGE[r.joint] || "assets/joints/not-found.jpg";
        openImage(title, img);
      });
    }
  }
}

function hintFire(i18n, r){
  const parts=[];
  if(r.fire_resistant_required) parts.push("• Tipo resistente al fuego");
  if(r.fire_test && r.fire_test!=="not_required") parts.push(`• Ensayo: ${r.fire_test}`);
  return parts.length ? parts.join("  ") : text(i18n,"labels.notes","Notas aplicables")+": —";
}

/* ========= Modal imagen ========= */
const modal = $("#imgModal"), imgEl = $("#imgView"), closeBtn = $("#imgClose");
function openImage(title, src){ imgEl.src=src; imgEl.alt=title; modal.classList.add("open"); modal.setAttribute("aria-hidden","false"); }
function closeImage(){ modal.classList.remove("open"); modal.setAttribute("aria-hidden","true"); imgEl.src=""; imgEl.alt=""; }
closeBtn.addEventListener("click", closeImage);
modal.addEventListener("click",(e)=>{ if(e.target===modal) closeImage(); });
window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeImage(); });

/* ========= Bootstrap ========= */
(async function main(){
  try{
    help.textContent = "Cargando datos…";
    const { i18n, norms } = await loadAll();

    // 1) Normas
    const normIds = Object.keys(norms);
    fillSelect(normSel, normIds, i18n, "norm.");

    // 2) Espacios (con etiquetas ES)
    fillSelect(spSel, SPACES, i18n, "space.");

    // 3) Sistemas dinámicos por norma
    const refreshSystems = ()=>{
      const n = norms[normSel.value];
      const systems = [...new Set(n.service.map(r=>r.system))];
      systems.sort((a,b)=> text(i18n,"system."+a,a).localeCompare(text(i18n,"system."+b,b),'es'));
      fillSelect(sysSel, systems, i18n, "system.");
    };

    normSel.addEventListener("change", refreshSystems);
    refreshSystems();

    help.textContent = "Listo. Completa los campos y pulsa Evaluar.";
    $("#btnEval").addEventListener("click", ()=>{
      const normId = normSel.value;
      const normData = norms[normId];
      const input = {
        normId,
        system: sysSel.value,
        space: spSel.value,
        od_mm: Number(odInp.value),
        piping_class: clSel.value
      };
      if(!input.od_mm || input.od_mm<=0){
        help.textContent = "Ingresa un OD (mm) válido.";
        return;
      }
      // nota contextual sencilla (opcional)
      notesBox.textContent = (normId==="LR_SHIPS")
        ? "Secuencia: 12.2.8 → notas → 12.2.9; aplica equivalencias de ensayo."
        : "Secuencia: 1.5.3 → notas → 1.5.4; considerar tailoring Naval si aplica.";
      const res = evaluate(input, normData);
      renderResults(i18n, res);
    });

  }catch(err){
    console.error(err);
    help.textContent = "Error cargando datos. Revisa rutas / CORS.";
  }
})();
</script>
</body>
</html>
